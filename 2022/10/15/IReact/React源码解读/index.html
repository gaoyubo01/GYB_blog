<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="theme-color" content="#3367D6"/>
  <link rel="apple-touch-icon" href="/icons-192.png">
  <link rel="manifest" href="/manifest.json">
  


  <meta name="generator" content="Hexo 6.3.0">

  

  

  
    <meta name="author" content="John Doe">
  

  

  

  <title>Reactæºç è§£è¯» | GYBçš„åšå®¢</title>

  

  
    <link rel="shortcut icon" href="https://img1.baidu.com/it/u=1088540074,3334562162&fm=253&fmt=auto&app=138&f=JPEG?w=237&h=221">
  

  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@1.1.3/index.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlightjs@9.16.2/styles/monokai.css">
  

  
<link rel="stylesheet" href="/GYB_blog/css/style.css">

</head>
<body>
  <div class="root-container">
    
<!-- header container -->
<header class="header-container post">
  
    <div class="post-image" style="background-image: url(https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fhbimg.b0.upaiyun.com%2F18ca0f890b340fe7501cce72b39c78f300d97818e86e6-7TKMvE_fw658&amp;refer=http%3A%2F%2Fhbimg.b0.upaiyun.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=auto?sec=1668429629&amp;t=fc9a379e222f523fd3fc45e0fb88cf18)"></div>
  

  <!-- navbar -->
<nav class="navbar">
  <div class="navbar-content">
    <!-- logo -->
    <div class="navbar-logo">
      <a href="/GYB_blog/">
        
          GYBçš„åšå®¢
        
      </a>
    </div>
    <!-- link -->
    <div class="navbar-link">
      <div class="navbar-btn">
        <div></div>
        <div></div>
        <div></div>
      </div>
      <ul class="navbar-list">
        
          <li class="navbar-list-item"><a href="/GYB_blog/">é¦–é¡µ</a></li>
        
          <li class="navbar-list-item"><a href="https://gaoyubo01.github.io/docs/">å‹é“¾</a></li>
        
          <li class="navbar-list-item"><a href="/GYB_blog/about">å…³äº</a></li>
        
      </ul>
    </div>
  </div>
</nav>

  
  

  
  

  
  

  
  

  
  
    <div class="header-content">
      <div class="post-text layout-block">
        <div class="layout-margin">
          <h1 class="title-wrap">Reactæºç è§£è¯»</h1>
          <h2 class="title-sub-wrap">
            <strong>John Doe</strong>
            <span>å‘å¸ƒäº</span>
            <time  class="article-date" datetime="2022-10-15T12:46:25.000Z" itemprop="datePublished">2022-10-15</time>
          </h2>
          <span id="busuanzi_container_page_pv"><br>
            æœ¬æ–‡æ€»é˜…è¯»é‡<span id="busuanzi_value_page_pv"></span>æ¬¡
          </span>
          <ul class="wrap-list dark">
  
    <li><a href="/GYB_blog/categories/web%E5%89%8D%E7%AB%AF/">ğŸ“’ webå‰ç«¯</a></li>
  
    <li><a href="/GYB_blog/categories/web%E5%89%8D%E7%AB%AF/react/">ğŸ“’ react</a></li>
  
</ul>
          <ul class="wrap-list dark">
  
    <li><a href="/GYB_blog/tags/web%E5%89%8D%E7%AB%AF/">ğŸ·ï¸ webå‰ç«¯</a></li>
  
    <li><a href="/GYB_blog/tags/react/">ğŸ·ï¸ react</a></li>
  
</ul>
        </div>
      </div>
    </div>
  

  
  
  
</header>

    <!-- æ–‡ç«  -->

<!-- æ–‡ç« å†…å®¹ -->
<div class="body-container">
  <article class="content-container layout-block post-container">
    <div class="article-info">
      
      
      
      
      <section class="article-entry markdown-body layout-margin content-padding--large soft-size--large soft-style--box">
        <div class="aplayer-box" data-url='https://qiniu.sukoshi.xyz/public/music/é¹¿ä¹ƒ - ã‚¢ã‚¤ãƒ­ãƒ‹.mp3' data-name='ã‚¢ã‚¤ãƒ­ãƒ‹' data-artist='é¹¿ä¹ƒ' data-cover='https://qiniu.sukoshi.xyz/public/music/é¹¿ä¹ƒ - ã‚¢ã‚¤ãƒ­ãƒ‹.jpg' data-lrc='https://qiniu.sukoshi.xyz/public/music/é¹¿ä¹ƒ - ã‚¢ã‚¤ãƒ­ãƒ‹.lrc' data-lrcType='3' ></div>
<h2 id="å››-Reactæºç è§£è¯»"><a href="#å››-Reactæºç è§£è¯»" class="headerlink" title="å››.Reactæºç è§£è¯»"></a>å››.Reactæºç è§£è¯»</h2><h2 id="1-é…ç½®-React-æºç æœ¬åœ°è°ƒè¯•ç¯å¢ƒ"><a href="#1-é…ç½®-React-æºç æœ¬åœ°è°ƒè¯•ç¯å¢ƒ" class="headerlink" title="1. é…ç½® React æºç æœ¬åœ°è°ƒè¯•ç¯å¢ƒ"></a>1. é…ç½® React æºç æœ¬åœ°è°ƒè¯•ç¯å¢ƒ</h2><ol>
<li><p>ä½¿ç”¨ create-react-app è„šæ‰‹æ¶åˆ›å»ºé¡¹ç›®</p>
<p><code>npx create-react-app react-test</code></p>
</li>
<li><p>å¼¹å°„ create-react-app è„šæ‰‹æ¶å†…éƒ¨é…ç½®</p>
<p><code>npm run eject</code></p>
</li>
<li><p>å…‹éš† react å®˜æ–¹æºç  (åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹è¿›è¡Œå…‹éš†)</p>
<p><code>git clone --branch v16.13.1 --depth=1 https://github.com/facebook/react.git src/react</code></p>
</li>
<li><p>é“¾æ¥æœ¬åœ°æºç </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–‡ä»¶ä½ç½®: react-test/config/webpack.config.js</span></span><br><span class="line"><span class="attr">resolve</span>: &#123;</span><br><span class="line">  <span class="attr">alias</span>: &#123;</span><br><span class="line">    <span class="string">&quot;react-native&quot;</span>: <span class="string">&quot;react-native-web&quot;</span>,</span><br><span class="line">    <span class="string">&quot;react&quot;</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;../src/react/packages/react&quot;</span>),</span><br><span class="line">    <span class="string">&quot;react-dom&quot;</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;../src/react/packages/react-dom&quot;</span>),</span><br><span class="line">    <span class="string">&quot;shared&quot;</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;../src/react/packages/shared&quot;</span>),</span><br><span class="line">    <span class="string">&quot;react-reconciler&quot;</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;../src/react/packages/react-reconciler&quot;</span>),</span><br><span class="line">    <span class="string">&quot;legacy-events&quot;</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;../src/react/packages/legacy-events&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¿®æ”¹ç¯å¢ƒå˜é‡</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–‡ä»¶ä½ç½®: react-test/config/env.js</span></span><br><span class="line"><span class="keyword">const</span> stringified = &#123;</span><br><span class="line">	<span class="string">&quot;process.env&quot;</span>: <span class="title class_">Object</span>.<span class="title function_">keys</span>(raw).<span class="title function_">reduce</span>(<span class="function">(<span class="params">env, key</span>) =&gt;</span> &#123;</span><br><span class="line">   	env[key] = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(raw[key])</span><br><span class="line">      <span class="keyword">return</span> env</span><br><span class="line">   &#125;, &#123;&#125;),</span><br><span class="line">   <span class="attr">__DEV__</span>: <span class="literal">true</span>,</span><br><span class="line">   <span class="title class_">SharedArrayBuffer</span>: <span class="literal">true</span>,</span><br><span class="line">   <span class="attr">spyOnDev</span>: <span class="literal">true</span>,</span><br><span class="line">   <span class="attr">spyOnDevAndProd</span>: <span class="literal">true</span>,</span><br><span class="line">   <span class="attr">spyOnProd</span>: <span class="literal">true</span>,</span><br><span class="line">   <span class="attr">__PROFILE__</span>: <span class="literal">true</span>,</span><br><span class="line">   <span class="attr">__UMD__</span>: <span class="literal">true</span>,</span><br><span class="line">   <span class="attr">__EXPERIMENTAL__</span>: <span class="literal">true</span>,</span><br><span class="line">   <span class="attr">__VARIANT__</span>: <span class="literal">true</span>,</span><br><span class="line">   <span class="attr">gate</span>: <span class="literal">true</span>,</span><br><span class="line">   <span class="attr">trustedTypes</span>: <span class="literal">true</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å‘Šè¯‰ babel åœ¨è½¬æ¢ä»£ç æ—¶å¿½ç•¥ç±»å‹æ£€æŸ¥</p>
<p><code>npm install @babel/plugin-transform-flow-strip-types -D</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–‡ä»¶ä½ç½®: react-test/config/webpack.config.js [babel-loader]</span></span><br><span class="line"><span class="attr">plugins</span>: [</span><br><span class="line">  <span class="built_in">require</span>.<span class="title function_">resolve</span>(<span class="string">&quot;@babel/plugin-transform-flow-strip-types&quot;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¯¼å‡º HostConfig</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–‡ä»¶ä½ç½®: /react/packages/react-reconciler/src/ReactFiberHostConfig.js</span></span><br><span class="line">+ <span class="keyword">export</span> * <span class="keyword">from</span> <span class="string">&#x27;./forks/ReactFiberHostConfig.dom&#x27;</span>;</span><br><span class="line">- <span class="title function_">invariant</span>(<span class="literal">false</span>, <span class="string">&#x27;This module must be shimmed by a specific renderer.&#x27;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¿®æ”¹ ReactSharedInternals.js æ–‡ä»¶</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–‡ä»¶ä½ç½®: /react/packages/shared/ReactSharedInternals.js</span></span><br><span class="line">- <span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line">- <span class="keyword">const</span> <span class="title class_">ReactSharedInternals</span> = <span class="title class_">React</span>.<span class="property">__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED</span>;</span><br><span class="line">+ <span class="keyword">import</span> <span class="title class_">ReactSharedInternals</span> <span class="keyword">from</span> <span class="string">&#x27;../react/src/ReactSharedInternals&#x27;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å…³é—­ eslint æ‰©å±•</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–‡ä»¶ä½ç½®: react/.eslingrc.js [module.exports]</span></span><br><span class="line"><span class="comment">// åˆ é™¤ extends</span></span><br><span class="line"><span class="attr">extends</span>: [</span><br><span class="line">  <span class="string">&#x27;fbjs&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;prettier&#x27;</span></span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>ç¦æ­¢ invariant æŠ¥é”™</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–‡ä»¶ä½ç½®: /react/packages/shared/invariant.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">invariant</span>(<span class="params">condition, format, a, b, c, d, e, f</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (condition) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">    <span class="string">&#x27;Internal React error: invariant() is meant to be replaced at compile &#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;time. There is no runtime version.&#x27;</span>,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>eslint é…ç½®</p>
<p>åœ¨ react æºç æ–‡ä»¶å¤¹ä¸­æ–°å»º .eslintrc.json å¹¶æ·»åŠ å¦‚ä¸‹é…ç½®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;extends&quot;: &quot;react-app&quot;,</span><br><span class="line">  &quot;globals&quot;: &#123;</span><br><span class="line">    &quot;SharedArrayBuffer&quot;: true,</span><br><span class="line">    &quot;spyOnDev&quot;: true,</span><br><span class="line">    &quot;spyOnDevAndProd&quot;: true,</span><br><span class="line">    &quot;spyOnProd&quot;: true,</span><br><span class="line">    &quot;__PROFILE__&quot;: true,</span><br><span class="line">    &quot;__UMD__&quot;: true,</span><br><span class="line">    &quot;__EXPERIMENTAL__&quot;: true,</span><br><span class="line">    &quot;__VARIANT__&quot;: true,</span><br><span class="line">    &quot;gate&quot;: true,</span><br><span class="line">    &quot;trustedTypes&quot;: true</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¿®æ”¹ react react-dom å¼•å…¥æ–¹å¼</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&quot;react&quot;</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">ReactDOM</span> <span class="keyword">from</span> <span class="string">&quot;react-dom&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>è§£å†³ vsCode ä¸­ flow æŠ¥é”™</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;javascript.validate.enable&quot;</span>: <span class="literal">false</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>å¯é€‰é¡¹é…ç½®</p>
<p>å¦‚æœä½ çš„ vscode ç¼–è¾‘å™¨å®‰è£…äº† prettier æ’ä»¶å¹¶ä¸”åœ¨ä¿å­˜ react æºç æ–‡ä»¶æ—¶å³ä¸‹è§’å‡ºç°å¦‚ä¸‹é”™è¯¯ï¼ŒæŒ‰ç…§å¦‚ä¸‹æ­¥éª¤è§£å†³</p>
</li>
</ol>

    <figure class="figure-image">
      <img src="https://gaoyubo01.github.io/docs/assets/img/1.1c6712d2.png" alt="å¸¦æè¿°å¸¦å›¾ç‰‡" loading="lazy" />
      <figcaption>å¸¦æè¿°å¸¦å›¾ç‰‡</figcaption>
    </figure>
  
<pre><code>1. å…¨å±€å®‰è£… prettier

   `npm i prettier -g`

2. é…ç½® prettier path

   Settings &gt; Extensions &gt; Prettier &gt; Prettier path
</code></pre>

    <figure class="figure-image">
      <img src="https://gaoyubo01.github.io/docs/assets/img/2.415cb267.png" alt="å¸¦æè¿°å¸¦å›¾ç‰‡" loading="lazy" />
      <figcaption>å¸¦æè¿°å¸¦å›¾ç‰‡</figcaption>
    </figure>
  
<ol start="15">
<li><p>__DEV__ æŠ¥é”™</p>
<p>åˆ é™¤ node_modules æ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œ npm install</p>
</li>
</ol>
<h2 id="2-åˆ›å»º-React-å…ƒç´ "><a href="#2-åˆ›å»º-React-å…ƒç´ " class="headerlink" title="2. åˆ›å»º React å…ƒç´ "></a>2. åˆ›å»º React å…ƒç´ </h2><p>JSX è¢« Babel ç¼–è¯‘ä¸º React.createElement æ–¹æ³•çš„è°ƒç”¨ï¼ŒcreateElement æ–¹æ³•åœ¨è°ƒç”¨åè¿”å›çš„å°±æ˜¯ ReactElementï¼Œå°±æ˜¯ virtualDOMã€‚</p>
<h3 id="2-1-createElement"><a href="#2-1-createElement" class="headerlink" title="2.1 createElement"></a>2.1 createElement</h3><p><code>æ–‡ä»¶ä½ç½®ï¼špackages/react/src/ReactElement.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * åˆ›å»º React Element</span><br><span class="line"> * type      å…ƒç´ ç±»å‹</span><br><span class="line"> * config    é…ç½®å±æ€§</span><br><span class="line"> * children  å­å…ƒç´ </span><br><span class="line"> * 1. åˆ†ç¦» props å±æ€§å’Œç‰¹æ®Šå±æ€§</span><br><span class="line"> * 2. å°†å­å…ƒç´ æŒ‚è½½åˆ° props.children ä¸­</span><br><span class="line"> * 3. ä¸º props å±æ€§èµ‹é»˜è®¤å€¼ (defaultProps)</span><br><span class="line"> * 4. åˆ›å»ºå¹¶è¿”å› ReactElement</span><br><span class="line"> */</span><br><span class="line">export function createElement(type, config, children) &#123;</span><br><span class="line">  /**</span><br><span class="line">   * propName -&gt; å±æ€§åç§°</span><br><span class="line">   * ç”¨äºåé¢çš„ for å¾ªç¯</span><br><span class="line">   */</span><br><span class="line">  let propName;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * å­˜å‚¨ React Element ä¸­çš„æ™®é€šå…ƒç´ å±æ€§ å³ä¸åŒ…å« key ref self source</span><br><span class="line">   */</span><br><span class="line">  const props = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * å¾…æå–å±æ€§</span><br><span class="line">   * React å†…éƒ¨ä¸ºäº†å®ç°æŸäº›åŠŸèƒ½è€Œå­˜åœ¨çš„å±æ€§</span><br><span class="line">   */</span><br><span class="line">  let key = null;</span><br><span class="line">  let ref = null;</span><br><span class="line">  let self = null;</span><br><span class="line">  let source = null;</span><br><span class="line"></span><br><span class="line">  // å¦‚æœ config ä¸ä¸º null</span><br><span class="line">  if (config != null) &#123;</span><br><span class="line">    // å¦‚æœ config å¯¹è±¡ä¸­æœ‰åˆæ³•çš„ ref å±æ€§</span><br><span class="line">    if (hasValidRef(config)) &#123;</span><br><span class="line">      // å°† config.ref å±æ€§æå–åˆ° ref å˜é‡ä¸­</span><br><span class="line">      ref = config.ref;</span><br><span class="line">      // åœ¨å¼€å‘ç¯å¢ƒä¸­</span><br><span class="line">      if (__DEV__) &#123;</span><br><span class="line">        // å¦‚æœ ref å±æ€§çš„å€¼è¢«è®¾ç½®æˆäº†å­—ç¬¦ä¸²å½¢å¼å°±æŠ¥ä¸€ä¸ªæç¤º</span><br><span class="line">        // è¯´æ˜æ­¤ç”¨æ³•åœ¨å°†æ¥çš„ç‰ˆæœ¬ä¸­ä¼šè¢«åˆ é™¤</span><br><span class="line">        warnIfStringRefCannotBeAutoConverted(config);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // å¦‚æœåœ¨ config å¯¹è±¡ä¸­æ‹¥æœ‰åˆæ³•çš„ key å±æ€§</span><br><span class="line">    if (hasValidKey(config)) &#123;</span><br><span class="line">      // å°† config.key å±æ€§ä¸­çš„å€¼æå–åˆ° key å˜é‡ä¸­</span><br><span class="line">      key = &#x27;&#x27; + config.key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    self = config.__self === undefined ? null : config.__self;</span><br><span class="line">    source = config.__source === undefined ? null : config.__source;</span><br><span class="line">    // éå† config å¯¹è±¡</span><br><span class="line">    for (propName in config) &#123;</span><br><span class="line">      // å¦‚æœå½“å‰éå†åˆ°çš„å±æ€§æ˜¯å¯¹è±¡è‡ªèº«å±æ€§</span><br><span class="line">      // å¹¶ä¸”åœ¨ RESERVED_PROPS å¯¹è±¡ä¸­ä¸å­˜åœ¨è¯¥å±æ€§</span><br><span class="line">      if (</span><br><span class="line">        hasOwnProperty.call(config, propName) &amp;&amp;</span><br><span class="line">        !RESERVED_PROPS.hasOwnProperty(propName)</span><br><span class="line">      ) &#123;</span><br><span class="line">        // å°†æ»¡è¶³æ¡ä»¶çš„å±æ€§æ·»åŠ åˆ° props å¯¹è±¡ä¸­ (æ™®é€šå±æ€§)</span><br><span class="line">        props[propName] = config[propName];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * å°†ç¬¬ä¸‰ä¸ªåŠä¹‹åçš„å‚æ•°æŒ‚è½½åˆ° props.children å±æ€§ä¸­</span><br><span class="line">   * å¦‚æœå­å…ƒç´ æ˜¯å¤šä¸ª props.children æ˜¯æ•°ç»„</span><br><span class="line">   * å¦‚æœå­å…ƒç´ æ˜¯ä¸€ä¸ª props.children æ˜¯å¯¹è±¡</span><br><span class="line">   */</span><br><span class="line"></span><br><span class="line">  // ç”±äºä»ç¬¬ä¸‰ä¸ªå‚æ•°å¼€å§‹åŠä»¥åéƒ½è¡¨ç¤ºå­å…ƒç´ </span><br><span class="line">  // æ‰€ä»¥å‡å»å‰ä¸¤ä¸ªå‚æ•°çš„ç»“æœå°±æ˜¯å­å…ƒç´ çš„æ•°é‡</span><br><span class="line">  const childrenLength = arguments.length - 2;</span><br><span class="line">  // å¦‚æœå­å…ƒç´ çš„æ•°é‡æ˜¯ 1</span><br><span class="line">  if (childrenLength === 1) &#123;</span><br><span class="line">    // ç›´æ¥å°†å­å…ƒç´ æŒ‚è½½åˆ°åˆ° props.children å±æ€§ä¸Š</span><br><span class="line">    // æ­¤æ—¶ children æ˜¯å¯¹è±¡ç±»å‹</span><br><span class="line">    props.children = children;</span><br><span class="line">    // å¦‚æœå­å…ƒç´ çš„æ•°é‡å¤§äº 1</span><br><span class="line">  &#125; else if (childrenLength &gt; 1) &#123;</span><br><span class="line">    // åˆ›å»ºæ•°ç»„, æ•°ç»„ä¸­å…ƒç´ çš„æ•°é‡ç­‰äºå­å…ƒç´ çš„æ•°é‡</span><br><span class="line">    const childArray = Array(childrenLength);</span><br><span class="line">    // å¼€å¯å¾ªç¯ å¾ªç¯æ¬¡åŒ¹é…å­å…ƒç´ çš„æ•°é‡</span><br><span class="line">    for (let i = 0; i &lt; childrenLength; i++) &#123;</span><br><span class="line">      // å°†å­å…ƒç´ æ·»åŠ åˆ° childArray æ•°ç»„ä¸­</span><br><span class="line">      // i + 2 çš„åŸå› æ˜¯å®å‚é›†åˆçš„å‰ä¸¤ä¸ªå‚æ•°ä¸æ˜¯å­å…ƒç´ </span><br><span class="line">      childArray[i] = arguments[i + 2];</span><br><span class="line">    &#125;</span><br><span class="line">    // å¦‚æœæ˜¯å¼€å‘ç¯å¢ƒ</span><br><span class="line">    if (__DEV__) &#123;</span><br><span class="line">      // å¦‚æœ Object å¯¹è±¡ä¸­å­˜åœ¨ freeze æ–¹æ³•</span><br><span class="line">      if (Object.freeze) &#123;</span><br><span class="line">        // è°ƒç”¨ freeze æ–¹æ³• å†»ç»“ childArray æ•°ç»„</span><br><span class="line">        // é˜²æ­¢ React æ ¸å¿ƒå¯¹è±¡è¢«ä¿®æ”¹ å†»ç»“å¯¹è±¡æé«˜æ€§èƒ½</span><br><span class="line">        Object.freeze(childArray);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // å°†å­å…ƒç´ æ•°ç»„æŒ‚è½½åˆ° props.children å±æ€§ä¸­</span><br><span class="line">    props.children = childArray;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * å¦‚æœå½“å‰å¤„ç†æ˜¯ç»„ä»¶</span><br><span class="line">   * çœ‹ç»„ä»¶èº«ä¸Šæ˜¯å¦æœ‰ defaultProps å±æ€§</span><br><span class="line">   * è¿™ä¸ªå±æ€§ä¸­å­˜å‚¨çš„æ˜¯ props å¯¹è±¡ä¸­å±æ€§çš„é»˜è®¤å€¼</span><br><span class="line">   * éå† defaultProps å¯¹è±¡ æŸ¥çœ‹å¯¹åº”çš„ props å±æ€§çš„å€¼æ˜¯å¦ä¸º undefined</span><br><span class="line">   * å¦‚æœä¸ºundefined å°±å°†é»˜è®¤å€¼èµ‹å€¼ç»™å¯¹åº”çš„ props å±æ€§å€¼</span><br><span class="line">   */</span><br><span class="line"></span><br><span class="line">  // å°† type å±æ€§å€¼è§†ä¸ºå‡½æ•° æŸ¥çœ‹å…¶ä¸­æ˜¯å¦å…·æœ‰ defaultProps å±æ€§</span><br><span class="line">  if (type &amp;&amp; type.defaultProps) &#123;</span><br><span class="line">    // å°† type å‡½æ•°ä¸‹çš„ defaultProps å±æ€§èµ‹å€¼ç»™ defaultProps å˜é‡</span><br><span class="line">    const defaultProps = type.defaultProps;</span><br><span class="line">    // éå† defaultProps å¯¹è±¡ä¸­çš„å±æ€§ å°†å±æ€§åç§°èµ‹å€¼ç»™ propName å˜é‡</span><br><span class="line">    for (propName in defaultProps) &#123;</span><br><span class="line">      // å¦‚æœ props å¯¹è±¡ä¸­çš„è¯¥å±æ€§çš„å€¼ä¸º undefined</span><br><span class="line">      if (props[propName] === undefined) &#123;</span><br><span class="line">        // å°† defaultProps å¯¹è±¡ä¸­çš„å¯¹åº”å±æ€§çš„å€¼èµ‹å€¼ç»™ props å¯¹è±¡ä¸­çš„å¯¹åº”å±æ€§çš„å€¼</span><br><span class="line">        props[propName] = defaultProps[propName];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * åœ¨å¼€å‘ç¯å¢ƒä¸­ å¦‚æœå…ƒç´ çš„ key å±æ€§ æˆ–è€… ref å±æ€§å­˜åœ¨</span><br><span class="line">   * ç›‘æµ‹å¼€å‘è€…æ˜¯å¦åœ¨ç»„ä»¶å†…éƒ¨é€šè¿‡ props å¯¹è±¡è·å–äº† key å±æ€§æˆ–è€… ref å±æ€§</span><br><span class="line">   * å¦‚æœè·å–äº† å°±æŠ¥é”™</span><br><span class="line">   */</span><br><span class="line"></span><br><span class="line">  // å¦‚æœå¤„äºå¼€å‘ç¯å¢ƒ</span><br><span class="line">  if (__DEV__) &#123;</span><br><span class="line">    // å…ƒç´ å…·æœ‰ key å±æ€§æˆ–è€… ref å±æ€§</span><br><span class="line">    if (key || ref) &#123;</span><br><span class="line">      // çœ‹ä¸€ä¸‹ type å±æ€§ä¸­å­˜å‚¨çš„æ˜¯å¦æ˜¯å‡½æ•° å¦‚æœæ˜¯å‡½æ•°å°±è¡¨ç¤ºå½“å‰å…ƒç´ æ˜¯ç»„ä»¶</span><br><span class="line">      // å¦‚æœå…ƒç´ ä¸æ˜¯ç»„ä»¶ å°±ç›´æ¥è¿”å›å…ƒç´ ç±»å‹å­—ç¬¦ä¸²</span><br><span class="line">      // displayName ç”¨äºåœ¨æŠ¥é”™è¿‡ç¨‹ä¸­æ˜¾ç¤ºæ˜¯å“ªä¸€ä¸ªç»„ä»¶æŠ¥é”™äº†</span><br><span class="line">      // å¦‚æœå¼€å‘è€…æ˜¾å¼å®šä¹‰äº† displayName å±æ€§ å°±æ˜¾ç¤ºå¼€å‘è€…å®šä¹‰çš„</span><br><span class="line">      // å¦è€…å°±æ˜¾ç¤ºç»„ä»¶åç§° å¦‚æœç»„ä»¶ä¹Ÿæ²¡æœ‰åç§° å°±æ˜¾ç¤º &#x27;Unknown&#x27;</span><br><span class="line">      const displayName =</span><br><span class="line">        typeof type === &#x27;function&#x27;</span><br><span class="line">          ? type.displayName || type.name || &#x27;Unknown&#x27;</span><br><span class="line">          : type;</span><br><span class="line">      // å¦‚æœ key å±æ€§å­˜åœ¨</span><br><span class="line">      if (key) &#123;</span><br><span class="line">        // ä¸º props å¯¹è±¡æ·»åŠ key å±æ€§</span><br><span class="line">        // å¹¶æŒ‡å®šå½“é€šè¿‡ props å¯¹è±¡è·å– key å±æ€§æ—¶æŠ¥é”™</span><br><span class="line">        defineKeyPropWarningGetter(props, displayName);</span><br><span class="line">      &#125;</span><br><span class="line">      // å¦‚æœ ref å±æ€§å­˜åœ¨</span><br><span class="line">      if (ref) &#123;</span><br><span class="line">        // ä¸º props å¯¹è±¡æ·»åŠ  ref å±æ€§</span><br><span class="line">        // å¹¶æŒ‡å®šå½“é€šè¿‡ props å¯¹è±¡è·å– ref å±æ€§æ—¶æŠ¥é”™</span><br><span class="line">        defineRefPropWarningGetter(props, displayName);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  // è¿”å› ReactElement</span><br><span class="line">  return ReactElement(</span><br><span class="line">    type,</span><br><span class="line">    key,</span><br><span class="line">    ref,</span><br><span class="line">    self,</span><br><span class="line">    source,</span><br><span class="line">    // åœ¨ Virtual DOM ä¸­ç”¨äºè¯†åˆ«è‡ªå®šä¹‰ç»„ä»¶</span><br><span class="line">    ReactCurrentOwner.current,</span><br><span class="line">    props,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-ReactElement"><a href="#2-2-ReactElement" class="headerlink" title="2.2 ReactElement"></a>2.2 ReactElement</h3><p><code>æ–‡ä»¶ä½ç½®ï¼špackages/react/src/ReactElement.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * æ¥æ”¶å‚æ•° è¿”å› ReactElement</span><br><span class="line"> */</span><br><span class="line">const ReactElement = function (type, key, ref, self, source, owner, props) &#123;</span><br><span class="line">  const element = &#123;</span><br><span class="line">    /**</span><br><span class="line">     * ç»„ä»¶çš„ç±»å‹, åå…­è¿›åˆ¶æ•°å€¼æˆ–è€… Symbol å€¼</span><br><span class="line">     * React åœ¨æœ€ç»ˆåœ¨æ¸²æŸ“ DOM çš„æ—¶å€™, éœ€è¦ç¡®ä¿å…ƒç´ çš„ç±»å‹æ˜¯ REACT_ELEMENT_TYPE</span><br><span class="line">     * éœ€è¦æ­¤å±æ€§ä½œä¸ºåˆ¤æ–­çš„ä¾æ®</span><br><span class="line">     */</span><br><span class="line">    $$typeof: REACT_ELEMENT_TYPE,</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * å…ƒç´ å…·ä½“çš„ç±»å‹å€¼ å¦‚æœæ˜¯å…ƒç´ èŠ‚ç‚¹ type å±æ€§ä¸­å­˜å‚¨çš„å°±æ˜¯ div span ç­‰ç­‰</span><br><span class="line">     * å¦‚æœå…ƒç´ æ˜¯ç»„ä»¶ type å±æ€§ä¸­å­˜å‚¨çš„å°±æ˜¯ç»„ä»¶çš„æ„é€ å‡½æ•°</span><br><span class="line">     */</span><br><span class="line">    type: type,</span><br><span class="line">    /**</span><br><span class="line">     * å…ƒç´ çš„å”¯ä¸€æ ‡è¯†</span><br><span class="line">     * ç”¨ä½œå†…éƒ¨ vdom æ¯”å¯¹ æå‡ DOM æ“ä½œæ€§èƒ½</span><br><span class="line">     */</span><br><span class="line">    key: key,</span><br><span class="line">    /**</span><br><span class="line">     * å­˜å‚¨å…ƒç´  DOM å¯¹è±¡æˆ–è€…ç»„ä»¶ å®ä¾‹å¯¹è±¡</span><br><span class="line">     */</span><br><span class="line">    ref: ref,</span><br><span class="line">    /**</span><br><span class="line">     * å­˜å‚¨å‘ç»„ä»¶å†…éƒ¨ä¼ é€’çš„æ•°æ®</span><br><span class="line">     */</span><br><span class="line">    props: props,</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * è®°å½•å½“å‰å…ƒç´ æ‰€å±ç»„ä»¶ (è®°å½•å½“å‰å…ƒç´ æ˜¯å“ªä¸ªç»„ä»¶åˆ›å»ºçš„)</span><br><span class="line">     */</span><br><span class="line">    _owner: owner,</span><br><span class="line">  &#125;;</span><br><span class="line">  // è¿”å› ReactElement</span><br><span class="line">  return element;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-hasValidRef"><a href="#2-3-hasValidRef" class="headerlink" title="2.3 hasValidRef"></a>2.3 hasValidRef</h3><p><code>æ–‡ä»¶ä½ç½®ï¼špackages/react/src/ReactElement.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * æŸ¥çœ‹å‚æ•°å¯¹è±¡ä¸­æ˜¯å¦æœ‰åˆæ³•çš„ ref å±æ€§</span><br><span class="line"> * è¿”å›å¸ƒå°”å€¼</span><br><span class="line"> */</span><br><span class="line">function hasValidRef(config) &#123;</span><br><span class="line">  return config.ref !== undefined;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-hasValidKey"><a href="#2-4-hasValidKey" class="headerlink" title="2.4 hasValidKey"></a>2.4 hasValidKey</h3><p><code>æ–‡ä»¶ä½ç½®ï¼špackages/react/src/ReactElement.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * æŸ¥çœ‹å‚æ•°å¯¹è±¡ä¸­æ˜¯å¦æœ‰åˆæ³•çš„ key å±æ€§</span><br><span class="line"> * è¿”å›å¸ƒå°”å€¼</span><br><span class="line"> */</span><br><span class="line">function hasValidKey(config) &#123;</span><br><span class="line">  return config.key !== undefined;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-isValidElement"><a href="#2-5-isValidElement" class="headerlink" title="2.5 isValidElement"></a>2.5 isValidElement</h3><p><code>æ–‡ä»¶ä½ç½®ï¼špackages/react/src/ReactElement.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * éªŒè¯ object å‚æ•°æ˜¯å¦æ˜¯ ReactElement. è¿”å›å¸ƒå°”å€¼</span><br><span class="line"> * éªŒè¯æˆåŠŸçš„æ¡ä»¶:</span><br><span class="line"> * object æ˜¯å¯¹è±¡</span><br><span class="line"> * object ä¸ä¸ºnull</span><br><span class="line"> * objectå¯¹è±¡ä¸­çš„ $$typeof å±æ€§å€¼ä¸º REACT_ELEMENT_TYPE</span><br><span class="line"> */</span><br><span class="line">export function isValidElement(object) &#123;</span><br><span class="line">  return (</span><br><span class="line">    typeof object === &#x27;object&#x27; &amp;&amp;</span><br><span class="line">    object !== null &amp;&amp;</span><br><span class="line">    object.$$typeof === REACT_ELEMENT_TYPE</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-6-defineKeyPropWarningGetter"><a href="#2-6-defineKeyPropWarningGetter" class="headerlink" title="2.6 defineKeyPropWarningGetter"></a>2.6 defineKeyPropWarningGetter</h3><p><code>æ–‡ä»¶ä½ç½®ï¼špackages/react/src/ReactElement.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> *  æŒ‡å®šå½“é€šè¿‡ props å¯¹è±¡è·å– key å±æ€§æ—¶æŠ¥é”™</span><br><span class="line"> *  props        ç»„ä»¶ä¸­çš„ props å¯¹è±¡</span><br><span class="line"> *  displayName  ç»„ä»¶åç§°æ ‡è¯†</span><br><span class="line"> */</span><br><span class="line">function defineKeyPropWarningGetter(props, displayName) &#123;</span><br><span class="line">  // é€šè¿‡ props å¯¹è±¡è·å– key å±æ€§æŠ¥é”™</span><br><span class="line">  const warnAboutAccessingKey = function () &#123;</span><br><span class="line">    // åœ¨å¼€å‘ç¯å¢ƒä¸­</span><br><span class="line">    if (__DEV__) &#123;</span><br><span class="line">      // specialPropKeyWarningShown æ§åˆ¶é”™è¯¯åªè¾“å‡ºä¸€æ¬¡çš„å˜é‡</span><br><span class="line">      if (!specialPropKeyWarningShown) &#123;</span><br><span class="line">        // é€šè¿‡ specialPropKeyWarningShown å˜é‡é”ä½åˆ¤æ–­æ¡ä»¶</span><br><span class="line">        specialPropKeyWarningShown = true;</span><br><span class="line">        // æŒ‡å®šæŠ¥é”™ä¿¡æ¯å’Œç»„ä»¶åç§°</span><br><span class="line">        console.error(</span><br><span class="line">          &#x27;%s: `key` is not a prop. Trying to access it will result &#x27; +</span><br><span class="line">            &#x27;in `undefined` being returned. If you need to access the same &#x27; +</span><br><span class="line">            &#x27;value within the child component, you should pass it as a different &#x27; +</span><br><span class="line">            &#x27;prop. (https://reactjs.org/link/special-props)&#x27;,</span><br><span class="line">          displayName,</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  warnAboutAccessingKey.isReactWarning = true;</span><br><span class="line">  // ä¸º props å¯¹è±¡æ·»åŠ  key å±æ€§</span><br><span class="line">  Object.defineProperty(props, &#x27;key&#x27;, &#123;</span><br><span class="line">    // å½“è·å– key å±æ€§æ—¶è°ƒç”¨ warnAboutAccessingKey æ–¹æ³•è¿›è¡ŒæŠ¥é”™</span><br><span class="line">    get: warnAboutAccessingKey,</span><br><span class="line">    configurable: true,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-7-defineRefPropWarningGetter"><a href="#2-7-defineRefPropWarningGetter" class="headerlink" title="2.7 defineRefPropWarningGetter"></a>2.7 defineRefPropWarningGetter</h3><p><code>æ–‡ä»¶ä½ç½®ï¼špackages/react/src/ReactElement.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> *  æŒ‡å®šå½“é€šè¿‡ props å¯¹è±¡è·å– ref å±æ€§æ—¶æŠ¥é”™</span><br><span class="line"> *  props        ç»„ä»¶ä¸­çš„ props å¯¹è±¡</span><br><span class="line"> *  displayName  ç»„ä»¶åç§°æ ‡è¯†</span><br><span class="line"> */</span><br><span class="line">function defineRefPropWarningGetter(props, displayName) &#123;</span><br><span class="line">  // é€šè¿‡ props å¯¹è±¡è·å– ref å±æ€§æŠ¥é”™</span><br><span class="line">  const warnAboutAccessingRef = function () &#123;</span><br><span class="line">    if (__DEV__) &#123;</span><br><span class="line">      // specialPropRefWarningShown æ§åˆ¶é”™è¯¯åªè¾“å‡ºä¸€æ¬¡çš„å˜é‡</span><br><span class="line">      if (!specialPropRefWarningShown) &#123;</span><br><span class="line">        // é€šè¿‡ specialPropRefWarningShown å˜é‡é”ä½åˆ¤æ–­æ¡ä»¶</span><br><span class="line">        specialPropRefWarningShown = true;</span><br><span class="line">        // æŒ‡å®šæŠ¥é”™ä¿¡æ¯å’Œç»„ä»¶åç§°</span><br><span class="line">        console.error(</span><br><span class="line">          &#x27;%s: `ref` is not a prop. Trying to access it will result &#x27; +</span><br><span class="line">            &#x27;in `undefined` being returned. If you need to access the same &#x27; +</span><br><span class="line">            &#x27;value within the child component, you should pass it as a different &#x27; +</span><br><span class="line">            &#x27;prop. (https://reactjs.org/link/special-props)&#x27;,</span><br><span class="line">          displayName,</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  warnAboutAccessingRef.isReactWarning = true;</span><br><span class="line">  // ä¸º props å¯¹è±¡æ·»åŠ  key å±æ€§</span><br><span class="line">  Object.defineProperty(props, &#x27;ref&#x27;, &#123;</span><br><span class="line">    get: warnAboutAccessingRef,</span><br><span class="line">    configurable: true,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-React-æ¶æ„"><a href="#3-React-æ¶æ„" class="headerlink" title="3. React æ¶æ„"></a>3. React æ¶æ„</h2><p>React 16 ç‰ˆæœ¬çš„æ¶æ„å¯ä»¥åˆ†ä¸ºä¸‰å±‚ï¼šè°ƒåº¦å±‚ã€åè°ƒå±‚ã€æ¸²æŸ“å±‚ã€‚</p>
<ul>
<li>Scheduler (è°ƒåº¦å±‚)ï¼šè°ƒåº¦ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼Œé«˜ä¼˜ä»»åŠ¡ä¼˜å…ˆè¿›å…¥åè°ƒå™¨</li>
<li>Reconciler (åè°ƒå±‚)ï¼šæ„å»º Fiber æ•°æ®ç»“æ„ï¼Œæ¯”å¯¹ Fiber å¯¹è±¡æ‰¾å‡ºå·®å¼‚, è®°å½• Fiber å¯¹è±¡è¦è¿›è¡Œçš„ DOM æ“ä½œ</li>
<li>Renderer (æ¸²æŸ“å±‚)ï¼šè´Ÿè´£å°†å‘ç”Ÿå˜åŒ–çš„éƒ¨åˆ†æ¸²æŸ“åˆ°é¡µé¢ä¸Š</li>
</ul>
<h3 id="3-1-Scheduler-è°ƒåº¦å±‚"><a href="#3-1-Scheduler-è°ƒåº¦å±‚" class="headerlink" title="3.1 Scheduler è°ƒåº¦å±‚"></a>3.1 Scheduler è°ƒåº¦å±‚</h3><p>åœ¨ React 15 çš„ç‰ˆæœ¬ä¸­ï¼Œé‡‡ç”¨äº†å¾ªç¯åŠ é€’å½’çš„æ–¹å¼è¿›è¡Œäº† virtualDOM çš„æ¯”å¯¹ï¼Œç”±äºé€’å½’ä½¿ç”¨ JavaScript è‡ªèº«çš„æ‰§è¡Œæ ˆï¼Œä¸€æ—¦å¼€å§‹å°±æ— æ³•åœæ­¢ï¼Œç›´åˆ°ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚å¦‚æœ VirtualDOM æ ‘çš„å±‚çº§æ¯”è¾ƒæ·±ï¼ŒvirtualDOM çš„æ¯”å¯¹å°±ä¼šé•¿æœŸå ç”¨ JavaScript ä¸»çº¿ç¨‹ï¼Œç”±äº JavaScript åˆæ˜¯å•çº¿ç¨‹çš„æ— æ³•åŒæ—¶æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œæ‰€ä»¥åœ¨æ¯”å¯¹çš„è¿‡ç¨‹ä¸­æ— æ³•å“åº”ç”¨æˆ·æ“ä½œï¼Œæ— æ³•å³æ—¶æ‰§è¡Œå…ƒç´ åŠ¨ç”»ï¼Œé€ æˆäº†é¡µé¢å¡é¡¿çš„ç°è±¡ã€‚</p>
<p>åœ¨ React 16 çš„ç‰ˆæœ¬ä¸­ï¼Œæ”¾å¼ƒäº† JavaScript é€’å½’çš„æ–¹å¼è¿›è¡Œ virtualDOM çš„æ¯”å¯¹ï¼Œè€Œæ˜¯é‡‡ç”¨å¾ªç¯æ¨¡æ‹Ÿé€’å½’ã€‚è€Œä¸”æ¯”å¯¹çš„è¿‡ç¨‹æ˜¯åˆ©ç”¨æµè§ˆå™¨çš„ç©ºé—²æ—¶é—´å®Œæˆçš„ï¼Œä¸ä¼šé•¿æœŸå ç”¨ä¸»çº¿ç¨‹ï¼Œè¿™å°±è§£å†³äº† virtualDOM æ¯”å¯¹é€ æˆé¡µé¢å¡é¡¿çš„é—®é¢˜ã€‚</p>
<p>åœ¨ window å¯¹è±¡ä¸­æä¾›äº† requestIdleCallback APIï¼Œå®ƒå¯ä»¥åˆ©ç”¨æµè§ˆå™¨çš„ç©ºé—²æ—¶é—´æ‰§è¡Œä»»åŠ¡ï¼Œä½†æ˜¯å®ƒè‡ªèº«ä¹Ÿå­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚è¯´å¹¶ä¸æ˜¯æ‰€æœ‰çš„æµè§ˆå™¨éƒ½æ”¯æŒå®ƒï¼Œè€Œä¸”å®ƒçš„è§¦å‘é¢‘ç‡ä¹Ÿä¸æ˜¯å¾ˆç¨³å®šï¼Œæ‰€ä»¥ React æœ€ç»ˆæ”¾å¼ƒäº† requestIdleCallback çš„ä½¿ç”¨ã€‚</p>
<p>åœ¨ React ä¸­ï¼Œå®˜æ–¹å®ç°äº†è‡ªå·±çš„ä»»åŠ¡è°ƒåº¦åº“ï¼Œè¿™ä¸ªåº“å°±å«åš Schedulerã€‚å®ƒä¹Ÿå¯ä»¥å®ç°åœ¨æµè§ˆå™¨ç©ºé—²æ—¶æ‰§è¡Œä»»åŠ¡ï¼Œè€Œä¸”è¿˜å¯ä»¥è®¾ç½®ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼Œé«˜ä¼˜å…ˆçº§ä»»åŠ¡å…ˆæ‰§è¡Œï¼Œä½ä¼˜å…ˆçº§ä»»åŠ¡åæ‰§è¡Œã€‚</p>
<p>Scheduler å­˜å‚¨åœ¨ <code>packages/scheduler</code> æ–‡ä»¶å¤¹ä¸­ã€‚</p>
<h3 id="3-2-Reconciler-åè°ƒå±‚"><a href="#3-2-Reconciler-åè°ƒå±‚" class="headerlink" title="3.2 Reconciler åè°ƒå±‚"></a>3.2 Reconciler åè°ƒå±‚</h3><p>åœ¨ React 15 çš„ç‰ˆæœ¬ä¸­ï¼Œåè°ƒå™¨å’Œæ¸²æŸ“å™¨äº¤æ›¿æ‰§è¡Œï¼Œå³æ‰¾åˆ°äº†å·®å¼‚å°±ç›´æ¥æ›´æ–°å·®å¼‚ã€‚åœ¨ React 16 çš„ç‰ˆæœ¬ä¸­ï¼Œè¿™ç§æƒ…å†µå‘ç”Ÿäº†å˜åŒ–ï¼Œåè°ƒå™¨å’Œæ¸²æŸ“å™¨ä¸å†äº¤æ›¿æ‰§è¡Œã€‚åè°ƒå™¨è´Ÿè´£æ‰¾å‡ºå·®å¼‚ï¼Œåœ¨æ‰€æœ‰å·®å¼‚æ‰¾å‡ºä¹‹åï¼Œç»Ÿä¸€äº¤ç»™æ¸²æŸ“å™¨è¿›è¡Œ DOM çš„æ›´æ–°ã€‚ä¹Ÿå°±æ˜¯è¯´åè°ƒå™¨çš„ä¸»è¦ä»»åŠ¡å°±æ˜¯æ‰¾å‡ºå·®å¼‚éƒ¨åˆ†ï¼Œå¹¶ä¸ºå·®å¼‚æ‰“ä¸Šæ ‡è®°ã€‚</p>
<h3 id="3-3-Renderer-æ¸²æŸ“å±‚"><a href="#3-3-Renderer-æ¸²æŸ“å±‚" class="headerlink" title="3.3 Renderer æ¸²æŸ“å±‚"></a>3.3 Renderer æ¸²æŸ“å±‚</h3><p>æ¸²æŸ“å™¨æ ¹æ®åè°ƒå™¨ä¸º Fiber èŠ‚ç‚¹æ‰“çš„æ ‡è®°ï¼ŒåŒæ­¥æ‰§è¡Œå¯¹åº”çš„DOMæ“ä½œã€‚</p>
<p>æ—¢ç„¶æ¯”å¯¹çš„è¿‡ç¨‹ä»é€’å½’å˜æˆäº†å¯ä»¥ä¸­æ–­çš„å¾ªç¯ï¼Œé‚£ä¹ˆ React æ˜¯å¦‚ä½•è§£å†³ä¸­æ–­æ›´æ–°æ—¶ DOM æ¸²æŸ“ä¸å®Œå…¨çš„é—®é¢˜å‘¢ï¼Ÿ</p>
<p>å…¶å®æ ¹æœ¬å°±ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºåœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œè°ƒåº¦å™¨å’Œåè°ƒå™¨çš„å·¥ä½œæ˜¯åœ¨å†…å­˜ä¸­å®Œæˆçš„æ˜¯å¯ä»¥è¢«æ‰“æ–­çš„ï¼Œæ¸²æŸ“å™¨çš„å·¥ä½œè¢«è®¾å®šæˆä¸å¯ä»¥è¢«æ‰“æ–­ï¼Œæ‰€ä»¥ä¸å­˜åœ¨DOM æ¸²æŸ“ä¸å®Œå…¨çš„é—®é¢˜ã€‚</p>
<h2 id="4-æ•°æ®ç»“æ„"><a href="#4-æ•°æ®ç»“æ„" class="headerlink" title="4. æ•°æ®ç»“æ„"></a>4. æ•°æ®ç»“æ„</h2><h3 id="4-1-Fiber"><a href="#4-1-Fiber" class="headerlink" title="4.1 Fiber"></a>4.1 Fiber</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">type Fiber = &#123;</span><br><span class="line">  /************************  DOM å®ä¾‹ç›¸å…³  *****************************/</span><br><span class="line">  </span><br><span class="line">  // æ ‡è®°ä¸åŒçš„ç»„ä»¶ç±»å‹, å€¼è¯¦è§ WorkTag</span><br><span class="line">  tag: WorkTag,</span><br><span class="line"></span><br><span class="line">  // ç»„ä»¶ç±»å‹ divã€spanã€ç»„ä»¶æ„é€ å‡½æ•°</span><br><span class="line">  type: any,</span><br><span class="line"></span><br><span class="line">  // å®ä¾‹å¯¹è±¡, å¦‚ç±»ç»„ä»¶çš„å®ä¾‹ã€åŸç”Ÿ dom å®ä¾‹, è€Œ function ç»„ä»¶æ²¡æœ‰å®ä¾‹, å› æ­¤è¯¥å±æ€§æ˜¯ç©º</span><br><span class="line">  stateNode: any,</span><br><span class="line"> </span><br><span class="line">	/************************  æ„å»º Fiber æ ‘ç›¸å…³  ***************************/</span><br><span class="line">  </span><br><span class="line">  // æŒ‡å‘è‡ªå·±çš„çˆ¶çº§ Fiber å¯¹è±¡</span><br><span class="line">  return: Fiber | null,</span><br><span class="line"></span><br><span class="line">  // æŒ‡å‘è‡ªå·±çš„ç¬¬ä¸€ä¸ªå­çº§ Fiber å¯¹è±¡</span><br><span class="line">  child: Fiber | null,</span><br><span class="line">  </span><br><span class="line">  // æŒ‡å‘è‡ªå·±çš„ä¸‹ä¸€ä¸ªå…„å¼Ÿ iber å¯¹è±¡</span><br><span class="line">  sibling: Fiber | null,</span><br><span class="line">  </span><br><span class="line">  // åœ¨ Fiber æ ‘æ›´æ–°çš„è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ª Fiber éƒ½ä¼šæœ‰ä¸€ä¸ªè·Ÿå…¶å¯¹åº”çš„ Fiber</span><br><span class="line">  // æˆ‘ä»¬ç§°ä»–ä¸º current &lt;==&gt; workInProgress</span><br><span class="line">  // åœ¨æ¸²æŸ“å®Œæˆä¹‹åä»–ä»¬ä¼šäº¤æ¢ä½ç½®</span><br><span class="line">  // alternate æŒ‡å‘å½“å‰ Fiber åœ¨ workInProgress æ ‘ä¸­çš„å¯¹åº” Fiber</span><br><span class="line">	alternate: Fiber | null,</span><br><span class="line">		</span><br><span class="line">  /************************  çŠ¶æ€æ•°æ®ç›¸å…³  ********************************/</span><br><span class="line">  </span><br><span class="line">  // å³å°†æ›´æ–°çš„ props</span><br><span class="line">  pendingProps: any, </span><br><span class="line">  // æ—§çš„ props</span><br><span class="line">  memoizedProps: any,</span><br><span class="line">  // æ—§çš„ state</span><br><span class="line">  memoizedState: any,</span><br><span class="line">		</span><br><span class="line">  /************************  å‰¯ä½œç”¨ç›¸å…³ ******************************/</span><br><span class="line"></span><br><span class="line">  // è¯¥ Fiber å¯¹åº”çš„ç»„ä»¶äº§ç”Ÿçš„çŠ¶æ€æ›´æ–°ä¼šå­˜æ”¾åœ¨è¿™ä¸ªé˜Ÿåˆ—é‡Œé¢ </span><br><span class="line">  updateQueue: UpdateQueue&lt;any&gt; | null,</span><br><span class="line">  </span><br><span class="line">  // ç”¨æ¥è®°å½•å½“å‰ Fiber è¦æ‰§è¡Œçš„ DOM æ“ä½œ</span><br><span class="line">  effectTag: SideEffectTag,</span><br><span class="line"></span><br><span class="line">  // å­˜å‚¨ç¬¬ä¸€ä¸ªè¦æ‰§è¡Œå‰¯ä½œç”¨çš„å­çº§ Fiber å¯¹è±¡</span><br><span class="line">  firstEffect: Fiber | null,</span><br><span class="line">  </span><br><span class="line">  // å­˜å‚¨ä¸‹ä¸€ä¸ªè¦æ‰§è¡Œå‰¯ä½œç”¨çš„å­çº§ Fiber å¯¹è±¡</span><br><span class="line">  // æ‰§è¡Œ DOM æ¸²æŸ“æ—¶è¦å…ˆé€šè¿‡ first æ‰¾åˆ°ç¬¬ä¸€ä¸ª, ç„¶åé€šè¿‡ next ä¸€ç›´å‘åæŸ¥æ‰¾</span><br><span class="line">  nextEffect: Fiber | null,</span><br><span class="line">  </span><br><span class="line">  // å­˜å‚¨ DOM æ“ä½œå®Œåçš„å‰¯ä½œç”¨ æ¯”å¦‚è°ƒç”¨ç”Ÿå‘½å‘¨æœŸå‡½æ•°æˆ–è€…é’©å­å‡½æ•°çš„è°ƒç”¨</span><br><span class="line">  lastEffect: Fiber | null,</span><br><span class="line"></span><br><span class="line">  // ä»»åŠ¡çš„è¿‡æœŸæ—¶é—´</span><br><span class="line">  expirationTime: ExpirationTime,</span><br><span class="line">  </span><br><span class="line">	// å½“å‰ç»„ä»¶åŠå­ç»„ä»¶å¤„äºä½•ç§æ¸²æŸ“æ¨¡å¼ è¯¦è§ TypeOfMode</span><br><span class="line">  mode: TypeOfMode,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


    <figure class="figure-image">
      <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAsgAAABnCAIAAACSHCMzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAFGmlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNi4wLWMwMDIgNzkuMTY0NDYwLCAyMDIwLzA1LzEyLTE2OjA0OjE3ICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RFdnQ9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZUV2ZW50IyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgMjEuMiAoTWFjaW50b3NoKSIgeG1wOkNyZWF0ZURhdGU9IjIwMjAtMTAtMjNUMjA6Mjc6NTQrMDg6MDAiIHhtcDpNb2RpZnlEYXRlPSIyMDIwLTEwLTIzVDIwOjM2OjM4KzA4OjAwIiB4bXA6TWV0YWRhdGFEYXRlPSIyMDIwLTEwLTIzVDIwOjM2OjM4KzA4OjAwIiBkYzpmb3JtYXQ9ImltYWdlL3BuZyIgcGhvdG9zaG9wOkNvbG9yTW9kZT0iMyIgcGhvdG9zaG9wOklDQ1Byb2ZpbGU9InNSR0IgSUVDNjE5NjYtMi4xIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOmVlN2E4YTYwLWQ4ZjctNDI0MC05MzJjLWMxZDYxODUyMGFmOCIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDplZTdhOGE2MC1kOGY3LTQyNDAtOTMyYy1jMWQ2MTg1MjBhZjgiIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDplZTdhOGE2MC1kOGY3LTQyNDAtOTMyYy1jMWQ2MTg1MjBhZjgiPiA8eG1wTU06SGlzdG9yeT4gPHJkZjpTZXE+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJjcmVhdGVkIiBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOmVlN2E4YTYwLWQ4ZjctNDI0MC05MzJjLWMxZDYxODUyMGFmOCIgc3RFdnQ6d2hlbj0iMjAyMC0xMC0yM1QyMDoyNzo1NCswODowMCIgc3RFdnQ6c29mdHdhcmVBZ2VudD0iQWRvYmUgUGhvdG9zaG9wIDIxLjIgKE1hY2ludG9zaCkiLz4gPC9yZGY6U2VxPiA8L3htcE1NOkhpc3Rvcnk+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+AZEM4QAACnBJREFUeJzt3TFs28odx/Hza4A3PCDzG4IgENmtawM0sFzAg2V07iBv7hJAfmMDawneUHiR9ljAmzxFKpDOjTIYaCwERbZ2FoUgDYIsXR5aFK9Fyw5/5HC+Ixm5/VNUjt/PFJGUfOafd/yZRyo7eZ4bAAAADV803QAAABAPggUAAFBDsAAAAGoIFgAAQA3BAgAAqCFYAAAANQQLAACgpr3BYuejxWKxyZ+7Wq3sj16tVsaYxWJhl2yyJajDbDaTUqZpKkvG47EsOTw8bLZt+P9540bYnfH5CrvqycmJLDk5OWm2bZ+ZvJV6vV6v17MvB4OBMebq6krrw8P9nGWZrE2SZDAYuNsbY0ajkcqPxgaExU2SRFZlWWaMmU6nduOrqyvFQwt1k6HAY8vnjRt5UXfG1pLu6bEFDbvqdDp1h26sr41XLFar1Xw+39/fr+nzl8ulPdNYnU7HGLNYLLIs29vbsxvPZjNjzIMHD2pqDHTJX6XeuWS5XMraZ8+eGWPu379vt3/69KkxZnd3t4nG4sakvl7nlfKF40bYnbHN3r9/b4K/4p4/fy5rw656cXGRJIkM3biRNgaL0Pn5uR0+bkSue294MqWQXMTjYqyu7dmrckm26VZERWYxxuNx0w3ZomEkJoeHh3Y6sllpmrZtGrSNwUJyayPevXvnLXn79m0jLUEd3rx54y3ZhlACFeG4EXZnfL7CrmqvROLGaphe2WreDRAywTYajYwzl2aMGY1GstAuty/Nx3k4b0/a6Y8kScKpEFnubh/O5tprdG4jw9sv3M+ZTqfhxKE3DdwGMvnt7opwvxXuVZlGdTeW8pXtVVkeTquH24f1tdO3hQsLPyfLMpn69T5Zd+9tOTvVbSsY9i/ZJlzrvZRefHV1Fd4IJd1clodtCMeNsDvLlm7dw0qFB6HXjMKhI25yn4p7nLt3KYnCLiPVdDeW0rgHg7ur5UeEI0NhFys8PMLuWfE5+fWzRtmvFqXWBYu86PAKg4W5fnp2N8iyzHZ+OYK9c0NZsLDbu8eWHekK3x6extyGydrCX6Ft7HgtL8P9XLFX5b1ufPRGLnevlgULIeORu713ovLe7rXTOzKn06mttXzyzXdMDOx5wu6owu7p3mLpHQmyS72dLy+900xZsMiLxo3wMPPe7rXTGxnsoVI4jLSHRDS7Z7xqVncZea/82+t9Ev7cH1QWLOz2Xum9enlv99rpNWw0Gtk2J0nStj/22jhUrRks3LcMBoPCrFAWLLyU6v19XBEswjOZu6QiPRAswkHBdubqvSojl73g4YaGsmDhseX7ZLAIBzt3SbjWIliEvcYtn9udvSU2OBaGvMJg4bLHwyeDRTgauEsq0gPBwjvsvdxf0WWkKPaCh1udsmDhcYNIdbAI84G7pCI9tDBYtPEei3V4l8L29vayLFv/ViDvgD49PV3zjZeXl959yHfv3jUf53fDtbDCPGdV79VOpzMajebzuYwj5+fnn/xZ3hWL9W/7nc/nBwcH7pJOp2PDSrgW1p07dwqXv3792lx/rkoKbe93kYImSTKfzwtPLSG3uOscD+Lly5fm+mMF0ma5FSNcC6tiaK3uMru7u4PBYDKZdLvdXq+3zkjrRck1h9PVapVlmfcsYZqmch9G4do2I1ispd/vy90MG/hOLftTxNHRkV21XC635D7nz4J771XFXjXGnJ6eSi55+PBh3a2aTCZuSyaTiSyXe8fu3btXdwOi4d5N2e123b3qbibB0RiTJMkGzutuM7rdrl2+Wq0qsi887q2UZV1G2OR3fHxcd6uGw6Hbkvl8LsvlUJQ/V2AIFuvr9/uScI0x3W63vrv9Cy+G2wGRG5X/N9V7dTwey60zw+Gw7uc4Cu/PsGvD50qwjnAewZ5vVqvVcDiUG3I38HBpWNx+vy+rCufR8EnVXUa+EzNJEu+vhTqE92e4AzKP+FkEixuTCdGanlnd39/Psqzs3HZwcFCxFmWq9+pisRgOh6PR6MWLF+bjOFWTXq8nPyXU6XSSJClbizLydWSvXr0q2+Dg4CBJkuVy2ev1ag2O8k1ZZZcz5To5X1ZxUxVdxhgzm80mk8l0Or24uDB1dl7pnpeXl4Vr5U+UsrUtRLBYi/stSe5cqcyhVgxqNyVzhO6c4mKxsNMfjx49Mtc7j73qK1fhZL4Znuq9enx8nCTJ6empvdlCvg7V1LBXHz9+nGWZW8HxeGxfnp2duX9VLxYL+706MkXCaSnU6XQGg8FwOHR3Tpqm8lKuRclZR65h2L0tk+uKJ4N+v58kiTf9YXuoHITu5fo0TWVUUR9GYlLdZY6Ojnq9Xr/ftzdb2MNAbsVQzJFnZ2fz+dy96HVycmJfekPHbDazjUzT1E6atEV4iSl66zwV4l188+75Cp8vMM5zZYX/V4h7Z3j146b59edKvGv43tVU9432htO2fc9BXnQHeHireeFeLXzc1+0X4V6t6EeffCokDyroFct7BN/7HWVh2/5nmfChibBq3hcGyKqyx3y853vDCnpk+3UeN82D7u/9LuHHeu1v2+MDedFDE95+KOsyYXcz1wdM2+VlVxdORbnPZJnKp0Ly4ETg9UT3IAyfc3GPzOjt5CUDJQAAwE0xFQIAANQQLAAAgBqCBQAAUEOwAAAAaggWAABADcECAACoIVgAAAA1BAsAAKCGYAEAANQQLAAAgBqCBQAAUEOwAAAAaggWAABADcECAACoIVgAAAA1BAsAAKCGYAEAANQQLAAAgBqCBQAAUEOwAAAAaggWAABADcECAACoIVgAAAA1t9wX33/zdVPt0HX7yYemm7CNqG/EKG7cqG/E4isuVywAAIAaggUAAFBDsAAAAGoIFgAAQA3BAgAAqCFYAAAANQQLAACghmABAADUECwAAIAaggUAAFBDsAAAAGoIFgAAQA3BAgAAqCFYAAAANQQLAACghmABAADUECwAAIAaggUAAFBDsAAAAGoIFpr++cff/uevf2m6FagdhY4YxY0Yxd0MgoWmf//5+d++/ekPv/uWYzduFDpiFDdiFHczCBb6frj8jmO3DSh0xChuxChu3QgWdeHYbQkKHTGKGzGKWx+CRb04dluCQkeM4kaM4tZhJ89z++L7b75usCmo1VeP//D3s5833Qodt5984FhFe8TUeRGx208+yD+4YgEAANTcaroBtbC5acP+8d2v/vWn35etvfXjB1/+8jc/uvOTTTYpVk2VWGxhoaO5hNNsZc1WFjcm9NxQNJ3XijNYbBsGo5ag0BGjuBGjuLoIFvXieG0JCh0xihsxilsHgkVdOF5bgkJHjOJGjOLWh2Chj+O1JSh0xChuxChu3QgWmr5If/bVL37N8Ro9Ch0xihsxirsZBAtNX+4/bLoJ2AQKHTGKGzGKuxl8jwUAAFBDsAAAAGoIFgAAQA3BAgAAqCFYAAAANQQLAACghmABAADUECwAAIAaggUAAFBDsAAAAGoIFgAAQA3BAgAAqCFYAAAANQQLAACghmABAADUECwAAIAaggUAAFBDsAAAAGoIFgAAQM1OnudNtwEAAESCKxYAAEANwQIAAKghWAAAADX/BTmGz3USs5qoAAAAAElFTkSuQmCC" alt="" loading="lazy" />
      <figcaption></figcaption>
    </figure>
  
<h3 id="4-2-WorkTag"><a href="#4-2-WorkTag" class="headerlink" title="4.2 WorkTag"></a>4.2 WorkTag</h3><p><code>æ–‡ä»¶ä½ç½®ï¼špackages/shared/ReactWorkTags.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">type WorkTag =</span><br><span class="line">  | 0</span><br><span class="line">  | 1</span><br><span class="line">  | 2</span><br><span class="line">  | 3</span><br><span class="line">  | 4</span><br><span class="line">  | 5</span><br><span class="line">  | 6</span><br><span class="line">  | 7</span><br><span class="line">  | 8</span><br><span class="line">  | 9</span><br><span class="line">  | 10</span><br><span class="line">  | 11</span><br><span class="line">  | 12</span><br><span class="line">  | 13</span><br><span class="line">  | 14</span><br><span class="line">  | 15</span><br><span class="line">  | 16</span><br><span class="line">  | 17</span><br><span class="line">  | 18</span><br><span class="line">  | 19</span><br><span class="line">  | 20</span><br><span class="line">  | 21</span><br><span class="line">  | 22;</span><br><span class="line"></span><br><span class="line">export const FunctionComponent = 0;</span><br><span class="line">export const ClassComponent = 1;</span><br><span class="line">export const IndeterminateComponent = 2;</span><br><span class="line">export const HostRoot = 3;</span><br><span class="line">export const HostPortal = 4;</span><br><span class="line">export const HostComponent = 5;</span><br><span class="line">export const HostText = 6;</span><br><span class="line">export const Fragment = 7;</span><br><span class="line">export const Mode = 8;</span><br><span class="line">export const ContextConsumer = 9;</span><br><span class="line">export const ContextProvider = 10;</span><br><span class="line">export const ForwardRef = 11;</span><br><span class="line">export const Profiler = 12;</span><br><span class="line">export const SuspenseComponent = 13;</span><br><span class="line">export const MemoComponent = 14;</span><br><span class="line">export const SimpleMemoComponent = 15;</span><br><span class="line">export const LazyComponent = 16;</span><br><span class="line">export const IncompleteClassComponent = 17;</span><br><span class="line">export const DehydratedFragment = 18;</span><br><span class="line">export const SuspenseListComponent = 19;</span><br><span class="line">export const FundamentalComponent = 20;</span><br><span class="line">export const ScopeComponent = 21;</span><br><span class="line">export const Block = 22;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-TypeOfMode"><a href="#4-3-TypeOfMode" class="headerlink" title="4.3 TypeOfMode"></a>4.3 TypeOfMode</h3><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactTypeOfMode.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">export type TypeOfMode = number;</span><br><span class="line"></span><br><span class="line">// 0 åŒæ­¥æ¸²æŸ“æ¨¡å¼</span><br><span class="line">export const NoMode = 0b0000;</span><br><span class="line">// 1 ä¸¥æ ¼æ¨¡å¼</span><br><span class="line">export const StrictMode = 0b0001;</span><br><span class="line">// 10 å¼‚æ­¥æ¸²æŸ“è¿‡æ¸¡æ¨¡å¼</span><br><span class="line">export const BlockingMode = 0b0010;</span><br><span class="line">// 100 å¼‚æ­¥æ¸²æŸ“æ¨¡å¼</span><br><span class="line">export const ConcurrentMode = 0b0100;</span><br><span class="line">// 1000 æ€§èƒ½æµ‹è¯•æ¨¡å¼</span><br><span class="line">export const ProfileMode = 0b1000;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-SideEffectTag"><a href="#4-3-SideEffectTag" class="headerlink" title="4.3 SideEffectTag"></a>4.3 SideEffectTag</h3><p><code>æ–‡ä»¶ä½ç½®ï¼špackages/shared/ReactSideEffectTags.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">export type SideEffectTag = number;</span><br><span class="line"></span><br><span class="line">// Don&#x27;t change these two values. They&#x27;re used by React Dev Tools.</span><br><span class="line">export const NoEffect = /*              */ 0b0000000000000; // 0</span><br><span class="line">export const PerformedWork = /*         */ 0b0000000000001; // 1</span><br><span class="line"></span><br><span class="line">// You can change the rest (and add more).</span><br><span class="line">export const Placement = /*             */ 0b0000000000010; // 2</span><br><span class="line">export const Update = /*                */ 0b0000000000100; // 4</span><br><span class="line">export const PlacementAndUpdate = /*    */ 0b0000000000110; // 6</span><br><span class="line">export const Deletion = /*              */ 0b0000000001000; // 8</span><br><span class="line">export const ContentReset = /*          */ 0b0000000010000; // 16</span><br><span class="line">export const Callback = /*              */ 0b0000000100000; // 32</span><br><span class="line">export const DidCapture = /*            */ 0b0000001000000; // 64</span><br><span class="line">export const Ref = /*                   */ 0b0000010000000; // 128</span><br><span class="line">export const Snapshot = /*              */ 0b0000100000000; // 256</span><br><span class="line">export const Passive = /*               */ 0b0001000000000; // 512</span><br><span class="line">export const Hydrating = /*             */ 0b0010000000000; // 1024</span><br><span class="line">export const HydratingAndUpdate = /*    */ 0b0010000000100; // 1028</span><br><span class="line"></span><br><span class="line">// Passive &amp; Update &amp; Callback &amp; Ref &amp; Snapshot</span><br><span class="line">export const LifecycleEffectMask = /*   */ 0b0001110100100; // 932</span><br><span class="line"></span><br><span class="line">// Union of all host effects</span><br><span class="line">export const HostEffectMask = /*        */ 0b0011111111111; // 2047</span><br><span class="line"></span><br><span class="line">export const Incomplete = /*            */ 0b0100000000000; // 2048</span><br><span class="line">export const ShouldCapture = /*         */ 0b1000000000000; // 4096</span><br></pre></td></tr></table></figure>

<h3 id="4-4-Update"><a href="#4-4-Update" class="headerlink" title="4.4 Update"></a>4.4 Update</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">let update: Update&lt;*&gt; = &#123;</span><br><span class="line">  expirationTime,</span><br><span class="line">  suspenseConfig,</span><br><span class="line"></span><br><span class="line">  tag: UpdateState,</span><br><span class="line">  payload: null,</span><br><span class="line">  callback: null,</span><br><span class="line"></span><br><span class="line">  next: (null: any),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="4-5-UpdateQueue"><a href="#4-5-UpdateQueue" class="headerlink" title="4.5 UpdateQueue"></a>4.5 UpdateQueue</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const queue: &lt;State&gt; = &#123;</span><br><span class="line">  // ä¸Šä¸€æ¬¡æ›´æ–°ä¹‹åçš„ state, ä½œä¸ºä¸‹ä¸€æ¬¡æ›´æ–°çš„åŸºç¡€</span><br><span class="line">  baseState: fiber.memoizedState,</span><br><span class="line">  baseQueue: null,</span><br><span class="line">  shared: &#123;</span><br><span class="line">    pending: null,</span><br><span class="line">  &#125;,</span><br><span class="line">  effects: null,</span><br><span class="line">&#125;</span><br><span class="line">fiber.updateQueue = queue;</span><br></pre></td></tr></table></figure>

<h3 id="4-6-RootTag"><a href="#4-6-RootTag" class="headerlink" title="4.6 RootTag"></a>4.6 RootTag</h3><p><code>æ–‡ä»¶ä½ç½®ï¼špackages/shared/ReactRootTags.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">export type RootTag = 0 | 1 | 2;</span><br><span class="line"></span><br><span class="line">// ReactDOM.render</span><br><span class="line">export const LegacyRoot = 0;</span><br><span class="line">// ReactDOM.createBlockingRoot</span><br><span class="line">export const BlockingRoot = 1;</span><br><span class="line">// ReactDOM.createRoot</span><br><span class="line">export const ConcurrentRoot = 2;</span><br></pre></td></tr></table></figure>

<h3 id="4-7-åŒç¼“å­˜æŠ€æœ¯"><a href="#4-7-åŒç¼“å­˜æŠ€æœ¯" class="headerlink" title="4.7 åŒç¼“å­˜æŠ€æœ¯"></a>4.7 åŒç¼“å­˜æŠ€æœ¯</h3><p>åœ¨ React ä¸­ï¼ŒDOM çš„æ›´æ–°é‡‡ç”¨äº†åŒç¼“å­˜æŠ€æœ¯ï¼ŒåŒç¼“å­˜æŠ€æœ¯è‡´åŠ›äºæ›´å¿«é€Ÿçš„ DOM æ›´æ–°ã€‚</p>
<p>ä»€ä¹ˆæ˜¯åŒç¼“å­˜ï¼Ÿä¸¾ä¸ªä¾‹å­ï¼Œä½¿ç”¨ canvas ç»˜åˆ¶åŠ¨ç”»æ—¶ï¼Œåœ¨ç»˜åˆ¶æ¯ä¸€å¸§å‰éƒ½ä¼šæ¸…é™¤ä¸Šä¸€å¸§çš„ç”»é¢ï¼Œæ¸…é™¤ä¸Šä¸€å¸§éœ€è¦èŠ±è´¹æ—¶é—´ï¼Œå¦‚æœå½“å‰å¸§ç”»é¢è®¡ç®—é‡åˆæ¯”è¾ƒå¤§ï¼Œåˆéœ€è¦èŠ±è´¹æ¯”è¾ƒé•¿çš„æ—¶é—´ï¼Œè¿™å°±å¯¼è‡´ä¸Šä¸€å¸§æ¸…é™¤åˆ°ä¸‹ä¸€å¸§æ˜¾ç¤ºä¸­é—´ä¼šæœ‰è¾ƒé•¿çš„é—´éš™ï¼Œå°±ä¼šå‡ºç°ç™½å±ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å†…å­˜ä¸­ç»˜åˆ¶å½“å‰å¸§åŠ¨ç”»ï¼Œç»˜åˆ¶å®Œæ¯•åç›´æ¥ç”¨å½“å‰å¸§æ›¿æ¢ä¸Šä¸€å¸§ç”»é¢ï¼Œè¿™æ ·çš„è¯åœ¨å¸§ç”»é¢æ›¿æ¢çš„è¿‡ç¨‹ä¸­å°±ä¼šèŠ‚çº¦éå¸¸å¤šçš„æ—¶é—´ï¼Œå°±ä¸ä¼šå‡ºç°ç™½å±é—®é¢˜ã€‚è¿™ç§åœ¨å†…å­˜ä¸­æ„å»ºå¹¶ç›´æ¥æ›¿æ¢çš„æŠ€æœ¯å«åšåŒç¼“å­˜ã€‚</p>
<p>React ä½¿ç”¨åŒç¼“å­˜æŠ€æœ¯å®Œæˆ Fiber æ ‘çš„æ„å»ºä¸æ›¿æ¢ï¼Œå®ç°DOMå¯¹è±¡çš„å¿«é€Ÿæ›´æ–°ã€‚</p>
<p>åœ¨ React ä¸­æœ€å¤šä¼šåŒæ—¶å­˜åœ¨ä¸¤æ£µ Fiber æ ‘ï¼Œå½“å‰åœ¨å±å¹•ä¸­æ˜¾ç¤ºçš„å†…å®¹å¯¹åº”çš„ Fiber æ ‘å«åš current Fiber æ ‘ï¼Œå½“å‘ç”Ÿæ›´æ–°æ—¶ï¼ŒReact ä¼šåœ¨å†…å­˜ä¸­é‡æ–°æ„å»ºä¸€é¢—æ–°çš„ Fiber æ ‘ï¼Œè¿™é¢—æ­£åœ¨æ„å»ºçš„ Fiber æ ‘å«åš workInProgress Fiber æ ‘ã€‚åœ¨åŒç¼“å­˜æŠ€æœ¯ä¸­ï¼ŒworkInProgress Fiber æ ‘å°±æ˜¯å³å°†è¦æ˜¾ç¤ºåœ¨é¡µé¢ä¸­çš„ Fiber æ ‘ï¼Œå½“è¿™é¢— Fiber æ ‘æ„å»ºå®Œæˆåï¼ŒReact ä¼šä½¿ç”¨å®ƒç›´æ¥æ›¿æ¢ current Fiber æ ‘è¾¾åˆ°å¿«é€Ÿæ›´æ–° DOM çš„ç›®çš„ï¼Œå› ä¸º workInProgress Fiber æ ‘æ˜¯åœ¨å†…å­˜ä¸­æ„å»ºçš„æ‰€ä»¥æ„å»ºå®ƒçš„é€Ÿåº¦æ˜¯éå¸¸å¿«çš„ã€‚</p>
<p>ä¸€æ—¦ workInProgress Fiber æ ‘åœ¨å±å¹•ä¸Šå‘ˆç°ï¼Œå®ƒå°±ä¼šå˜æˆ current Fiber æ ‘ã€‚</p>
<p>åœ¨ current Fiber èŠ‚ç‚¹å¯¹è±¡ä¸­æœ‰ä¸€ä¸ª alternate å±æ€§æŒ‡å‘å¯¹åº”çš„ workInProgress Fiber èŠ‚ç‚¹å¯¹è±¡ï¼Œåœ¨ workInProgress Fiber èŠ‚ç‚¹ä¸­æœ‰ä¸€ä¸ª alternate å±æ€§ä¹ŸæŒ‡å‘å¯¹åº”çš„ current Fiber èŠ‚ç‚¹å¯¹è±¡ã€‚</p>

    <figure class="figure-image">
      <img src="https://gaoyubo01.github.io/docs/assets/img/3.1f2935b4.png" alt="å¸¦æè¿°å¸¦å›¾ç‰‡" loading="lazy" />
      <figcaption>å¸¦æè¿°å¸¦å›¾ç‰‡</figcaption>
    </figure>
  

    <figure class="figure-image">
      <img src="https://gaoyubo01.github.io/docs/assets/img/4.a7a1c86a.png" alt="å¸¦æè¿°å¸¦å›¾ç‰‡" loading="lazy" />
      <figcaption>å¸¦æè¿°å¸¦å›¾ç‰‡</figcaption>
    </figure>
  
<h3 id="4-8-åŒºåˆ†-fiberRoot-ä¸-rootFiber"><a href="#4-8-åŒºåˆ†-fiberRoot-ä¸-rootFiber" class="headerlink" title="4.8 åŒºåˆ† fiberRoot ä¸ rootFiber"></a>4.8 åŒºåˆ† fiberRoot ä¸ rootFiber</h3><p>fiberRoot è¡¨ç¤º Fiber æ•°æ®ç»“æ„å¯¹è±¡ï¼Œæ˜¯ Fiber æ•°æ®ç»“æ„ä¸­çš„æœ€å¤–å±‚å¯¹è±¡</p>
<p>rootFiber è¡¨ç¤ºç»„ä»¶æŒ‚è½½ç‚¹å¯¹åº”çš„ Fiber å¯¹è±¡ï¼Œæ¯”å¦‚ React åº”ç”¨ä¸­é»˜è®¤çš„ç»„ä»¶æŒ‚è½½ç‚¹å°±æ˜¯ id ä¸º root çš„ div</p>
<p>fiberRoot åŒ…å« rootFiberï¼Œåœ¨ fiberRoot å¯¹è±¡ä¸­æœ‰ä¸€ä¸ª current å±æ€§ï¼Œå­˜å‚¨ rootFiber</p>
<p>rootFiber æŒ‡å‘ fiberRootï¼Œåœ¨ rootFiber å¯¹è±¡ä¸­æœ‰ä¸€ä¸ª stateNode å±æ€§ï¼ŒæŒ‡å‘ fiberRoot</p>
<p>åœ¨ React åº”ç”¨ä¸­ FiberRoot åªæœ‰ä¸€ä¸ªï¼Œè€Œ rootFiber å¯ä»¥æœ‰å¤šä¸ªï¼Œå› ä¸º render æ–¹æ³•æ˜¯å¯ä»¥è°ƒç”¨å¤šæ¬¡çš„</p>
<p>fiberRoot ä¼šè®°å½•åº”ç”¨çš„æ›´æ–°ä¿¡æ¯ï¼Œæ¯”å¦‚åè°ƒå™¨åœ¨å®Œæˆå·¥ä½œåï¼Œä¼šå°†å·¥ä½œæˆæœå­˜å‚¨åœ¨ fiberRoot ä¸­ã€‚</p>

    <figure class="figure-image">
      <img src="https://gaoyubo01.github.io/docs/assets/img/7.f9d05c7e.png" alt="å¸¦æè¿°å¸¦å›¾ç‰‡" loading="lazy" />
      <figcaption>å¸¦æè¿°å¸¦å›¾ç‰‡</figcaption>
    </figure>
  
<h2 id="5-åˆå§‹åŒ–æ¸²æŸ“"><a href="#5-åˆå§‹åŒ–æ¸²æŸ“" class="headerlink" title="5. åˆå§‹åŒ–æ¸²æŸ“"></a>5. åˆå§‹åŒ–æ¸²æŸ“</h2><p>è¦å°† React å…ƒç´ æ¸²æŸ“åˆ°é¡µé¢ä¸­ï¼Œåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œrender é˜¶æ®µå’Œ commit é˜¶æ®µã€‚</p>
<p>render é˜¶æ®µè´Ÿè´£åˆ›å»º Fiber æ•°æ®ç»“æ„å¹¶ä¸º Fiber èŠ‚ç‚¹æ‰“æ ‡è®°ï¼Œæ ‡è®°å½“å‰ Fiber èŠ‚ç‚¹è¦è¿›è¡Œçš„ DOM æ“ä½œã€‚</p>
<p>commit é˜¶æ®µè´Ÿè´£æ ¹æ® Fiber èŠ‚ç‚¹æ ‡è®° ( effectTag ) è¿›è¡Œç›¸åº”çš„ DOM æ“ä½œã€‚</p>
<h3 id="5-1-render-é˜¶æ®µ"><a href="#5-1-render-é˜¶æ®µ" class="headerlink" title="5.1 render é˜¶æ®µ"></a>5.1 render é˜¶æ®µ</h3><h4 id="5-1-1-render"><a href="#5-1-1-render" class="headerlink" title="5.1.1 render"></a>5.1.1 render</h4><p><code>æ–‡ä»¶ä½ç½®ï¼špackages/react-dom/src/client/ReactDOMLegacy.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * æ¸²æŸ“å…¥å£</span><br><span class="line"> * element è¦è¿›è¡Œæ¸²æŸ“çš„ ReactElement, createElement æ–¹æ³•çš„è¿”å›å€¼</span><br><span class="line"> * container æ¸²æŸ“å®¹å™¨ &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span><br><span class="line"> * callback æ¸²æŸ“å®Œæˆåæ‰§è¡Œçš„å›è°ƒå‡½æ•°</span><br><span class="line"> */</span><br><span class="line">export function render(</span><br><span class="line">  element: React$Element&lt;any&gt;,</span><br><span class="line">  container: Container,</span><br><span class="line">  callback: ?Function,</span><br><span class="line">) &#123;</span><br><span class="line">  // æ£€æµ‹ container æ˜¯å¦æ˜¯ç¬¦åˆè¦æ±‚çš„æ¸²æŸ“å®¹å™¨</span><br><span class="line">  // å³æ£€æµ‹ container æ˜¯å¦æ˜¯çœŸå®çš„DOMå¯¹è±¡</span><br><span class="line">  // å¦‚æœä¸ç¬¦åˆè¦æ±‚å°±æŠ¥é”™</span><br><span class="line">  invariant(</span><br><span class="line">    isValidContainer(container),</span><br><span class="line">    &#x27;Target container is not a DOM element.&#x27;,</span><br><span class="line">  );</span><br><span class="line">  return legacyRenderSubtreeIntoContainer(</span><br><span class="line">    // çˆ¶ç»„ä»¶ åˆå§‹æ¸²æŸ“æ²¡æœ‰çˆ¶ç»„ä»¶ ä¼ é€’ null å ä½</span><br><span class="line">    null,</span><br><span class="line">    element,</span><br><span class="line">    container,</span><br><span class="line">    // æ˜¯å¦ä¸ºæœåŠ¡å™¨ç«¯æ¸²æŸ“ false ä¸æ˜¯æœåŠ¡å™¨ç«¯æ¸²æŸ“ true æ˜¯æœåŠ¡å™¨ç«¯æ¸²æŸ“</span><br><span class="line">    false,</span><br><span class="line">    callback,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-1-2-isValidContainer"><a href="#5-1-2-isValidContainer" class="headerlink" title="5.1.2 isValidContainer"></a>5.1.2 isValidContainer</h4><p><code>æ–‡ä»¶ä½ç½®ï¼špackages/react-dom/src/client/ReactDOMRoot.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * åˆ¤æ–­ node æ˜¯å¦æ˜¯ç¬¦åˆè¦æ±‚çš„ DOM èŠ‚ç‚¹</span><br><span class="line"> * 1. node å¯ä»¥æ˜¯å…ƒç´ èŠ‚ç‚¹</span><br><span class="line"> * 2. node å¯ä»¥æ˜¯ document èŠ‚ç‚¹</span><br><span class="line"> * 3. node å¯ä»¥æ˜¯ æ–‡æ¡£ç¢ç‰‡èŠ‚ç‚¹</span><br><span class="line"> * 4. node å¯ä»¥æ˜¯æ³¨é‡ŠèŠ‚ç‚¹ä½†æ³¨é‡Šå†…å®¹å¿…é¡»æ˜¯ react-mount-point-unstable</span><br><span class="line"> * 		react å†…éƒ¨ä¼šæ‰¾åˆ°æ³¨é‡ŠèŠ‚ç‚¹çš„çˆ¶çº§ é€šè¿‡è°ƒç”¨çˆ¶çº§å…ƒç´ çš„ insertBefore æ–¹æ³•, å°† element æ’å…¥åˆ°æ³¨é‡ŠèŠ‚ç‚¹çš„å‰é¢</span><br><span class="line"> */</span><br><span class="line">export function isValidContainer(node: mixed): boolean &#123;</span><br><span class="line">  return !!(</span><br><span class="line">    node &amp;&amp;</span><br><span class="line">    (node.nodeType === ELEMENT_NODE ||</span><br><span class="line">      node.nodeType === DOCUMENT_NODE ||</span><br><span class="line">      node.nodeType === DOCUMENT_FRAGMENT_NODE ||</span><br><span class="line">      (node.nodeType === COMMENT_NODE &amp;&amp;</span><br><span class="line">        (node: any).nodeValue === &#x27; react-mount-point-unstable &#x27;))</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-1-3-åˆå§‹åŒ–-FiberRoot"><a href="#5-1-3-åˆå§‹åŒ–-FiberRoot" class="headerlink" title="5.1.3 åˆå§‹åŒ– FiberRoot"></a>5.1.3 åˆå§‹åŒ– FiberRoot</h4><h5 id="5-1-3-1-legacyRenderSubtreeIntoContainer"><a href="#5-1-3-1-legacyRenderSubtreeIntoContainer" class="headerlink" title="5.1.3.1 legacyRenderSubtreeIntoContainer"></a>5.1.3.1 legacyRenderSubtreeIntoContainer</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-dom/src/client/ReactDOMLegacy.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * å°†å­æ ‘æ¸²æŸ“åˆ°å®¹å™¨ä¸­ (åˆå§‹åŒ– Fiber æ•°æ®ç»“æ„: åˆ›å»º fiberRoot åŠ rootFiber)</span><br><span class="line"> * parentComponent: çˆ¶ç»„ä»¶, åˆå§‹æ¸²æŸ“ä¼ å…¥äº† null</span><br><span class="line"> * children: render æ–¹æ³•ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°, è¦æ¸²æŸ“çš„ ReactElement</span><br><span class="line"> * container: æ¸²æŸ“å®¹å™¨</span><br><span class="line"> * forceHydrate: true ä¸ºæœåŠ¡ç«¯æ¸²æŸ“, false ä¸ºå®¢æˆ·ç«¯æ¸²æŸ“</span><br><span class="line"> * callback: ç»„ä»¶æ¸²æŸ“å®Œæˆåéœ€è¦æ‰§è¡Œçš„å›è°ƒå‡½æ•°</span><br><span class="line"> **/</span><br><span class="line">function legacyRenderSubtreeIntoContainer(</span><br><span class="line">  parentComponent: ?React$Component&lt;any, any&gt;,</span><br><span class="line">  children: ReactNodeList,</span><br><span class="line">  container: Container,</span><br><span class="line">  forceHydrate: boolean,</span><br><span class="line">  callback: ?Function,</span><br><span class="line">) &#123;</span><br><span class="line">  /**</span><br><span class="line">   * æ£€æµ‹ container æ˜¯å¦å·²ç»æ˜¯åˆå§‹åŒ–è¿‡çš„æ¸²æŸ“å®¹å™¨</span><br><span class="line">   * react åœ¨åˆå§‹æ¸²æŸ“æ—¶ä¼šä¸ºæœ€å¤–å±‚å®¹å™¨æ·»åŠ  _reactRootContainer å±æ€§</span><br><span class="line">   * react ä¼šæ ¹æ®æ­¤å±æ€§è¿›è¡Œä¸åŒçš„æ¸²æŸ“æ–¹å¼</span><br><span class="line">   * root ä¸å­˜åœ¨ è¡¨ç¤ºåˆå§‹æ¸²æŸ“</span><br><span class="line">   * root å­˜åœ¨ è¡¨ç¤ºæ›´æ–°</span><br><span class="line">   */</span><br><span class="line">  // è·å– container å®¹å™¨å¯¹è±¡ä¸‹æ˜¯å¦æœ‰ _reactRootContainer å±æ€§</span><br><span class="line">  let root: RootType = (container._reactRootContainer: any);</span><br><span class="line">  // å³å°†å­˜å‚¨æ ¹ Fiber å¯¹è±¡</span><br><span class="line">  let fiberRoot;</span><br><span class="line">  if (!root) &#123;</span><br><span class="line">    // åˆå§‹æ¸²æŸ“</span><br><span class="line">    // åˆå§‹åŒ–æ ¹ Fiber æ•°æ®ç»“æ„</span><br><span class="line">    // ä¸º container å®¹å™¨æ·»åŠ  _reactRootContainer å±æ€§</span><br><span class="line">    // åœ¨ _reactRootContainer å¯¹è±¡ä¸­æœ‰ä¸€ä¸ªå±æ€§å«åš _internalRoot</span><br><span class="line">    // _internalRoot å±æ€§å€¼å³ä¸º FiberRoot è¡¨ç¤ºæ ¹èŠ‚ç‚¹ Fiber æ•°æ®ç»“æ„</span><br><span class="line">    // legacyCreateRootFromDOMContainer</span><br><span class="line">    // createLegacyRoot</span><br><span class="line">    // new ReactDOMBlockingRoot -&gt; this._internalRoot</span><br><span class="line">    // createRootImpl</span><br><span class="line">    root = container._reactRootContainer = legacyCreateRootFromDOMContainer(</span><br><span class="line">      container,</span><br><span class="line">      forceHydrate,</span><br><span class="line">    );</span><br><span class="line">    // è·å– Fiber Root å¯¹è±¡</span><br><span class="line">    fiberRoot = root._internalRoot;</span><br><span class="line">    /**</span><br><span class="line">     * æ”¹å˜ callback å‡½æ•°ä¸­çš„ this æŒ‡å‘</span><br><span class="line">     * ä½¿å…¶æŒ‡å‘ render æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°çš„çœŸå® DOM å¯¹è±¡</span><br><span class="line">     */</span><br><span class="line">    // å¦‚æœ callback å‚æ•°æ˜¯å‡½æ•°ç±»å‹</span><br><span class="line">    if (typeof callback === &#x27;function&#x27;) &#123;</span><br><span class="line">      // ä½¿ç”¨ originalCallback å­˜å‚¨ callback å‡½æ•°</span><br><span class="line">      const originalCallback = callback;</span><br><span class="line">      // ä¸º callback å‚æ•°é‡æ–°èµ‹å€¼</span><br><span class="line">      callback = function () &#123;</span><br><span class="line">        // è·å– render æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°çš„çœŸå® DOM å¯¹è±¡</span><br><span class="line">        // å®é™…ä¸Šå°±æ˜¯ id=&quot;root&quot; çš„ div çš„å­å…ƒç´ </span><br><span class="line">        // rootFiber.child.stateNode</span><br><span class="line">        // rootFiber å°±æ˜¯ id=&quot;root&quot; çš„ div</span><br><span class="line">        const instance = getPublicRootInstance(fiberRoot);</span><br><span class="line">        // è°ƒç”¨ callback å‡½æ•°å¹¶æ”¹å˜å‡½æ•°å†…éƒ¨ this æŒ‡å‘</span><br><span class="line">        originalCallback.call(instance);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    // åˆå§‹åŒ–æ¸²æŸ“ä¸æ‰§è¡Œæ‰¹é‡æ›´æ–°</span><br><span class="line">    // å› ä¸ºæ‰¹é‡æ›´æ–°æ˜¯å¼‚æ­¥çš„æ˜¯å¯ä»¥è¢«æ‰“æ–­çš„, ä½†æ˜¯åˆå§‹åŒ–æ¸²æŸ“åº”è¯¥å°½å¿«å®Œæˆä¸èƒ½è¢«æ‰“æ–­</span><br><span class="line">    // æ‰€ä»¥ä¸æ‰§è¡Œæ‰¹é‡æ›´æ–°</span><br><span class="line">    unbatchedUpdates(() =&gt; &#123;</span><br><span class="line">      updateContainer(children, fiberRoot, parentComponent, callback);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // éåˆå§‹åŒ–æ¸²æŸ“ å³æ›´æ–°</span><br><span class="line">    fiberRoot = root._internalRoot;</span><br><span class="line">    if (typeof callback === &#x27;function&#x27;) &#123;</span><br><span class="line">      const originalCallback = callback;</span><br><span class="line">      callback = function () &#123;</span><br><span class="line">        const instance = getPublicRootInstance(fiberRoot);</span><br><span class="line">        originalCallback.call(instance);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    // Update</span><br><span class="line">    updateContainer(children, fiberRoot, parentComponent, callback);</span><br><span class="line">  &#125;</span><br><span class="line">  // è¿”å› render æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°çš„çœŸå® DOM å¯¹è±¡ä½œä¸º render æ–¹æ³•çš„è¿”å›å€¼</span><br><span class="line">  // å°±æ˜¯è¯´æ¸²æŸ“è° è¿”å›è°çš„çœŸå® DOM å¯¹è±¡</span><br><span class="line">  return getPublicRootInstance(fiberRoot);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


    <figure class="figure-image">
      <img src="https://gaoyubo01.github.io/docs/assets/img/5.28c3e63b.png" alt="å¸¦æè¿°å¸¦å›¾ç‰‡" loading="lazy" />
      <figcaption>å¸¦æè¿°å¸¦å›¾ç‰‡</figcaption>
    </figure>
  

<h5 id="5-1-3-2-legacyCreateRootFromDOMContainer"><a href="#5-1-3-2-legacyCreateRootFromDOMContainer" class="headerlink" title="5.1.3.2 legacyCreateRootFromDOMContainer"></a>5.1.3.2 legacyCreateRootFromDOMContainer</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-dom/src/client/ReactDOMLegacy.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * åˆ¤æ–­æ˜¯å¦ä¸ºæœåŠ¡å™¨ç«¯æ¸²æŸ“ å¦‚æœä¸æ˜¯æœåŠ¡å™¨ç«¯æ¸²æŸ“</span><br><span class="line"> * æ¸…ç©º container å®¹å™¨ä¸­çš„èŠ‚ç‚¹</span><br><span class="line"> */</span><br><span class="line">function legacyCreateRootFromDOMContainer(</span><br><span class="line">  container: Container,</span><br><span class="line">  forceHydrate: boolean,</span><br><span class="line">): RootType &#123;</span><br><span class="line">  // container =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span><br><span class="line">  // æ£€æµ‹æ˜¯å¦ä¸ºæœåŠ¡å™¨ç«¯æ¸²æŸ“</span><br><span class="line">  const shouldHydrate =</span><br><span class="line">    forceHydrate || shouldHydrateDueToLegacyHeuristic(container);</span><br><span class="line">  // å¦‚æœä¸æ˜¯æœåŠ¡å™¨ç«¯æ¸²æŸ“</span><br><span class="line">  if (!shouldHydrate) &#123;</span><br><span class="line">    let rootSibling;</span><br><span class="line">    // å¼€å¯å¾ªç¯ åˆ é™¤ container å®¹å™¨ä¸­çš„èŠ‚ç‚¹</span><br><span class="line">    while ((rootSibling = container.lastChild)) &#123;</span><br><span class="line">      // åˆ é™¤ container å®¹å™¨ä¸­çš„èŠ‚ç‚¹</span><br><span class="line">      container.removeChild(rootSibling);</span><br><span class="line">      /**</span><br><span class="line">       * ä¸ºä»€ä¹ˆè¦æ¸…é™¤ container ä¸­çš„å…ƒç´  ?</span><br><span class="line">       * ä¸ºæä¾›é¦–å±åŠ è½½çš„ç”¨æˆ·ä½“éªŒ, æœ‰æ—¶éœ€è¦åœ¨ container ä¸­æ”¾ç½®ä¸€äº›å ä½å›¾æˆ–è€… loading å›¾</span><br><span class="line">       * å°±æ— å¯é¿å…çš„è¦å‘ container ä¸­åŠ å…¥ html æ ‡è®°.</span><br><span class="line">       * åœ¨å°† ReactElement æ¸²æŸ“åˆ° container ä¹‹å‰, å¿…ç„¶è¦å…ˆæ¸…ç©º container</span><br><span class="line">       * å› ä¸ºå ä½å›¾å’Œ ReactElement ä¸èƒ½åŒæ—¶æ˜¾ç¤º</span><br><span class="line">       *</span><br><span class="line">       * åœ¨åŠ å…¥å ä½ä»£ç æ—¶, æœ€å¥½åªæœ‰ä¸€ä¸ªçˆ¶çº§å…ƒç´ , å¯ä»¥å‡å°‘å†…éƒ¨ä»£ç çš„å¾ªç¯æ¬¡æ•°ä»¥æé«˜æ€§èƒ½</span><br><span class="line">       * &lt;div&gt;</span><br><span class="line">       *  &lt;p&gt;placement&lt;p&gt;</span><br><span class="line">       *  &lt;p&gt;placement&lt;p&gt;</span><br><span class="line">       *  &lt;p&gt;placement&lt;p&gt;</span><br><span class="line">       * &lt;/div&gt;</span><br><span class="line">       */</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return createLegacyRoot(</span><br><span class="line">    container,</span><br><span class="line">    shouldHydrate</span><br><span class="line">      ? &#123;</span><br><span class="line">          hydrate: true,</span><br><span class="line">        &#125;</span><br><span class="line">      : undefined,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-1-3-3-createLegacyRoot"><a href="#5-1-3-3-createLegacyRoot" class="headerlink" title="5.1.3.3 createLegacyRoot"></a>5.1.3.3 createLegacyRoot</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-dom/src/client/ReactDOMRoot.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * é€šè¿‡å®ä¾‹åŒ– ReactDOMBlockingRoot ç±»åˆ›å»º LegacyRoot</span><br><span class="line"> */</span><br><span class="line">export function createLegacyRoot(</span><br><span class="line">  container: Container,</span><br><span class="line">  options?: RootOptions,</span><br><span class="line">): RootType &#123;</span><br><span class="line">  // container =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span><br><span class="line">  // LegacyRoot å¸¸é‡, å€¼ä¸º 0,</span><br><span class="line">  // é€šè¿‡ render æ–¹æ³•åˆ›å»ºçš„ container å°±æ˜¯ LegacyRoot</span><br><span class="line">  return new ReactDOMBlockingRoot(container, LegacyRoot, options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-1-3-3-ReactDOMBlockingRoot"><a href="#5-1-3-3-ReactDOMBlockingRoot" class="headerlink" title="5.1.3.3 ReactDOMBlockingRoot"></a>5.1.3.3 ReactDOMBlockingRoot</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-dom/src/client/ReactDOMRoot.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * ç±», é€šè¿‡å®ƒå¯ä»¥åˆ›å»º LegacyRoot çš„ Fiber æ•°æ®ç»“æ„</span><br><span class="line"> */</span><br><span class="line">function ReactDOMBlockingRoot(</span><br><span class="line">  container: Container,</span><br><span class="line">  tag: RootTag,</span><br><span class="line">  options: void | RootOptions,</span><br><span class="line">) &#123;</span><br><span class="line">  // tag =&gt; 0 =&gt; legacyRoot</span><br><span class="line">  // container =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span><br><span class="line">  // container._reactRootContainer = &#123;_internalRoot: &#123;&#125;&#125;</span><br><span class="line">  this._internalRoot = createRootImpl(container, tag, options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-1-3-4-createRootImpl"><a href="#5-1-3-4-createRootImpl" class="headerlink" title="5.1.3.4 createRootImpl"></a>5.1.3.4 createRootImpl</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-dom/src/client/ReactDOMRoot.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">function createRootImpl(</span><br><span class="line">  container: Container,</span><br><span class="line">  tag: RootTag,</span><br><span class="line">  options: void | RootOptions,</span><br><span class="line">) &#123;</span><br><span class="line">  // container =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span><br><span class="line">  // tag =&gt; 0</span><br><span class="line">  // options =&gt; undefined</span><br><span class="line">  const root = createContainer(container, tag, hydrate, hydrationCallbacks);</span><br><span class="line">  markContainerAsRoot(root.current, container);</span><br><span class="line">  return root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-1-3-5-createContainer"><a href="#5-1-3-5-createContainer" class="headerlink" title="5.1.3.5 createContainer"></a>5.1.3.5 createContainer</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberReconciler.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// åˆ›å»º container</span><br><span class="line">export function createContainer(</span><br><span class="line">  containerInfo: Container,</span><br><span class="line">  tag: RootTag,</span><br><span class="line">  hydrate: boolean,</span><br><span class="line">  hydrationCallbacks: null | SuspenseHydrationCallbacks,</span><br><span class="line">): OpaqueRoot &#123;</span><br><span class="line">  // containerInfo =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span><br><span class="line">  // tag: 0</span><br><span class="line">  // hydrate: false</span><br><span class="line">  // hydrationCallbacks: null</span><br><span class="line">  // å¿½ç•¥äº†å’ŒæœåŠ¡å™¨ç«¯æ¸²æŸ“ç›¸å…³çš„å†…å®¹</span><br><span class="line">  return createFiberRoot(containerInfo, tag, hydrate, hydrationCallbacks);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-1-3-6-createFiberRoot"><a href="#5-1-3-6-createFiberRoot" class="headerlink" title="5.1.3.6 createFiberRoot"></a>5.1.3.6 createFiberRoot</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberRoot.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// åˆ›å»ºæ ¹èŠ‚ç‚¹å¯¹åº”çš„ fiber å¯¹è±¡</span><br><span class="line">export function createFiberRoot(</span><br><span class="line">  containerInfo: any,</span><br><span class="line">  tag: RootTag,</span><br><span class="line">  hydrate: boolean,</span><br><span class="line">  hydrationCallbacks: null | SuspenseHydrationCallbacks,</span><br><span class="line">): FiberRoot &#123;</span><br><span class="line">  // åˆ›å»º FiberRoot</span><br><span class="line">  const root: FiberRoot = (new FiberRootNode(containerInfo, tag, hydrate): any);</span><br><span class="line">  // åˆ›å»ºæ ¹èŠ‚ç‚¹å¯¹åº”çš„ rootFiber</span><br><span class="line">  const uninitializedFiber = createHostRootFiber(tag);</span><br><span class="line">  // ä¸º fiberRoot æ·»åŠ  current å±æ€§ å€¼ä¸º rootFiber</span><br><span class="line">  root.current = uninitializedFiber;</span><br><span class="line">  // ä¸º rootFiber æ·»åŠ  stateNode å±æ€§ å€¼ä¸º fiberRoot</span><br><span class="line">  uninitializedFiber.stateNode = root;</span><br><span class="line">  // ä¸º fiber å¯¹è±¡æ·»åŠ  updateQueue å±æ€§, åˆå§‹åŒ– updateQueue å¯¹è±¡</span><br><span class="line">  // updateQueue ç”¨äºå­˜æ”¾ Update å¯¹è±¡</span><br><span class="line">  // Update å¯¹è±¡ç”¨äºè®°å½•ç»„ä»¶çŠ¶æ€çš„æ”¹å˜</span><br><span class="line">  initializeUpdateQueue(uninitializedFiber);</span><br><span class="line">  // è¿”å› root</span><br><span class="line">  return root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-1-3-7-FiberRootNode"><a href="#5-1-3-7-FiberRootNode" class="headerlink" title="5.1.3.7 FiberRootNode"></a>5.1.3.7 FiberRootNode</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberRoot.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">function FiberRootNode(containerInfo, tag, hydrate) &#123;</span><br><span class="line">  this.tag = tag;</span><br><span class="line">  this.current = null;</span><br><span class="line">  this.containerInfo = containerInfo;</span><br><span class="line">  this.pendingChildren = null;</span><br><span class="line">  this.pingCache = null;</span><br><span class="line">  this.finishedExpirationTime = NoWork;</span><br><span class="line">  this.finishedWork = null;</span><br><span class="line">  this.timeoutHandle = noTimeout;</span><br><span class="line">  this.context = null;</span><br><span class="line">  this.pendingContext = null;</span><br><span class="line">  this.hydrate = hydrate;</span><br><span class="line">  this.callbackNode = null;</span><br><span class="line">  this.callbackPriority = NoPriority;</span><br><span class="line">  this.firstPendingTime = NoWork;</span><br><span class="line">  this.firstSuspendedTime = NoWork;</span><br><span class="line">  this.lastSuspendedTime = NoWork;</span><br><span class="line">  this.nextKnownPendingLevel = NoWork;</span><br><span class="line">  this.lastPingedTime = NoWork;</span><br><span class="line">  this.lastExpiredTime = NoWork;</span><br><span class="line">  if (enableSchedulerTracing) &#123;</span><br><span class="line">    this.interactionThreadID = unstable_getThreadID();</span><br><span class="line">    this.memoizedInteractions = new Set();</span><br><span class="line">    this.pendingInteractionMap = new Map();</span><br><span class="line">  &#125;</span><br><span class="line">  if (enableSuspenseCallback) &#123;</span><br><span class="line">    this.hydrationCallbacks = null;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-3-1-8-initializeUpdateQueue"><a href="#5-3-1-8-initializeUpdateQueue" class="headerlink" title="5.3.1.8 initializeUpdateQueue"></a>5.3.1.8 initializeUpdateQueue</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberRoot.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">export function initializeUpdateQueue&lt;State&gt;(fiber: Fiber): void &#123;</span><br><span class="line">  const queue: UpdateQueue&lt;State&gt; = &#123;</span><br><span class="line">    baseState: fiber.memoizedState,</span><br><span class="line">    baseQueue: null,</span><br><span class="line">    shared: &#123;</span><br><span class="line">      pending: null,</span><br><span class="line">    &#125;,</span><br><span class="line">    effects: null,</span><br><span class="line">  &#125;;</span><br><span class="line">  fiber.updateQueue = queue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="5-1-4-è·å–-rootFiber-child-å®ä¾‹å¯¹è±¡"><a href="#5-1-4-è·å–-rootFiber-child-å®ä¾‹å¯¹è±¡" class="headerlink" title="5.1.4 è·å– rootFiber.child å®ä¾‹å¯¹è±¡"></a>5.1.4 è·å– rootFiber.child å®ä¾‹å¯¹è±¡</h4><h5 id="5-1-4-1-getPublicRootInstance"><a href="#5-1-4-1-getPublicRootInstance" class="headerlink" title="5.1.4.1  getPublicRootInstance"></a>5.1.4.1  getPublicRootInstance</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberReconciler.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * è·å– container çš„ç¬¬ä¸€ä¸ªå­å…ƒç´ çš„å®ä¾‹å¯¹è±¡</span><br><span class="line"> */</span><br><span class="line">export function getPublicRootInstance(</span><br><span class="line">  // FiberRoot</span><br><span class="line">  container: OpaqueRoot,</span><br><span class="line">): React$Component&lt;any, any&gt; | PublicInstance | null &#123;</span><br><span class="line">  // è·å– rootFiber</span><br><span class="line">  const containerFiber = container.current;</span><br><span class="line">  // å¦‚æœ rootFiber æ²¡æœ‰å­å…ƒç´ </span><br><span class="line">  // æŒ‡çš„å°±æ˜¯ id=&quot;root&quot; çš„ div æ²¡æœ‰å­å…ƒç´ </span><br><span class="line">  if (!containerFiber.child) &#123;</span><br><span class="line">    // è¿”å› null</span><br><span class="line">    return null;</span><br><span class="line">  &#125;</span><br><span class="line">  // åŒ¹é…å­å…ƒç´ çš„ç±»å‹</span><br><span class="line">  switch (containerFiber.child.tag) &#123;</span><br><span class="line">    // æ™®é€š</span><br><span class="line">    case HostComponent:</span><br><span class="line">      return getPublicInstance(containerFiber.child.stateNode);</span><br><span class="line">    default:</span><br><span class="line">      // è¿”å›å­å…ƒç´ çš„çœŸå® DOM å¯¹è±¡</span><br><span class="line">      return containerFiber.child.stateNode;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-1-4-2-getPublicInstance"><a href="#5-1-4-2-getPublicInstance" class="headerlink" title="5.1.4.2 getPublicInstance"></a>5.1.4.2 getPublicInstance</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-dom/src/client/ReactDOMHostConfig.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export function getPublicInstance(instance: Instance): * &#123;</span><br><span class="line">  return instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-1-5-updateContainer"><a href="#5-1-5-updateContainer" class="headerlink" title="5.1.5 updateContainer"></a>5.1.5 updateContainer</h4><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberReconciler.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * è®¡ç®—ä»»åŠ¡çš„è¿‡æœŸæ—¶é—´</span><br><span class="line"> * å†æ ¹æ®ä»»åŠ¡è¿‡æœŸæ—¶é—´åˆ›å»º Update ä»»åŠ¡</span><br><span class="line"> */</span><br><span class="line">export function updateContainer(</span><br><span class="line">	// element è¦æ¸²æŸ“çš„ ReactElement</span><br><span class="line">  element: ReactNodeList,</span><br><span class="line">  // container Fiber Root å¯¹è±¡</span><br><span class="line">  container: OpaqueRoot,</span><br><span class="line">  // parentComponent çˆ¶ç»„ä»¶ åˆå§‹æ¸²æŸ“ä¸º null</span><br><span class="line">  parentComponent: ?React$Component&lt;any, any&gt;,</span><br><span class="line">  // ReactElement æ¸²æŸ“å®Œæˆæ‰§è¡Œçš„å›è°ƒå‡½æ•°</span><br><span class="line">  callback: ?Function,</span><br><span class="line">): ExpirationTime &#123;  </span><br><span class="line">  // container è·å– rootFiber</span><br><span class="line">  const current = container.current;</span><br><span class="line">  // è·å–å½“å‰è·ç¦» react åº”ç”¨åˆå§‹åŒ–çš„æ—¶é—´ 1073741805</span><br><span class="line">  const currentTime = requestCurrentTimeForUpdate();</span><br><span class="line">  // å¼‚æ­¥åŠ è½½è®¾ç½®</span><br><span class="line">  const suspenseConfig = requestCurrentSuspenseConfig();</span><br><span class="line"></span><br><span class="line">  // è®¡ç®—è¿‡æœŸæ—¶é—´</span><br><span class="line">  // ä¸ºé˜²æ­¢ä»»åŠ¡å› ä¸ºä¼˜å…ˆçº§çš„åŸå› ä¸€ç›´è¢«æ‰“æ–­è€Œæœªèƒ½æ‰§è¡Œ</span><br><span class="line">  // react ä¼šè®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´, å½“æ—¶é—´åˆ°äº†è¿‡æœŸæ—¶é—´çš„æ—¶å€™</span><br><span class="line">  // å¦‚æœä»»åŠ¡è¿˜æœªæ‰§è¡Œçš„è¯, react å°†ä¼šå¼ºåˆ¶æ‰§è¡Œè¯¥ä»»åŠ¡</span><br><span class="line">  // åˆå§‹åŒ–æ¸²æŸ“æ—¶, ä»»åŠ¡åŒæ­¥æ‰§è¡Œä¸æ¶‰åŠè¢«æ‰“æ–­çš„é—®é¢˜ 1073741823</span><br><span class="line">  const expirationTime = computeExpirationForFiber(</span><br><span class="line">    currentTime,</span><br><span class="line">    current,</span><br><span class="line">    suspenseConfig,</span><br><span class="line">  );</span><br><span class="line">  // è®¾ç½®FiberRoot.context, é¦–æ¬¡æ‰§è¡Œè¿”å›ä¸€ä¸ªemptyContext, æ˜¯ä¸€ä¸ª &#123;&#125;</span><br><span class="line">  const context = getContextForSubtree(parentComponent);</span><br><span class="line">  // åˆå§‹æ¸²æŸ“æ—¶ Fiber Root å¯¹è±¡ä¸­çš„ context å±æ€§å€¼ä¸º null</span><br><span class="line">  // æ‰€ä»¥ä¼šè¿›å…¥åˆ° if ä¸­</span><br><span class="line">  if (container.context === null) &#123;</span><br><span class="line">    // åˆå§‹æ¸²æŸ“æ—¶å°† context å±æ€§å€¼è®¾ç½®ä¸º &#123;&#125;</span><br><span class="line">    container.context = context;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    container.pendingContext = context;</span><br><span class="line">  &#125;</span><br><span class="line">  // åˆ›å»ºä¸€ä¸ªå¾…æ‰§è¡Œä»»åŠ¡</span><br><span class="line">  const update = createUpdate(expirationTime, suspenseConfig);</span><br><span class="line">  // å°†è¦æ›´æ–°çš„å†…å®¹æŒ‚è½½åˆ°æ›´æ–°å¯¹è±¡ä¸­çš„ payload ä¸­</span><br><span class="line">  // å°†è¦æ›´æ–°çš„ç»„ä»¶å­˜å‚¨åœ¨ payload å¯¹è±¡ä¸­, æ–¹ä¾¿åæœŸè·å–</span><br><span class="line">  update.payload = &#123;element&#125;;</span><br><span class="line">  // åˆ¤æ–­ callback æ˜¯å¦å­˜åœ¨</span><br><span class="line">  callback = callback === undefined ? null : callback;</span><br><span class="line">  // å¦‚æœ callback å­˜åœ¨</span><br><span class="line">  if (callback !== null) &#123;</span><br><span class="line">    // å°† callback æŒ‚è½½åˆ° update å¯¹è±¡ä¸­</span><br><span class="line">    // å…¶å®å°±æ˜¯ä¸€å±‚å±‚ä¼ é€’ æ–¹ä¾¿ ReactElement å…ƒç´ æ¸²æŸ“å®Œæˆè°ƒç”¨</span><br><span class="line">    // å›è°ƒå‡½æ•°æ‰§è¡Œå®Œæˆåä¼šè¢«æ¸…é™¤ å¯ä»¥åœ¨ä»£ç çš„åé¢åŠ ä¸Š return è¿›è¡ŒéªŒè¯</span><br><span class="line">    update.callback = callback;</span><br><span class="line">  &#125;</span><br><span class="line">  // å°† update å¯¹è±¡åŠ å…¥åˆ°å½“å‰ Fiber çš„æ›´æ–°é˜Ÿåˆ—å½“ä¸­ (updateQueue)</span><br><span class="line">  enqueueUpdate(current, update);</span><br><span class="line">  // è°ƒåº¦å’Œæ›´æ–° current å¯¹è±¡</span><br><span class="line">  scheduleWork(current, expirationTime);</span><br><span class="line">  // è¿”å›è¿‡æœŸæ—¶é—´</span><br><span class="line">  return expirationTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-1-6-enqueueUpdate"><a href="#5-1-6-enqueueUpdate" class="headerlink" title="5.1.6 enqueueUpdate"></a>5.1.6 enqueueUpdate</h4><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactUpdateQueue.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// å°†ä»»åŠ¡(Update)å­˜æ”¾äºä»»åŠ¡é˜Ÿåˆ—(updateQueue)ä¸­</span><br><span class="line">// åˆ›å»ºå•å‘é“¾è¡¨ç»“æ„å­˜æ”¾ update, next ç”¨æ¥ä¸²è” update</span><br><span class="line">export function enqueueUpdate&lt;State&gt;(fiber: Fiber, update: Update&lt;State&gt;) &#123;</span><br><span class="line">  // è·å–å½“å‰ Fiber çš„ æ›´æ–°é˜Ÿåˆ—</span><br><span class="line">  const updateQueue = fiber.updateQueue;</span><br><span class="line">  // å¦‚æœæ›´æ–°é˜Ÿåˆ—ä¸å­˜åœ¨ å°±è¿”å› null</span><br><span class="line">  if (updateQueue === null) &#123;</span><br><span class="line">    // ä»…å‘ç”Ÿåœ¨ fiber å·²ç»è¢«å¸è½½</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line">  // è·å–å¾…æ‰§è¡Œçš„ Update ä»»åŠ¡</span><br><span class="line">  // åˆå§‹æ¸²æŸ“æ—¶æ²¡æœ‰å¾…æ‰§è¡Œçš„ä»»åŠ¡</span><br><span class="line">  const sharedQueue = updateQueue.shared;</span><br><span class="line">  const pending = sharedQueue.pending;</span><br><span class="line">  // å¦‚æœæ²¡æœ‰å¾…æ‰§è¡Œçš„ Update ä»»åŠ¡</span><br><span class="line">  if (pending === null) &#123;</span><br><span class="line">    // è¿™æ˜¯ç¬¬ä¸€æ¬¡æ›´æ–°, åˆ›å»ºä¸€ä¸ªå¾ªç¯åˆ—è¡¨.</span><br><span class="line">    update.next = update;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    update.next = pending.next;</span><br><span class="line">    pending.next = update;</span><br><span class="line">  &#125;</span><br><span class="line">  // å°† Update ä»»åŠ¡å­˜å‚¨åœ¨ pending å±æ€§ä¸­</span><br><span class="line">  sharedQueue.pending = update;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-1-7-scheduleUpdateOnFiber"><a href="#5-1-7-scheduleUpdateOnFiber" class="headerlink" title="5.1.7 scheduleUpdateOnFiber"></a>5.1.7 scheduleUpdateOnFiber</h4><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * åˆ¤æ–­ä»»åŠ¡æ˜¯å¦ä¸ºåŒæ­¥ è°ƒç”¨åŒæ­¥ä»»åŠ¡å…¥å£</span><br><span class="line"> */</span><br><span class="line">export function scheduleUpdateOnFiber(</span><br><span class="line">  // rootFiber</span><br><span class="line">  fiber: Fiber,</span><br><span class="line">  expirationTime: ExpirationTime,</span><br><span class="line">) &#123;</span><br><span class="line">  /**</span><br><span class="line">   * fiber: åˆå§‹åŒ–æ¸²æŸ“æ—¶ä¸º rootFiber, å³ &lt;div id=&quot;root&quot;&gt;&lt;/div&gt; å¯¹åº”çš„ Fiber å¯¹è±¡</span><br><span class="line">   * expirationTime: ä»»åŠ¡è¿‡æœŸæ—¶é—´ =&gt;1073741823</span><br><span class="line">   */</span><br><span class="line">  /**</span><br><span class="line">   * åˆ¤æ–­æ˜¯å¦æ˜¯æ— é™å¾ªç¯çš„ update å¦‚æœæ˜¯å°±æŠ¥é”™</span><br><span class="line">   * åœ¨ componentWillUpdate æˆ–è€… componentDidUpdate ç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¸­é‡å¤è°ƒç”¨</span><br><span class="line">   * setState æ–¹æ³•æ—¶, å¯èƒ½ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µ, React é™åˆ¶äº†åµŒå¥—æ›´æ–°çš„æ•°é‡ä»¥é˜²æ­¢æ— é™å¾ªç¯</span><br><span class="line">   * é™åˆ¶çš„åµŒå¥—æ›´æ–°æ•°é‡ä¸º 50, å¯é€šè¿‡ NESTED_UPDATE_LIMIT å…¨å±€å˜é‡è·å–</span><br><span class="line">   */</span><br><span class="line">  checkForNestedUpdates();</span><br><span class="line">  // åˆ¤æ–­ä»»åŠ¡æ˜¯å¦æ˜¯åŒæ­¥ä»»åŠ¡ Syncçš„å€¼ä¸º: 1073741823</span><br><span class="line">  if (expirationTime === Sync) &#123;</span><br><span class="line">    if (</span><br><span class="line">      // æ£€æŸ¥æ˜¯å¦å¤„äºéæ‰¹é‡æ›´æ–°æ¨¡å¼</span><br><span class="line">      (executionContext &amp; LegacyUnbatchedContext) !== NoContext &amp;&amp;</span><br><span class="line">      // æ£€æŸ¥æ˜¯å¦æ²¡æœ‰å¤„äºæ­£åœ¨è¿›è¡Œæ¸²æŸ“çš„ä»»åŠ¡</span><br><span class="line">      (executionContext &amp; (RenderContext | CommitContext)) === NoContext</span><br><span class="line">    ) &#123;</span><br><span class="line">      // åŒæ­¥ä»»åŠ¡å…¥å£ç‚¹</span><br><span class="line">      performSyncWorkOnRoot(root);</span><br><span class="line">    &#125;</span><br><span class="line">  // å¿½ç•¥äº†ä¸€äº›åˆå§‹åŒ–æ¸²æŸ“ä¸ä¼šå¾—åˆ°æ‰§è¡Œçš„ä»£ç </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-1-8-æ„å»º-Fiber-å¯¹è±¡"><a href="#5-1-8-æ„å»º-Fiber-å¯¹è±¡" class="headerlink" title="5.1.8 æ„å»º Fiber å¯¹è±¡"></a>5.1.8 æ„å»º Fiber å¯¹è±¡</h4><h5 id="5-1-8-1-performSyncWorkOnRoot"><a href="#5-1-8-1-performSyncWorkOnRoot" class="headerlink" title="5.1.8.1 performSyncWorkOnRoot"></a>5.1.8.1 performSyncWorkOnRoot</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">// è¿›å…¥ render é˜¶æ®µ, æ„å»º workInProgress Fiber æ ‘</span><br><span class="line">function performSyncWorkOnRoot(root) &#123;</span><br><span class="line">  // å‚æ•° root ä¸º fiberRoot å¯¹è±¡</span><br><span class="line">  // æ£€æŸ¥æ˜¯å¦æœ‰è¿‡æœŸçš„ä»»åŠ¡</span><br><span class="line">  // å¦‚æœæ²¡æœ‰è¿‡æœŸçš„ä»»åŠ¡ å€¼ä¸º 0</span><br><span class="line">  // åˆå§‹åŒ–æ¸²æŸ“æ²¡æœ‰è¿‡æœŸçš„ä»»åŠ¡å¾…æ‰§è¡Œ</span><br><span class="line">  const lastExpiredTime = root.lastExpiredTime;</span><br><span class="line">  // NoWork å€¼ä¸º 0</span><br><span class="line">  // å¦‚æœæœ‰è¿‡æœŸçš„ä»»åŠ¡ å°†è¿‡æœŸæ—¶é—´è®¾ç½®ä¸º lastExpiredTime å¦åˆ™å°†è¿‡æœŸæ—¶é—´è®¾ç½®ä¸º Sync</span><br><span class="line">  // åˆå§‹æ¸²æŸ“è¿‡æœŸæ—¶é—´è¢«è®¾ç½®æˆäº† Sync</span><br><span class="line">  const expirationTime = lastExpiredTime !== NoWork ? lastExpiredTime : Sync;</span><br><span class="line"></span><br><span class="line">  // å¦‚æœ root å’Œ workInProgressRoot ä¸ç›¸ç­‰</span><br><span class="line">  // è¯´æ˜ workInProgressRoot ä¸å­˜åœ¨, è¯´æ˜è¿˜æ²¡æœ‰æ„å»º workInProgress Fiber æ ‘</span><br><span class="line">  // workInProgressRoot ä¸ºå…¨å±€å˜é‡ é»˜è®¤å€¼ä¸º null, åˆå§‹æ¸²æŸ“æ—¶å€¼ä¸º null</span><br><span class="line">  // expirationTime =&gt; 1073741823</span><br><span class="line">  // renderExpirationTime =&gt; 0</span><br><span class="line">  // true</span><br><span class="line">  if (root !== workInProgressRoot || expirationTime !== renderExpirationTime) &#123;</span><br><span class="line">    // æ„å»º workInProgressFiber æ ‘åŠrootFiber</span><br><span class="line">    prepareFreshStack(root, expirationTime);</span><br><span class="line">  &#125;</span><br><span class="line">  // workInProgress å¦‚æœä¸ä¸º null</span><br><span class="line">  if (workInProgress !== null) &#123;</span><br><span class="line">    do &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">        // ä»¥åŒæ­¥çš„æ–¹å¼å¼€å§‹æ„å»º Fiber å¯¹è±¡</span><br><span class="line">        workLoopSync();</span><br><span class="line">        // è·³å‡º while å¾ªç¯</span><br><span class="line">        break;</span><br><span class="line">      &#125; catch (thrownValue) &#123;</span><br><span class="line">        handleError(root, thrownValue);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; while (true);</span><br><span class="line">    </span><br><span class="line">    if (workInProgress !== null) &#123;</span><br><span class="line">      // è¿™æ˜¯ä¸€ä¸ªåŒæ­¥æ¸²æŸ“, æ‰€ä»¥æˆ‘ä»¬åº”è¯¥å®Œæˆæ•´æ£µæ ‘.</span><br><span class="line">      // æ— æ³•æäº¤ä¸å®Œæ•´çš„ root, æ­¤é”™è¯¯å¯èƒ½æ˜¯ç”±äºReactä¸­çš„é”™è¯¯æ‰€è‡´. è¯·æå‡ºé—®é¢˜.</span><br><span class="line">      invariant(</span><br><span class="line">        false,</span><br><span class="line">        &#x27;Cannot commit an incomplete root. This error is likely caused by a &#x27; +</span><br><span class="line">          &#x27;bug in React. Please file an issue.&#x27;,</span><br><span class="line">      );</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      // å°†æ„å»ºå¥½çš„æ–° Fiber å¯¹è±¡å­˜å‚¨åœ¨ finishedWork å±æ€§ä¸­</span><br><span class="line">      // æäº¤é˜¶æ®µä½¿ç”¨</span><br><span class="line">      root.finishedWork = (root.current.alternate: any);</span><br><span class="line">      root.finishedExpirationTime = expirationTime;</span><br><span class="line">      // ç»“æŸ render é˜¶æ®µ</span><br><span class="line">      // è¿›å…¥ commit é˜¶æ®µ</span><br><span class="line">      finishSyncRender(root);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-1-8-2-prepareFreshStack"><a href="#5-1-8-2-prepareFreshStack" class="headerlink" title="5.1.8.2 prepareFreshStack"></a>5.1.8.2 prepareFreshStack</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * æ ¹æ® currentFiber æ ‘ä¸­çš„ rootFiber</span><br><span class="line"> * æ„å»º workInProgressFiber æ ‘ä¸­çš„ rootFiber</span><br><span class="line"> */</span><br><span class="line">function prepareFreshStack(root, expirationTime) &#123;</span><br><span class="line">  // ä¸º FiberRoot å¯¹è±¡æ·»åŠ  finishedWork å±æ€§</span><br><span class="line">  // finishedWork è¡¨ç¤º render é˜¶æ®µæ‰§è¡Œå®Œæˆåæ„å»ºçš„å¾…æäº¤çš„ Fiber å¯¹è±¡</span><br><span class="line">  root.finishedWork = null;</span><br><span class="line">  // åˆå§‹åŒ– finishedExpirationTime å€¼ä¸º 0</span><br><span class="line">  root.finishedExpirationTime = NoWork;</span><br><span class="line"></span><br><span class="line">  // å»ºæ„ workInProgress Fiber æ ‘çš„ Fiber å¯¹è±¡</span><br><span class="line">  workInProgressRoot = root;</span><br><span class="line">  // æ„å»º workInProgress Fiber æ ‘ä¸­çš„ rootFiber</span><br><span class="line">  workInProgress = createWorkInProgress(root.current, null);</span><br><span class="line">  renderExpirationTime = expirationTime;</span><br><span class="line">  workInProgressRootExitStatus = RootIncomplete;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-1-8-3-createWorkInProgress"><a href="#5-1-8-3-createWorkInProgress" class="headerlink" title="5.1.8.3 createWorkInProgress"></a>5.1.8.3 createWorkInProgress</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiber.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">// æ„å»º workInProgress Fiber æ ‘ä¸­çš„ rootFiber</span><br><span class="line">// æ„å»ºå®Œæˆåä¼šæ›¿æ¢ current fiber</span><br><span class="line">// åˆå§‹æ¸²æŸ“ pendingProps ä¸º null</span><br><span class="line">export function createWorkInProgress(current: Fiber, pendingProps: any): Fiber &#123;</span><br><span class="line">  // current: current Fiber ä¸­çš„ rootFiber</span><br><span class="line">  // è·å– current Fiber ä¸­å¯¹åº”çš„ workInProgress Fiber</span><br><span class="line">  let workInProgress = current.alternate;</span><br><span class="line">  // å¦‚æœ workInProgress ä¸å­˜åœ¨</span><br><span class="line">  if (workInProgress === null) &#123;</span><br><span class="line">    // åˆ›å»º fiber å¯¹è±¡</span><br><span class="line">    workInProgress = createFiber(</span><br><span class="line">      current.tag,</span><br><span class="line">      pendingProps,</span><br><span class="line">      current.key,</span><br><span class="line">      current.mode,</span><br><span class="line">    );</span><br><span class="line">    // å±æ€§å¤ç”¨</span><br><span class="line">    workInProgress.elementType = current.elementType;</span><br><span class="line">    workInProgress.type = current.type;</span><br><span class="line">    workInProgress.stateNode = current.stateNode;</span><br><span class="line">    // ä½¿ç”¨ alternate å­˜å‚¨ current</span><br><span class="line">    workInProgress.alternate = current;</span><br><span class="line">    // ä½¿ç”¨ alternate å­˜å‚¨ workInProgress</span><br><span class="line">    current.alternate = workInProgress;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  workInProgress.childExpirationTime = current.childExpirationTime;</span><br><span class="line">  workInProgress.expirationTime = current.expirationTime;</span><br><span class="line">  workInProgress.child = current.child;</span><br><span class="line">  workInProgress.memoizedProps = current.memoizedProps;</span><br><span class="line">  workInProgress.memoizedState = current.memoizedState;</span><br><span class="line">  workInProgress.updateQueue = current.updateQueue;</span><br><span class="line">  workInProgress.sibling = current.sibling;</span><br><span class="line">  workInProgress.index = current.index;</span><br><span class="line">  workInProgress.ref = current.ref;</span><br><span class="line">	</span><br><span class="line">  // è¿”å›åˆ›å»ºå¥½çš„ workInProgress Fiber å¯¹è±¡</span><br><span class="line">  return workInProgress;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-1-8-4-workLoopSync"><a href="#5-1-8-4-workLoopSync" class="headerlink" title="5.1.8.4 workLoopSync"></a>5.1.8.4 workLoopSync</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// ä»¥åŒæ­¥çš„æ–¹å¼æ„å»º workInProgress Fiber å¯¹è±¡</span><br><span class="line">function workLoopSync() &#123;</span><br><span class="line">  // workInProgress æ˜¯ä¸€ä¸ª fiber å¯¹è±¡</span><br><span class="line">  // å®ƒçš„å€¼ä¸ä¸º null æ„å‘³ç€è¯¥ fiber å¯¹è±¡ä¸Šä»ç„¶æœ‰æ›´æ–°è¦æ‰§è¡Œ</span><br><span class="line">  while (workInProgress !== null) &#123;</span><br><span class="line">    workInProgress = performUnitOfWork(workInProgress);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-1-8-5-performUnitOfWork"><a href="#5-1-8-5-performUnitOfWork" class="headerlink" title="5.1.8.5 performUnitOfWork"></a>5.1.8.5 performUnitOfWork</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">function performUnitOfWork(unitOfWork: Fiber): Fiber | null &#123;</span><br><span class="line">  // unitOfWork =&gt; workInProgress Fiber æ ‘ä¸­çš„ rootFiber</span><br><span class="line">  // current =&gt; currentFiber æ ‘ä¸­çš„ rootFiber</span><br><span class="line">  const current = unitOfWork.alternate;</span><br><span class="line">  // å­˜å‚¨ä¸‹ä¸€ä¸ªè¦æ„å»ºçš„å­çº§ Fiber å¯¹è±¡</span><br><span class="line">  let next;</span><br><span class="line">  // false</span><br><span class="line">  if (enableProfilerTimer &amp;&amp; (unitOfWork.mode &amp; ProfileMode) !== NoMode) &#123;</span><br><span class="line">    // åˆå§‹æ¸²æŸ“ ä¸æ‰§è¡Œ</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // beginWork: ä»çˆ¶åˆ°å­, æ„å»º Fiber èŠ‚ç‚¹å¯¹è±¡</span><br><span class="line">    // è¿”å›å€¼ next ä¸ºå½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹</span><br><span class="line">    next = beginWork(current, unitOfWork, renderExpirationTime);</span><br><span class="line">  &#125;</span><br><span class="line">  // ä¸ºæ—§çš„ props å±æ€§èµ‹å€¼</span><br><span class="line">  // æ­¤æ¬¡æ›´æ–°å pendingProps å˜ä¸º memoizedProps</span><br><span class="line">  unitOfWork.memoizedProps = unitOfWork.pendingProps;</span><br><span class="line">  // å¦‚æœå­èŠ‚ç‚¹ä¸å­˜åœ¨è¯´æ˜å½“å‰èŠ‚ç‚¹å‘ä¸‹éå†å­èŠ‚ç‚¹å·²ç»åˆ°åº•äº†</span><br><span class="line">  // ç»§ç»­å‘ä¸Šè¿”å› é‡åˆ°å…„å¼ŸèŠ‚ç‚¹ æ„å»ºå…„å¼ŸèŠ‚ç‚¹çš„å­ Fiber å¯¹è±¡ ç›´åˆ°è¿”å›åˆ°æ ¹ Fiber å¯¹è±¡</span><br><span class="line">  if (next === null) &#123;</span><br><span class="line">    // ä»å­åˆ°çˆ¶, æ„å»ºå…¶ä½™èŠ‚ç‚¹ Fiber å¯¹è±¡</span><br><span class="line">    next = completeUnitOfWork(unitOfWork);</span><br><span class="line">  &#125;</span><br><span class="line">  return next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-1-8-6-beginWork"><a href="#5-1-8-6-beginWork" class="headerlink" title="5.1.8.6 beginWork"></a>5.1.8.6 beginWork</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberBeginWork.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">// ä»çˆ¶åˆ°å­, æ„å»º Fiber èŠ‚ç‚¹å¯¹è±¡</span><br><span class="line">function beginWork(</span><br><span class="line">  current: Fiber | null,</span><br><span class="line">  workInProgress: Fiber,</span><br><span class="line">  renderExpirationTime: ExpirationTime,</span><br><span class="line">): Fiber | null &#123;</span><br><span class="line">  // NoWork å¸¸é‡ å€¼ä¸º0 æ¸…ç©ºè¿‡æœŸæ—¶é—´</span><br><span class="line">  workInProgress.expirationTime = NoWork;</span><br><span class="line">  // æ ¹æ®å½“å‰ Fiber çš„ç±»å‹å†³å®šå¦‚ä½•æ„å»ºèµ·å­çº§ Fiber å¯¹è±¡</span><br><span class="line">  // æ–‡ä»¶ä½ç½®: shared/ReactWorkTags.js</span><br><span class="line">  switch (workInProgress.tag) &#123;</span><br><span class="line">    // 2</span><br><span class="line">    // å‡½æ•°å‹ç»„ä»¶åœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“ç»„ä»¶æ—¶ä½¿ç”¨</span><br><span class="line">    case IndeterminateComponent: &#123;</span><br><span class="line">      return mountIndeterminateComponent(</span><br><span class="line">        // æ—§ Fiber</span><br><span class="line">        current,</span><br><span class="line">        // æ–° Fiber</span><br><span class="line">        workInProgress,</span><br><span class="line">        // æ–° Fiber çš„ type å€¼ åˆå§‹æ¸²æŸ“æ—¶æ˜¯Appç»„ä»¶å‡½æ•°</span><br><span class="line">        workInProgress.type,</span><br><span class="line">        // åŒæ­¥ æ•´æ•°æœ€å¤§å€¼ 1073741823</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    // 0</span><br><span class="line">    case FunctionComponent: &#123;</span><br><span class="line">      const Component = workInProgress.type;</span><br><span class="line">      const unresolvedProps = workInProgress.pendingProps;</span><br><span class="line">      const resolvedProps =</span><br><span class="line">        workInProgress.elementType === Component</span><br><span class="line">          ? unresolvedProps</span><br><span class="line">          : resolveDefaultProps(Component, unresolvedProps);</span><br><span class="line">      return updateFunctionComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        Component,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    // 1</span><br><span class="line">    case ClassComponent: &#123;</span><br><span class="line">      const Component = workInProgress.type;</span><br><span class="line">      const unresolvedProps = workInProgress.pendingProps;</span><br><span class="line">      const resolvedProps =</span><br><span class="line">        workInProgress.elementType === Component</span><br><span class="line">          ? unresolvedProps</span><br><span class="line">          : resolveDefaultProps(Component, unresolvedProps);</span><br><span class="line">      return updateClassComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        Component,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    // 3</span><br><span class="line">    case HostRoot:</span><br><span class="line">      return updateHostRoot(current, workInProgress, renderExpirationTime);</span><br><span class="line">    // 5</span><br><span class="line">    case HostComponent:</span><br><span class="line">      return updateHostComponent(current, workInProgress, renderExpirationTime);</span><br><span class="line">    // 6</span><br><span class="line">    case HostText:</span><br><span class="line">      return updateHostText(current, workInProgress);</span><br><span class="line">  // ç»„ä»¶ç±»å‹æœªçŸ¥ æŠ¥é”™</span><br><span class="line">  invariant(</span><br><span class="line">    false,</span><br><span class="line">    &#x27;Unknown unit of work tag (%s). This error is likely caused by a bug in &#x27; +</span><br><span class="line">      &#x27;React. Please file an issue.&#x27;,</span><br><span class="line">    workInProgress.tag,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-1-8-7-updateHostRoot"><a href="#5-1-8-7-updateHostRoot" class="headerlink" title="5.1.8.7 updateHostRoot"></a>5.1.8.7 updateHostRoot</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberBeginWork.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">// HostRoot =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt; å¯¹åº”çš„ Fiber å¯¹è±¡</span><br><span class="line">// æ‰¾å‡º HostRoot çš„å­ ReactElement å¹¶ä¸ºå…¶æ„å»º Fiber å¯¹è±¡</span><br><span class="line">function updateHostRoot(current, workInProgress, renderExpirationTime) &#123;</span><br><span class="line">  // è·å–æ›´æ–°é˜Ÿåˆ—</span><br><span class="line">  const updateQueue = workInProgress.updateQueue;</span><br><span class="line">  // è·å–æ–°çš„ props å¯¹è±¡ null</span><br><span class="line">  const nextProps = workInProgress.pendingProps;</span><br><span class="line">  // è·å–ä¸Šä¸€æ¬¡æ¸²æŸ“ä½¿ç”¨çš„ state null</span><br><span class="line">  const prevState = workInProgress.memoizedState;</span><br><span class="line">  // è·å–ä¸Šä¸€æ¬¡æ¸²æŸ“ä½¿ç”¨çš„ children null</span><br><span class="line">  const prevChildren = prevState !== null ? prevState.element : null;</span><br><span class="line">  // æµ…å¤åˆ¶æ›´æ–°é˜Ÿåˆ—, é˜²æ­¢å¼•ç”¨å±æ€§äº’ç›¸å½±å“</span><br><span class="line">  // workInProgress.updateQueue æµ…æ‹·è´ current.updateQueue</span><br><span class="line">  cloneUpdateQueue(current, workInProgress);</span><br><span class="line">  // è·å– updateQueue.payload å¹¶èµ‹å€¼åˆ° workInProgress.memoizedState</span><br><span class="line">  // è¦æ›´æ–°çš„å†…å®¹å°±æ˜¯ element å°±æ˜¯ rootFiber çš„å­å…ƒç´ </span><br><span class="line">  processUpdateQueue(workInProgress, nextProps, null, renderExpirationTime);</span><br><span class="line">  // è·å– element æ‰€åœ¨å¯¹è±¡</span><br><span class="line">  const nextState = workInProgress.memoizedState;</span><br><span class="line">  // ä»å¯¹è±¡ä¸­è·å– element</span><br><span class="line">  const nextChildren = nextState.element;</span><br><span class="line">  // è·å– fiberRoot å¯¹è±¡</span><br><span class="line">  const root: FiberRoot = workInProgress.stateNode;</span><br><span class="line">  // æœåŠ¡å™¨ç«¯æ¸²æŸ“èµ° if</span><br><span class="line">  if (root.hydrate &amp;&amp; enterHydrationState(workInProgress)) &#123;</span><br><span class="line">    // å¿½ç•¥</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // å®¢æˆ·ç«¯æ¸²æŸ“èµ° else</span><br><span class="line">    // æ„å»ºå­èŠ‚ç‚¹ fiber å¯¹è±¡</span><br><span class="line">    reconcileChildren(</span><br><span class="line">      current,</span><br><span class="line">      workInProgress,</span><br><span class="line">      nextChildren,</span><br><span class="line">      renderExpirationTime,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  // è¿”å›å­èŠ‚ç‚¹ fiber å¯¹è±¡</span><br><span class="line">  return workInProgress.child;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-1-8-8-reconcileChildren"><a href="#5-1-8-8-reconcileChildren" class="headerlink" title="5.1.8.8 reconcileChildren"></a>5.1.8.8 reconcileChildren</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberBeginWork.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">export function reconcileChildren(</span><br><span class="line">  // æ—§ Fiber</span><br><span class="line">  current: Fiber | null,</span><br><span class="line">  // çˆ¶çº§ Fiber</span><br><span class="line">  workInProgress: Fiber,</span><br><span class="line">  // å­çº§ vdom å¯¹è±¡</span><br><span class="line">  nextChildren: any,</span><br><span class="line">  // åˆå§‹æ¸²æŸ“ æ•´å‹æœ€å¤§å€¼ ä»£è¡¨åŒæ­¥ä»»åŠ¡</span><br><span class="line">  renderExpirationTime: ExpirationTime,</span><br><span class="line">) &#123;</span><br><span class="line">  /**</span><br><span class="line">   * ä¸ºä»€ä¹ˆè¦ä¼ é€’ current ?</span><br><span class="line">   * å¦‚æœä¸æ˜¯åˆå§‹æ¸²æŸ“çš„æƒ…å†µ, è¦è¿›è¡Œæ–°æ—§ Fiber å¯¹æ¯”</span><br><span class="line">   * åˆå§‹æ¸²æŸ“æ—¶åˆ™ç”¨ä¸åˆ° current</span><br><span class="line">   */</span><br><span class="line">  // å¦‚æœå°± Fiber ä¸º null è¡¨ç¤ºåˆå§‹æ¸²æŸ“</span><br><span class="line">  if (current === null) &#123;</span><br><span class="line">    // ä¸ºå½“å‰æ„å»ºçš„ Fiber å¯¹è±¡æ·»åŠ å­çº§ Fiber å¯¹è±¡</span><br><span class="line">    workInProgress.child = mountChildFibers(</span><br><span class="line">      workInProgress,</span><br><span class="line">      null,</span><br><span class="line">      nextChildren,</span><br><span class="line">      renderExpirationTime,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  // å¿½ç•¥äº† else çš„æƒ…å†µ</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-1-8-9-ChildReconciler"><a href="#5-1-8-9-ChildReconciler" class="headerlink" title="5.1.8.9 ChildReconciler"></a>5.1.8.9 ChildReconciler</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactChildFiber.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * shouldTrackSideEffects æ ‡è¯†, æ˜¯å¦ä¸º Fiber å¯¹è±¡æ·»åŠ  effectTag</span><br><span class="line"> * true æ·»åŠ  false ä¸æ·»åŠ </span><br><span class="line"> * å¯¹äºåˆå§‹æ¸²æŸ“æ¥è¯´, åªæœ‰æ ¹ç»„ä»¶éœ€è¦æ·»åŠ , å…¶ä»–å…ƒç´ ä¸éœ€è¦æ·»åŠ , é˜²æ­¢è¿‡å¤šçš„ DOM æ“ä½œ</span><br><span class="line"> */</span><br><span class="line">// ç”¨äºåˆå§‹æ¸²æŸ“</span><br><span class="line">export const mountChildFibers = ChildReconciler(false);</span><br><span class="line"></span><br><span class="line">function ChildReconciler(shouldTrackSideEffects) &#123;</span><br><span class="line"> </span><br><span class="line">  function placeChild(</span><br><span class="line">    newFiber: Fiber,</span><br><span class="line">    lastPlacedIndex: number,</span><br><span class="line">    newIndex: number,</span><br><span class="line">  ): number &#123;</span><br><span class="line">    newFiber.index = newIndex;</span><br><span class="line">    if (!shouldTrackSideEffects) &#123;</span><br><span class="line">      return lastPlacedIndex;</span><br><span class="line">    &#125;</span><br><span class="line">    // å¿½ç•¥äº†ä¸€éƒ¨åˆ†åˆå§‹åŒ–æ¸²æŸ“ä¸æ‰§è¡Œçš„ä»£ç </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function placeSingleChild(newFiber: Fiber): Fiber &#123;</span><br><span class="line">    // å¦‚æœæ˜¯åˆå§‹æ¸²æŸ“ ä¼šåœ¨æ ¹ç»„ä»¶(App)ä¸Šè®¾ç½® effectTag å±æ€§ä¸º Placement å€¼ä¸º 1</span><br><span class="line">    // å…¶ä»–å­çº§èŠ‚ç‚¹å…·æœ‰é»˜è®¤å€¼ä¸º 0 é˜²æ­¢åœ¨ commit é˜¶æ®µåå¤æ“ä½œçœŸå®DOM</span><br><span class="line">    // åˆå§‹æ¸²æŸ“æ—¶å¦‚æœå½“å‰å¤„ç†çš„æ˜¯æ ¹ç»„ä»¶ true å…¶ä»–ç»„ä»¶ false</span><br><span class="line">    if (shouldTrackSideEffects &amp;&amp; newFiber.alternate === null) &#123;</span><br><span class="line">      // Placement è¡¨ç¤ºæ–°åˆ›å»ºçš„èŠ‚ç‚¹</span><br><span class="line">      newFiber.effectTag = Placement;</span><br><span class="line">    &#125;</span><br><span class="line">    return newFiber;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  // å¤„ç†å­å…ƒç´ æ˜¯æ•°ç»„çš„æƒ…å†µ</span><br><span class="line">  function reconcileChildrenArray(</span><br><span class="line">    // çˆ¶çº§ Fiber</span><br><span class="line">    returnFiber: Fiber,</span><br><span class="line">    currentFirstChild: Fiber | null,</span><br><span class="line">    // å­çº§ vdom æ•°ç»„</span><br><span class="line">    newChildren: Array&lt;*&gt;,</span><br><span class="line">    expirationTime: ExpirationTime,</span><br><span class="line">  ): Fiber | null &#123;</span><br><span class="line">    /**</span><br><span class="line">     * å­˜å‚¨ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ Fiber å¯¹è±¡</span><br><span class="line">     * æ–¹æ³•è¿”å›çš„ä¹Ÿæ˜¯ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ Fiber å¯¹è±¡</span><br><span class="line">     * å› ä¸ºå…¶ä»–å­èŠ‚ç‚¹ Fiber å¯¹è±¡éƒ½å­˜å‚¨åœ¨ä¸Šä¸€ä¸ªå­ Fiber èŠ‚ç‚¹å¯¹è±¡çš„ sibling å±æ€§ä¸­</span><br><span class="line">     */</span><br><span class="line">    let resultingFirstChild: Fiber | null = null;</span><br><span class="line">    // ä¸Šä¸€æ¬¡åˆ›å»ºçš„ Fiber å¯¹è±¡</span><br><span class="line">    let previousNewFiber: Fiber | null = null;</span><br><span class="line">    // åˆå§‹æ¸²æŸ“æ²¡æœ‰æ—§çš„å­çº§ æ‰€ä»¥ä¸º null</span><br><span class="line">    let oldFiber = currentFirstChild;</span><br><span class="line"></span><br><span class="line">    let lastPlacedIndex = 0;</span><br><span class="line">    let newIdx = 0;</span><br><span class="line">    let nextOldFiber = null;</span><br><span class="line"></span><br><span class="line">    // oldFiber ä¸ºç©º è¯´æ˜æ˜¯åˆå§‹æ¸²æŸ“</span><br><span class="line">    if (oldFiber === null) &#123;</span><br><span class="line">      // éå†å­ vdom å¯¹è±¡</span><br><span class="line">      for (; newIdx &lt; newChildren.length; newIdx++) &#123;</span><br><span class="line">        // åˆ›å»ºå­ vdom å¯¹åº”çš„ fiber å¯¹è±¡</span><br><span class="line">        const newFiber = createChild(</span><br><span class="line">          returnFiber,</span><br><span class="line">          newChildren[newIdx],</span><br><span class="line">          expirationTime,</span><br><span class="line">        );</span><br><span class="line">        // å¦‚æœ newFiber ä¸º null</span><br><span class="line">        if (newFiber === null) &#123;</span><br><span class="line">          // è¿›å…¥ä¸‹æ¬¡å¾ªç¯</span><br><span class="line">          continue;</span><br><span class="line">        &#125;</span><br><span class="line">        // åˆå§‹æ¸²æŸ“æ—¶åªä¸º newFiber æ·»åŠ äº† index å±æ€§,</span><br><span class="line">        // å…¶ä»–äº‹æ²¡å¹². lastPlacedIndex è¢«åŸå°ä¸åŠ¨çš„è¿”å›äº†</span><br><span class="line">        lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);</span><br><span class="line">        // ä¸ºå½“å‰èŠ‚ç‚¹è®¾ç½®ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹</span><br><span class="line">        if (previousNewFiber === null) &#123;</span><br><span class="line">          // å­˜å‚¨ç¬¬ä¸€ä¸ªå­ Fiber å‘ç”Ÿåœ¨ç¬¬ä¸€æ¬¡å¾ªç¯æ—¶</span><br><span class="line">          resultingFirstChild = newFiber;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          // ä¸ºèŠ‚ç‚¹è®¾ç½®ä¸‹ä¸€ä¸ªå…„å¼Ÿ Fiber</span><br><span class="line">          previousNewFiber.sibling = newFiber;</span><br><span class="line">        &#125;</span><br><span class="line">        // åœ¨å¾ªç¯çš„è¿‡ç¨‹ä¸­æ›´æ–°ä¸Šä¸€ä¸ªåˆ›å»ºçš„Fiber å¯¹è±¡</span><br><span class="line">        previousNewFiber = newFiber;</span><br><span class="line">      &#125;</span><br><span class="line">      // è¿”å›åˆ›å»ºå¥½çš„å­ Fiber</span><br><span class="line">      // å…¶ä»– Fiber éƒ½ä½œä¸º sibling å­˜åœ¨</span><br><span class="line">      return resultingFirstChild;</span><br><span class="line">    &#125;</span><br><span class="line">    // è¿”å›ç¬¬ä¸€ä¸ªå­å…ƒç´  Fiber å¯¹è±¡</span><br><span class="line">    return resultingFirstChild;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // å¤„ç†å­å…ƒç´ æ˜¯æ–‡æœ¬æˆ–è€…æ•°å€¼çš„æƒ…å†µ</span><br><span class="line">  function reconcileSingleTextNode(</span><br><span class="line">    returnFiber: Fiber,</span><br><span class="line">    currentFirstChild: Fiber | null,</span><br><span class="line">    textContent: string,</span><br><span class="line">    expirationTime: ExpirationTime,</span><br><span class="line">  ): Fiber &#123;</span><br><span class="line">    // åˆå§‹æ¸²æŸ“ä¸æ‰§è¡Œ</span><br><span class="line">    if (currentFirstChild !== null &amp;&amp; currentFirstChild.tag === HostText) &#123;</span><br><span class="line">      // We already have an existing node so let&#x27;s just update it and delete</span><br><span class="line">      // the rest.</span><br><span class="line">      deleteRemainingChildren(returnFiber, currentFirstChild.sibling);</span><br><span class="line">      const existing = useFiber(currentFirstChild, textContent);</span><br><span class="line">      existing.return = returnFiber;</span><br><span class="line">      return existing;</span><br><span class="line">    &#125;</span><br><span class="line">    // ç°æœ‰çš„ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ä¸æ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªå¹¶åˆ é™¤ç°æœ‰çš„.</span><br><span class="line">    // åˆå§‹æ¸²æŸ“ä¸æ‰§è¡Œ</span><br><span class="line">    deleteRemainingChildren(returnFiber, currentFirstChild);</span><br><span class="line">    // æ ¹æ®æ–‡æœ¬åˆ›å»º Fiber å¯¹è±¡</span><br><span class="line">    const created = createFiberFromText(</span><br><span class="line">      textContent,</span><br><span class="line">      returnFiber.mode,</span><br><span class="line">      expirationTime,</span><br><span class="line">    );</span><br><span class="line">    // è®¾ç½®çˆ¶ Fiber å¯¹è±¡</span><br><span class="line">    created.return = returnFiber;</span><br><span class="line">    // è¿”å›åˆ›å»ºå¥½çš„ Fiber å¯¹è±¡</span><br><span class="line">    return created;</span><br><span class="line">  &#125;</span><br><span class="line">  // å¤„ç†å­å…ƒç´ æ˜¯å•ä¸ªå¯¹è±¡çš„æƒ…å†µ</span><br><span class="line">  function reconcileSingleElement(</span><br><span class="line">    // çˆ¶ Fiber å¯¹è±¡</span><br><span class="line">    returnFiber: Fiber,</span><br><span class="line">    // å¤‡ä»½å­ fiber</span><br><span class="line">    currentFirstChild: Fiber | null,</span><br><span class="line">    // å­ vdom å¯¹è±¡</span><br><span class="line">    element: ReactElement,</span><br><span class="line">    expirationTime: ExpirationTime,</span><br><span class="line">  ): Fiber &#123;</span><br><span class="line">    // æŸ¥çœ‹å­ vdom å¯¹è±¡æ˜¯å¦è¡¨ç¤º fragment</span><br><span class="line">    if (element.type === REACT_FRAGMENT_TYPE) &#123;</span><br><span class="line">      // false</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      // æ ¹æ® React Element åˆ›å»º Fiber å¯¹è±¡</span><br><span class="line">      // è¿”å›åˆ›å»ºå¥½çš„ Fiber å¯¹è±¡</span><br><span class="line">      const created = createFiberFromElement(</span><br><span class="line">        element,</span><br><span class="line">        // ç”¨æ¥è¡¨ç¤ºå½“å‰ç»„ä»¶ä¸‹çš„æ‰€æœ‰å­ç»„ä»¶è¦ç”¨å¤„äºä½•ç§æ¸²æŸ“æ¨¡å¼</span><br><span class="line">        // æ–‡ä»¶ä½ç½®: ./ReactTypeOfMode.js</span><br><span class="line">        // 0    åŒæ­¥æ¸²æŸ“æ¨¡å¼</span><br><span class="line">        // 100  å¼‚æ­¥æ¸²æŸ“æ¨¡å¼</span><br><span class="line">        returnFiber.mode,</span><br><span class="line">        expirationTime,</span><br><span class="line">      );</span><br><span class="line">      // æ·»åŠ  ref å±æ€§ &#123; current: DOM &#125;</span><br><span class="line">      created.ref = coerceRef(returnFiber, currentFirstChild, element);</span><br><span class="line">      // æ·»åŠ çˆ¶çº§ Fiber å¯¹è±¡</span><br><span class="line">      created.return = returnFiber;</span><br><span class="line">      // è¿”å›åˆ›å»ºå¥½çš„å­ Fiber</span><br><span class="line">      return created;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function reconcileChildFibers(</span><br><span class="line">    // çˆ¶ Fiber å¯¹è±¡</span><br><span class="line">    returnFiber: Fiber,</span><br><span class="line">    // æ—§çš„ç¬¬ä¸€ä¸ªå­ Fiber åˆå§‹æ¸²æŸ“ null</span><br><span class="line">    currentFirstChild: Fiber | null,</span><br><span class="line">    // æ–°çš„å­ vdom å¯¹è±¡</span><br><span class="line">    newChild: any,</span><br><span class="line">    // åˆå§‹æ¸²æŸ“ æ•´å‹æœ€å¤§å€¼ ä»£è¡¨åŒæ­¥ä»»åŠ¡</span><br><span class="line">    expirationTime: ExpirationTime,</span><br><span class="line">  ): Fiber | null &#123;</span><br><span class="line">    // è¿™æ˜¯å…¥å£æ–¹æ³•, æ ¹æ® newChild ç±»å‹è¿›è¡Œå¯¹åº”å¤„ç†</span><br><span class="line"></span><br><span class="line">    // åˆ¤æ–­æ–°çš„å­ vdom æ˜¯å¦ä¸ºå ä½ç»„ä»¶ æ¯”å¦‚ &lt;&gt;&lt;/&gt;</span><br><span class="line">    // false</span><br><span class="line">    const isUnkeyedTopLevelFragment =</span><br><span class="line">      typeof newChild === &#x27;object&#x27; &amp;&amp;</span><br><span class="line">      newChild !== null &amp;&amp;</span><br><span class="line">      newChild.type === REACT_FRAGMENT_TYPE &amp;&amp;</span><br><span class="line">      newChild.key === null;</span><br><span class="line"></span><br><span class="line">    // å¦‚æœ newChild ä¸ºå ä½ç¬¦, ä½¿ç”¨ å ä½ç¬¦ç»„ä»¶çš„å­å…ƒç´ ä½œä¸º newChild</span><br><span class="line">    if (isUnkeyedTopLevelFragment) &#123;</span><br><span class="line">      newChild = newChild.props.children;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // æ£€æµ‹ newChild æ˜¯å¦ä¸ºå¯¹è±¡ç±»å‹</span><br><span class="line">    const isObject = typeof newChild === &#x27;object&#x27; &amp;&amp; newChild !== null;</span><br><span class="line"></span><br><span class="line">    // newChild æ˜¯å•ä¸ªå¯¹è±¡çš„æƒ…å†µ</span><br><span class="line">    if (isObject) &#123;</span><br><span class="line">      // åŒ¹é…å­å…ƒç´ çš„ç±»å‹</span><br><span class="line">      switch (newChild.$$typeof) &#123;</span><br><span class="line">        // å­å…ƒç´ ä¸º ReactElement</span><br><span class="line">        case REACT_ELEMENT_TYPE:</span><br><span class="line">          // ä¸º Fiber å¯¹è±¡è®¾ç½® effectTag å±æ€§</span><br><span class="line">          // è¿”å›åˆ›å»ºå¥½çš„å­ Fiber</span><br><span class="line">          return placeSingleChild(</span><br><span class="line">            // å¤„ç†å•ä¸ª React Element çš„æƒ…å†µ</span><br><span class="line">            // å†…éƒ¨ä¼šè°ƒç”¨å…¶ä»–æ–¹æ³•åˆ›å»ºå¯¹åº”çš„ Fiber å¯¹è±¡</span><br><span class="line">            reconcileSingleElement(</span><br><span class="line">              returnFiber,</span><br><span class="line">              currentFirstChild,</span><br><span class="line">              newChild,</span><br><span class="line">              expirationTime,</span><br><span class="line">            ),</span><br><span class="line">          );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">      </span><br><span class="line">    // å¤„ç† children ä¸ºæ–‡æœ¬å’Œæ•°å€¼çš„æƒ…å†µ return &quot;App works&quot;</span><br><span class="line">    if (typeof newChild === &#x27;string&#x27; || typeof newChild === &#x27;number&#x27;) &#123;</span><br><span class="line">      return placeSingleChild(</span><br><span class="line">        reconcileSingleTextNode(</span><br><span class="line">          returnFiber,</span><br><span class="line">          currentFirstChild,</span><br><span class="line">          // å¦‚æœ newChild æ˜¯æ•°å€¼, è½¬æ¢ä¸ºå­—ç¬¦ä¸²</span><br><span class="line">          &#x27;&#x27; + newChild,</span><br><span class="line">          expirationTime,</span><br><span class="line">        ),</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // children æ˜¯æ•°ç»„çš„æƒ…å†µ</span><br><span class="line">    if (isArray(newChild)) &#123;</span><br><span class="line">      // è¿”å›åˆ›å»ºå¥½çš„å­ Fiber</span><br><span class="line">      return reconcileChildrenArray(</span><br><span class="line">        returnFiber,</span><br><span class="line">        currentFirstChild,</span><br><span class="line">        newChild,</span><br><span class="line">        expirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-1-8-10-completeUnitOfWork"><a href="#5-1-8-10-completeUnitOfWork" class="headerlink" title="5.1.8.10 completeUnitOfWork"></a>5.1.8.10 completeUnitOfWork</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> *</span><br><span class="line"> * ä»ä¸‹è‡³ä¸Šç§»åŠ¨åˆ°è¯¥èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹, å¦‚æœä¸€ç›´å¾€ä¸Šæ²¡æœ‰å…„å¼ŸèŠ‚ç‚¹å°±è¿”å›çˆ¶èŠ‚ç‚¹, æœ€ç»ˆä¼šåˆ°è¾¾ root èŠ‚ç‚¹</span><br><span class="line"> * 1. åˆ›å»ºå…¶ä»–èŠ‚ç‚¹çš„ Fiber å¯¹è±¡</span><br><span class="line"> * 2. åˆ›å»ºæ¯ä¸€ä¸ªèŠ‚ç‚¹çš„çœŸå® DOM å¯¹è±¡å¹¶å°†å…¶æ·»åŠ åˆ° stateNode å±æ€§ä¸­</span><br><span class="line"> * 3. æ„å»º effect é“¾è¡¨ç»“æ„</span><br><span class="line"> */</span><br><span class="line">function completeUnitOfWork(unitOfWork: Fiber): Fiber | null &#123;</span><br><span class="line">  // ä¸º workInProgress å…¨å±€å˜é‡é‡æ–°èµ‹å€¼</span><br><span class="line">  workInProgress = unitOfWork;</span><br><span class="line">  do &#123;</span><br><span class="line">    // è·å–å¤‡ä»½èŠ‚ç‚¹</span><br><span class="line">    // åˆå§‹åŒ–æ¸²æŸ“ éæ ¹ Fiber å¯¹è±¡æ²¡æœ‰å¤‡ä»½èŠ‚ç‚¹ æ‰€ä»¥ current ä¸º null</span><br><span class="line">    const current = workInProgress.alternate;</span><br><span class="line">    // çˆ¶çº§ Fiber å¯¹è±¡, éæ ¹ Fiber å¯¹è±¡éƒ½æœ‰çˆ¶çº§</span><br><span class="line">    const returnFiber = workInProgress.return;</span><br><span class="line">    // åˆ¤æ–­ä¼ å…¥çš„ Fiber å¯¹è±¡æ˜¯å¦æ„å»ºå®Œæˆ, ä»»åŠ¡è°ƒåº¦ç›¸å…³</span><br><span class="line">    // &amp; æ˜¯è¡¨ç¤ºä½çš„ä¸è¿ç®—, æŠŠå·¦å³ä¸¤è¾¹çš„æ•°å­—è½¬åŒ–ä¸ºäºŒè¿›åˆ¶</span><br><span class="line">    // ç„¶åæ¯ä¸€ä½åˆ†åˆ«è¿›è¡Œæ¯”è¾ƒ, å¦‚æœç›¸ç­‰å°±ä¸º1, ä¸ç›¸ç­‰å³ä¸º0</span><br><span class="line">    // æ­¤å¤„åº”ç”¨&quot;ä½ä¸&quot;è¿ç®—ç¬¦çš„ç›®çš„æ˜¯&quot;æ¸…é›¶&quot;</span><br><span class="line">    // true</span><br><span class="line">    if ((workInProgress.effectTag &amp; Incomplete) === NoEffect) &#123;</span><br><span class="line">      let next;</span><br><span class="line">      // å¦‚æœä¸èƒ½ä½¿ç”¨åˆ†æå™¨çš„ timer, ç›´æ¥æ‰§è¡Œ completeWork</span><br><span class="line">      // enableProfilerTimer =&gt; true</span><br><span class="line">      // ä½†æ­¤å¤„æ— è®ºæ¡ä»¶æ˜¯å¦æˆç«‹éƒ½ä¼šæ‰§è¡Œ completeWork</span><br><span class="line">      if (</span><br><span class="line">        !enableProfilerTimer ||</span><br><span class="line">        (workInProgress.mode &amp; ProfileMode) === NoMode</span><br><span class="line">      ) &#123;</span><br><span class="line">        // é‡ç‚¹ä»£ç (äºŒ)</span><br><span class="line">        // åˆ›å»ºèŠ‚ç‚¹çœŸå® DOM å¯¹è±¡å¹¶å°†å…¶æ·»åŠ åˆ° stateNode å±æ€§ä¸­</span><br><span class="line">        next = completeWork(current, workInProgress, renderExpirationTime);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        // åˆ›å»ºèŠ‚ç‚¹çœŸå® DOM å¯¹è±¡å¹¶å°†å…¶æ·»åŠ åˆ° stateNode å±æ€§ä¸­</span><br><span class="line">        next = completeWork(current, workInProgress, renderExpirationTime);</span><br><span class="line">      &#125;</span><br><span class="line">      // é‡ç‚¹ä»£ç (ä¸€)</span><br><span class="line">      // å¦‚æœå­çº§å­˜åœ¨</span><br><span class="line">      if (next !== null) &#123;</span><br><span class="line">        // è¿”å›å­çº§ ä¸€ç›´è¿”å›åˆ° workLoopSync</span><br><span class="line">        // å†é‡æ–°æ‰§è¡Œ performUnitOfWork æ„å»ºå­çº§ Fiber èŠ‚ç‚¹å¯¹è±¡</span><br><span class="line">        return next;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // æ„å»º effect é“¾è¡¨ç»“æ„</span><br><span class="line">      // å¦‚æœä¸æ˜¯æ ¹ Fiber å°±æ˜¯ true å¦åˆ™å°±æ˜¯ false</span><br><span class="line">      // å°†å­æ ‘å’Œæ­¤ Fiber çš„æ‰€æœ‰ effect é™„åŠ åˆ°çˆ¶çº§çš„ effect åˆ—è¡¨ä¸­</span><br><span class="line">      if (</span><br><span class="line">        // å¦‚æœçˆ¶ Fiber å­˜åœ¨ å¹¶ä¸”</span><br><span class="line">        returnFiber !== null &amp;&amp;</span><br><span class="line">        // çˆ¶ Fiber å¯¹è±¡ä¸­çš„ effectTag ä¸º 0</span><br><span class="line">        (returnFiber.effectTag &amp; Incomplete) === NoEffect</span><br><span class="line">      ) &#123;</span><br><span class="line">        // å°†å­æ ‘å’Œæ­¤ Fiber çš„æ‰€æœ‰å‰¯ä½œç”¨é™„åŠ åˆ°çˆ¶çº§çš„ effect åˆ—è¡¨ä¸Š</span><br><span class="line"></span><br><span class="line">        // ä»¥ä¸‹ä¸¤ä¸ªåˆ¤æ–­çš„ä½œç”¨æ˜¯æœé›†å­ Fiberçš„ effect åˆ°çˆ¶ Fiber</span><br><span class="line">        if (returnFiber.firstEffect === null) &#123;</span><br><span class="line">          // first</span><br><span class="line">          returnFiber.firstEffect = workInProgress.firstEffect;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (workInProgress.lastEffect !== null) &#123;</span><br><span class="line">          if (returnFiber.lastEffect !== null) &#123;</span><br><span class="line">            // next</span><br><span class="line">            returnFiber.lastEffect.nextEffect = workInProgress.firstEffect;</span><br><span class="line">          &#125;</span><br><span class="line">          // last</span><br><span class="line">          returnFiber.lastEffect = workInProgress.lastEffect;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // è·å–å‰¯ä½œç”¨æ ‡è®°</span><br><span class="line">        // åˆå§‹æ¸²æŸ“æ—¶é™¤[æ ¹ç»„ä»¶]ä»¥å¤–çš„ Fiber, effectTag å€¼éƒ½ä¸º 0, å³ä¸éœ€è¦æ‰§è¡Œä»»ä½•çœŸå®DOMæ“ä½œ</span><br><span class="line">        // æ ¹ç»„ä»¶çš„ effectTag å€¼ä¸º 3, å³éœ€è¦å°†æ­¤èŠ‚ç‚¹å¯¹åº”çš„çœŸå®DOMå¯¹è±¡æ·»åŠ åˆ°é¡µé¢ä¸­</span><br><span class="line">        const effectTag = workInProgress.effectTag;</span><br><span class="line"></span><br><span class="line">        // åˆ›å»º effect åˆ—è¡¨æ—¶è·³è¿‡ NoWork(0) å’Œ PerformedWork(1) æ ‡è®°</span><br><span class="line">        // PerformedWork ç”± React DevTools è¯»å–, ä¸æäº¤</span><br><span class="line">        // åˆå§‹æ¸²æŸ“æ—¶ åªæœ‰éå†åˆ°äº†æ ¹ç»„ä»¶ åˆ¤æ–­æ¡ä»¶æ‰èƒ½æˆç«‹, å°† effect é“¾è¡¨æ·»åŠ åˆ° rootFiber</span><br><span class="line">        // åˆå§‹æ¸²æŸ“ FiberRoot å¯¹è±¡ä¸­çš„ firstEffect å’Œ lastEffect éƒ½æ˜¯ App ç»„ä»¶</span><br><span class="line">        // å› ä¸ºå½“æ‰€æœ‰èŠ‚ç‚¹åœ¨å†…å­˜ä¸­æ„å»ºå®Œæˆå, åªéœ€è¦ä¸€æ¬¡å°†æ‰€æœ‰ DOM æ·»åŠ åˆ°é¡µé¢ä¸­</span><br><span class="line">        if (effectTag &gt; PerformedWork) &#123;</span><br><span class="line">          // false</span><br><span class="line">          if (returnFiber.lastEffect !== null) &#123;</span><br><span class="line">            returnFiber.lastEffect.nextEffect = workInProgress;</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            // ä¸º fiberRoot æ·»åŠ  firstEffect</span><br><span class="line">            returnFiber.firstEffect = workInProgress;</span><br><span class="line">          &#125;</span><br><span class="line">          // ä¸º fiberRoot æ·»åŠ  lastEffect</span><br><span class="line">          returnFiber.lastEffect = workInProgress;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">    	// å¿½ç•¥äº†åˆå§‹æ¸²æŸ“ä¸æ‰§è¡Œçš„ä»£ç       </span><br><span class="line">    &#125;</span><br><span class="line">    // è·å–ä¸‹ä¸€ä¸ªåŒçº§ Fiber å¯¹è±¡</span><br><span class="line">    const siblingFiber = workInProgress.sibling;</span><br><span class="line">    // å¦‚æœä¸‹ä¸€ä¸ªåŒçº§ Fiber å¯¹è±¡å­˜åœ¨</span><br><span class="line">    if (siblingFiber !== null) &#123;</span><br><span class="line">      // è¿”å›ä¸‹ä¸€ä¸ªåŒçº§ Fiber å¯¹è±¡</span><br><span class="line">      return siblingFiber;</span><br><span class="line">    &#125;</span><br><span class="line">    // å¦åˆ™é€€å›çˆ¶çº§</span><br><span class="line">    workInProgress = returnFiber;</span><br><span class="line">  &#125; while (workInProgress !== null);</span><br><span class="line"></span><br><span class="line">  // å½“æ‰§è¡Œåˆ°è¿™é‡Œçš„æ—¶å€™, è¯´æ˜éå†åˆ°äº† root èŠ‚ç‚¹, å·²å®Œæˆéå†</span><br><span class="line">  // æ›´æ–° workInProgressRootExitStatus çš„çŠ¶æ€ä¸º å·²å®Œæˆ</span><br><span class="line">  if (workInProgressRootExitStatus === RootIncomplete) &#123;</span><br><span class="line">    workInProgressRootExitStatus = RootCompleted;</span><br><span class="line">  &#125;</span><br><span class="line">  return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-1-8-11-completeWork"><a href="#5-1-8-11-completeWork" class="headerlink" title="5.1.8.11 completeWork"></a>5.1.8.11 completeWork</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberCompleteWork.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">function completeWork(</span><br><span class="line">  current: Fiber | null,</span><br><span class="line">  workInProgress: Fiber,</span><br><span class="line">  renderExpirationTime: ExpirationTime,</span><br><span class="line">): Fiber | null &#123;</span><br><span class="line">  // è·å–å¾…æ›´æ–° props</span><br><span class="line">  const newProps = workInProgress.pendingProps;</span><br><span class="line">  switch (workInProgress.tag) &#123;</span><br><span class="line">    // 0</span><br><span class="line">    case FunctionComponent:</span><br><span class="line">      return null;</span><br><span class="line">    // 3</span><br><span class="line">    case HostRoot: &#123;</span><br><span class="line">      updateHostContainer(workInProgress);</span><br><span class="line">      return null;</span><br><span class="line">    &#125;</span><br><span class="line">    // 5</span><br><span class="line">    case HostComponent: &#123;</span><br><span class="line">      // è·å– rootDOM èŠ‚ç‚¹ &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span><br><span class="line">      const rootContainerInstance = getRootHostContainer();</span><br><span class="line">      // èŠ‚ç‚¹çš„å…·ä½“çš„ç±»å‹ div span ...</span><br><span class="line">      const type = workInProgress.type;</span><br><span class="line">      // false current = null</span><br><span class="line">      if (current !== null &amp;&amp; workInProgress.stateNode != null) &#123;</span><br><span class="line">       // åˆå§‹æ¸²æŸ“ä¸æ‰§è¡Œ</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">				// false</span><br><span class="line">        if (wasHydrated) &#123;</span><br><span class="line">         // åˆå§‹æ¸²æŸ“ä¸æ‰§è¡Œ</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          // åˆ›å»ºèŠ‚ç‚¹å®ä¾‹å¯¹è±¡ &lt;div&gt;&lt;/div&gt; &lt;span&gt;&lt;/span&gt;</span><br><span class="line">          let instance = createInstance(</span><br><span class="line">            type,</span><br><span class="line">            newProps,</span><br><span class="line">            rootContainerInstance,</span><br><span class="line">            currentHostContext,</span><br><span class="line">            workInProgress,</span><br><span class="line">          );</span><br><span class="line">          /**</span><br><span class="line">           * å°†æ‰€æœ‰çš„å­çº§è¿½åŠ åˆ°çˆ¶çº§ä¸­</span><br><span class="line">           * instance ä¸ºçˆ¶çº§</span><br><span class="line">           * workInProgress.child ä¸ºå­çº§</span><br><span class="line">           */</span><br><span class="line">          appendAllChildren(instance, workInProgress, false, false);</span><br><span class="line">          // ä¸º Fiber å¯¹è±¡æ·»åŠ  stateNode å±æ€§</span><br><span class="line">          workInProgress.stateNode = instance;</span><br><span class="line">        &#125;</span><br><span class="line">        // å¤„ç† ref DOM å¼•ç”¨</span><br><span class="line">        if (workInProgress.ref !== null) &#123;</span><br><span class="line">          markRef(workInProgress);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      return null;</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-1-8-12-appendAllChildren"><a href="#5-1-8-12-appendAllChildren" class="headerlink" title="5.1.8.12 appendAllChildren"></a>5.1.8.12 appendAllChildren</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberCompleteWork.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">appendAllChildren = function (</span><br><span class="line">    parent: Instance,</span><br><span class="line">    workInProgress: Fiber,</span><br><span class="line">    needsVisibilityToggle: boolean,</span><br><span class="line">    isHidden: boolean,</span><br><span class="line">  ) &#123;</span><br><span class="line">    // è·å–å­çº§</span><br><span class="line">    let node = workInProgress.child;</span><br><span class="line">    // å¦‚æœå­çº§ä¸ä¸ºç©º æ‰§è¡Œå¾ªç¯</span><br><span class="line">    while (node !== null) &#123;</span><br><span class="line">      // å¦‚æœ node æ˜¯æ™®é€š ReactElement æˆ–è€…ä¸ºæ–‡æœ¬</span><br><span class="line">      if (node.tag === HostComponent || node.tag === HostText) &#123;</span><br><span class="line">        // å°†å­çº§è¿½åŠ åˆ°çˆ¶çº§ä¸­</span><br><span class="line">        appendInitialChild(parent, node.stateNode);</span><br><span class="line">      &#125; else if (node.child !== null) &#123;</span><br><span class="line">        // å¦‚æœ node ä¸æ˜¯æ™®é€š ReactElement åˆä¸æ˜¯æ–‡æœ¬</span><br><span class="line">        // å°† node è§†ä¸ºç»„ä»¶, ç»„ä»¶æœ¬èº«ä¸èƒ½è½¬æ¢ä¸ºçœŸå® DOM å…ƒç´ </span><br><span class="line">        // è·å–åˆ°ç»„ä»¶çš„ç¬¬ä¸€ä¸ªå­å…ƒç´ , ç»§ç»­æ‰§è¡Œå¾ªç¯</span><br><span class="line">        node.child.return = node;</span><br><span class="line">        node = node.child;</span><br><span class="line">        continue;</span><br><span class="line">      &#125;</span><br><span class="line">      // å¦‚æœ node å’Œ workInProgress æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹</span><br><span class="line">      // è¯´æ˜ node å·²ç»é€€å›åˆ°çˆ¶çº§ ç»ˆæ­¢å¾ªç¯</span><br><span class="line">      // è¯´æ˜æ­¤æ—¶æ‰€æœ‰å­çº§éƒ½å·²ç»è¿½åŠ åˆ°çˆ¶çº§ä¸­äº†</span><br><span class="line">      if (node === workInProgress) &#123;</span><br><span class="line">        return;</span><br><span class="line">      &#125;</span><br><span class="line">      // å¤„ç†å­çº§èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹</span><br><span class="line">      while (node.sibling === null) &#123;</span><br><span class="line">        // å¦‚æœèŠ‚ç‚¹æ²¡æœ‰çˆ¶çº§æˆ–è€…èŠ‚ç‚¹çš„çˆ¶çº§æ˜¯è‡ªå·±, é€€å‡ºå¾ªç¯</span><br><span class="line">        // è¯´æ˜æ­¤æ—¶æ‰€æœ‰å­çº§éƒ½å·²ç»è¿½åŠ åˆ°çˆ¶çº§ä¸­äº†</span><br><span class="line">        if (node.return === null || node.return === workInProgress) &#123;</span><br><span class="line">          return;</span><br><span class="line">        &#125;</span><br><span class="line">        // æ›´æ–° node</span><br><span class="line">        node = node.return;</span><br><span class="line">      &#125;</span><br><span class="line">      // æ›´æ–°çˆ¶çº§ æ–¹ä¾¿å›é€€</span><br><span class="line">      node.sibling.return = node.return;</span><br><span class="line">      // å°† node æ›´æ–°ä¸ºä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹</span><br><span class="line">      node = node.sibling;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-commit-é˜¶æ®µ"><a href="#5-2-commit-é˜¶æ®µ" class="headerlink" title="5.2 commit é˜¶æ®µ"></a>5.2 commit é˜¶æ®µ</h3><h4 id="5-2-1-finishSyncRender"><a href="#5-2-1-finishSyncRender" class="headerlink" title="5.2.1 finishSyncRender"></a>5.2.1 finishSyncRender</h4><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function finishSyncRender(root) &#123;</span><br><span class="line">  // é”€æ¯ workInProgress Fiber æ ‘</span><br><span class="line">  // å› ä¸ºå¾…æäº¤ Fiber å¯¹è±¡å·²ç»è¢«å­˜å‚¨åœ¨äº† root.finishedWork ä¸­</span><br><span class="line">  workInProgressRoot = null;</span><br><span class="line">  // è¿›å…¥ commit é˜¶æ®µ</span><br><span class="line">  commitRoot(root);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-2-2-commitRoot"><a href="#5-2-2-commitRoot" class="headerlink" title="5.2.2 commitRoot"></a>5.2.2 commitRoot</h4><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function commitRoot(root) &#123;</span><br><span class="line">  // è·å–ä»»åŠ¡ä¼˜å…ˆçº§ 97 =&gt; æ™®é€šä¼˜å…ˆçº§</span><br><span class="line">  const renderPriorityLevel = getCurrentPriorityLevel();</span><br><span class="line">  // ä½¿ç”¨æœ€é«˜ä¼˜å…ˆçº§æ‰§è¡Œå½“å‰ä»»åŠ¡, å› ä¸º commit é˜¶æ®µä¸å¯ä»¥è¢«æ‰“æ–­</span><br><span class="line">  // ImmediatePriority, ä¼˜å…ˆçº§ä¸º 99, æœ€é«˜ä¼˜å…ˆçº§</span><br><span class="line">  runWithPriority(</span><br><span class="line">    ImmediatePriority,</span><br><span class="line">    commitRootImpl.bind(null, root, renderPriorityLevel),</span><br><span class="line">  );</span><br><span class="line">  return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-2-3-commitRootImpl"><a href="#5-2-3-commitRootImpl" class="headerlink" title="5.2.3 commitRootImpl"></a>5.2.3 commitRootImpl</h4><p>commit é˜¶æ®µå¯ä»¥åˆ†ä¸ºä¸‰ä¸ªå­é˜¶æ®µï¼š</p>
<ul>
<li>before mutation é˜¶æ®µï¼ˆæ‰§è¡Œ DOM æ“ä½œå‰ï¼‰</li>
<li>mutation é˜¶æ®µï¼ˆæ‰§è¡Œ DOM æ“ä½œï¼‰</li>
<li>layout é˜¶æ®µï¼ˆæ‰§è¡Œ DOM æ“ä½œåï¼‰</li>
</ul>
<p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">function commitRootImpl(root, renderPriorityLevel) &#123;</span><br><span class="line">  // è·å–å¾…æäº¤ Fiber å¯¹è±¡ rootFiber</span><br><span class="line">  const finishedWork = root.finishedWork;</span><br><span class="line">  // å¦‚æœæ²¡æœ‰ä»»åŠ¡è¦æ‰§è¡Œ</span><br><span class="line">  if (finishedWork === null) &#123;</span><br><span class="line">    // é˜»æ­¢ç¨‹åºç»§ç»­å‘ä¸‹æ‰§è¡Œ</span><br><span class="line">    return null;</span><br><span class="line">  &#125;</span><br><span class="line">  // é‡ç½®ä¸ºé»˜è®¤å€¼</span><br><span class="line">  root.finishedWork = null;</span><br><span class="line">  root.callbackNode = null;</span><br><span class="line">  root.callbackExpirationTime = NoWork;</span><br><span class="line">  root.callbackPriority = NoPriority;</span><br><span class="line">  root.nextKnownPendingLevel = NoWork;</span><br><span class="line">  </span><br><span class="line">  // è·å–è¦æ‰§è¡Œ DOM æ“ä½œçš„å‰¯ä½œç”¨åˆ—è¡¨</span><br><span class="line">  let firstEffect = finishedWork.firstEffect;</span><br><span class="line"></span><br><span class="line">  // true</span><br><span class="line">  if (firstEffect !== null) &#123;</span><br><span class="line">    // commit ç¬¬ä¸€ä¸ªå­é˜¶æ®µ</span><br><span class="line">    nextEffect = firstEffect;</span><br><span class="line">    // å¤„ç†ç±»ç»„ä»¶çš„ getSnapShotBeforeUpdate ç”Ÿå‘½å‘¨æœŸå‡½æ•°</span><br><span class="line">    do &#123;</span><br><span class="line">      invokeGuardedCallback(null, commitBeforeMutationEffects, null);</span><br><span class="line">    &#125; while (nextEffect !== null);</span><br><span class="line">    </span><br><span class="line">		// commit ç¬¬äºŒä¸ªå­é˜¶æ®µ</span><br><span class="line">    nextEffect = firstEffect;</span><br><span class="line">    do &#123;</span><br><span class="line">      invokeGuardedCallback(null, commitMutationEffects, null, root, renderPriorityLevel);</span><br><span class="line">    &#125; while (nextEffect !== null);</span><br><span class="line">    // å°† workInProgress Fiber æ ‘å˜æˆ current Fiber æ ‘</span><br><span class="line">    root.current = finishedWork;</span><br><span class="line">    </span><br><span class="line">		// commit ç¬¬ä¸‰ä¸ªå­é˜¶æ®µ</span><br><span class="line">    nextEffect = firstEffect;</span><br><span class="line">    do &#123;</span><br><span class="line">      invokeGuardedCallback(null, commitLayoutEffects, null, root,expirationTime);</span><br><span class="line">    &#125; while (nextEffect !== null);</span><br><span class="line">		</span><br><span class="line">    // é‡ç½® nextEffect</span><br><span class="line">    nextEffect = null;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-2-4-ç¬¬ä¸€å­é˜¶æ®µ"><a href="#5-2-4-ç¬¬ä¸€å­é˜¶æ®µ" class="headerlink" title="5.2.4 ç¬¬ä¸€å­é˜¶æ®µ"></a>5.2.4 ç¬¬ä¸€å­é˜¶æ®µ</h4><h5 id="5-2-4-1-commitBeforeMutationEffects"><a href="#5-2-4-1-commitBeforeMutationEffects" class="headerlink" title="5.2.4.1 commitBeforeMutationEffects"></a>5.2.4.1 commitBeforeMutationEffects</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">// commit é˜¶æ®µçš„ç¬¬ä¸€ä¸ªå­é˜¶æ®µ</span><br><span class="line">// è°ƒç”¨ç±»ç»„ä»¶çš„ getSnapshotBeforeUpdate ç”Ÿå‘½å‘¨æœŸå‡½æ•°</span><br><span class="line">function commitBeforeMutationEffects() &#123;</span><br><span class="line">  // å¾ªç¯ effect é“¾</span><br><span class="line">  while (nextEffect !== null) &#123;</span><br><span class="line">    // nextEffect æ˜¯ effect é“¾ä¸Šä» firstEffect åˆ° lastEffec çš„æ¯ä¸€ä¸ªéœ€è¦commitçš„ fiber å¯¹è±¡</span><br><span class="line"></span><br><span class="line">    // åˆå§‹åŒ–æ¸²æŸ“ç¬¬ä¸€ä¸ª nextEffect ä¸º App ç»„ä»¶</span><br><span class="line">    // effectTag =&gt; 3</span><br><span class="line">    const effectTag = nextEffect.effectTag;</span><br><span class="line">    // console.log(effectTag);</span><br><span class="line">    // nextEffect = null;</span><br><span class="line">    // return;</span><br><span class="line"></span><br><span class="line">    // å¦‚æœ fiber å¯¹è±¡ä¸­é‡Œæœ‰ Snapshot è¿™ä¸ª effectTag çš„è¯</span><br><span class="line">    // Snapshot å’Œæ›´æ–°æœ‰å…³ç³» åˆå§‹åŒ–æ¸²æŸ“ ä¸æ‰§è¡Œ</span><br><span class="line">    // false</span><br><span class="line">    if ((effectTag &amp; Snapshot) !== NoEffect) &#123;</span><br><span class="line">      // è·å–å½“å‰ fiber èŠ‚ç‚¹</span><br><span class="line">      const current = nextEffect.alternate;</span><br><span class="line">      // å½“ nextEffect ä¸Šæœ‰ Snapshot è¿™ä¸ª effectTag æ—¶</span><br><span class="line">      // æ‰§è¡Œä»¥ä¸‹æ–¹æ³•, ä¸»è¦æ˜¯ç±»ç»„ä»¶è°ƒç”¨ getSnapshotBeforeUpdate ç”Ÿå‘½å‘¨æœŸå‡½æ•°</span><br><span class="line">      commitBeforeMutationEffectOnFiber(current, nextEffect);</span><br><span class="line">    &#125;</span><br><span class="line">    // æ›´æ–°å¾ªç¯æ¡ä»¶</span><br><span class="line">    nextEffect = nextEffect.nextEffect;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-2-4-2-commitBeforeMutationLifeCycles"><a href="#5-2-4-2-commitBeforeMutationLifeCycles" class="headerlink" title="5.2.4.2 commitBeforeMutationLifeCycles"></a>5.2.4.2 commitBeforeMutationLifeCycles</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">function commitBeforeMutationLifeCycles(</span><br><span class="line">  current: Fiber | null,</span><br><span class="line">  finishedWork: Fiber,</span><br><span class="line">): void &#123;</span><br><span class="line">  switch (finishedWork.tag) &#123;</span><br><span class="line">    case FunctionComponent:</span><br><span class="line">    case ForwardRef:</span><br><span class="line">    case SimpleMemoComponent:</span><br><span class="line">    case Block: &#123;</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line">    // å¦‚æœè¯¥ fiber ç±»å‹æ˜¯ ClassComponent</span><br><span class="line">    case ClassComponent: &#123;</span><br><span class="line">      if (finishedWork.effectTag &amp; Snapshot) &#123;</span><br><span class="line">        if (current !== null) &#123;</span><br><span class="line">          // æ—§çš„ props</span><br><span class="line">          const prevProps = current.memoizedProps;</span><br><span class="line">          // æ—§çš„ state</span><br><span class="line">          const prevState = current.memoizedState;</span><br><span class="line">          // è·å– classComponent ç»„ä»¶çš„å®ä¾‹å¯¹è±¡</span><br><span class="line">          const instance = finishedWork.stateNode;</span><br><span class="line">          // æ‰§è¡Œ getSnapshotBeforeUpdate ç”Ÿå‘½å‘¨æœŸå‡½æ•°</span><br><span class="line">          // åœ¨ç»„ä»¶æ›´æ–°å‰æ•è·ä¸€äº› DOM ä¿¡æ¯</span><br><span class="line">          // è¿”å›è‡ªå®šä¹‰çš„å€¼æˆ– null, ç»Ÿç§°ä¸º snapshot</span><br><span class="line">          const snapshot = instance.getSnapshotBeforeUpdate(</span><br><span class="line">            finishedWork.elementType === finishedWork.type</span><br><span class="line">              ? prevProps</span><br><span class="line">              : resolveDefaultProps(finishedWork.type, prevProps),</span><br><span class="line">            prevState,</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line">    case HostRoot:</span><br><span class="line">    case HostComponent:</span><br><span class="line">    case HostText:</span><br><span class="line">    case HostPortal:</span><br><span class="line">    case IncompleteClassComponent:</span><br><span class="line">      // Nothing to do for these component types</span><br><span class="line">      return;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-2-5-ç¬¬äºŒå­é˜¶æ®µ"><a href="#5-2-5-ç¬¬äºŒå­é˜¶æ®µ" class="headerlink" title="5.2.5 ç¬¬äºŒå­é˜¶æ®µ"></a>5.2.5 ç¬¬äºŒå­é˜¶æ®µ</h4><h5 id="5-2-5-1-commitMutationEffects"><a href="#5-2-5-1-commitMutationEffects" class="headerlink" title="5.2.5.1 commitMutationEffects"></a>5.2.5.1 commitMutationEffects</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">// commit é˜¶æ®µçš„ç¬¬äºŒä¸ªå­é˜¶æ®µ</span><br><span class="line">// æ ¹æ® effectTag æ‰§è¡Œ DOM æ“ä½œ</span><br><span class="line">function commitMutationEffects(root: FiberRoot, renderPriorityLevel) &#123;</span><br><span class="line">  // å¾ªç¯ effect é“¾</span><br><span class="line">  while (nextEffect !== null) &#123;</span><br><span class="line">    // è·å– effectTag</span><br><span class="line">    // åˆå§‹æ¸²æŸ“ç¬¬ä¸€æ¬¡å¾ªç¯ä¸º App ç»„ä»¶</span><br><span class="line">    // å³å°†æ ¹ç»„ä»¶åŠå†…éƒ¨æ‰€æœ‰å†…å®¹ä¸€æ¬¡æ€§æ·»åŠ åˆ°é¡µé¢ä¸­</span><br><span class="line">    const effectTag = nextEffect.effectTag;</span><br><span class="line"></span><br><span class="line">    // æ ¹æ® effectTag åˆ†åˆ«å¤„ç†</span><br><span class="line">    let primaryEffectTag =</span><br><span class="line">      effectTag &amp; (Placement | Update | Deletion | Hydrating);</span><br><span class="line">    // åŒ¹é… effectTag</span><br><span class="line">    // åˆå§‹æ¸²æŸ“ primaryEffectTag ä¸º 2 åŒ¹é…åˆ° Placement</span><br><span class="line">    switch (primaryEffectTag) &#123;</span><br><span class="line">      // é’ˆå¯¹è¯¥èŠ‚ç‚¹åŠå­èŠ‚ç‚¹è¿›è¡Œæ’å…¥æ“ä½œ</span><br><span class="line">      case Placement: &#123;</span><br><span class="line">        commitPlacement(nextEffect);</span><br><span class="line">        // effectTag ä» 3 å˜ä¸º 1</span><br><span class="line">        // ä» effect æ ‡ç­¾ä¸­æ¸…é™¤ &quot;placement&quot; é‡ç½® effectTag å€¼</span><br><span class="line">        // ä»¥ä¾¿æˆ‘ä»¬çŸ¥é“åœ¨è°ƒç”¨è¯¸å¦‚componentDidMountä¹‹ç±»çš„ä»»ä½•ç”Ÿå‘½å‘¨æœŸä¹‹å‰å·²å°†å…¶æ’å…¥ã€‚</span><br><span class="line">        nextEffect.effectTag &amp;= ~Placement;</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      // æ’å…¥å¹¶æ›´æ–° DOM</span><br><span class="line">      case PlacementAndUpdate: &#123;</span><br><span class="line">        // æ’å…¥</span><br><span class="line">        commitPlacement(nextEffect);</span><br><span class="line">        nextEffect.effectTag &amp;= ~Placement;</span><br><span class="line"></span><br><span class="line">        // æ›´æ–°</span><br><span class="line">        const current = nextEffect.alternate;</span><br><span class="line">        commitWork(current, nextEffect);</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      // æœåŠ¡å™¨ç«¯æ¸²æŸ“</span><br><span class="line">      case Hydrating: &#123;</span><br><span class="line">        nextEffect.effectTag &amp;= ~Hydrating;</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      // æœåŠ¡å™¨ç«¯æ¸²æŸ“</span><br><span class="line">      case HydratingAndUpdate: &#123;</span><br><span class="line">        nextEffect.effectTag &amp;= ~Hydrating;</span><br><span class="line"></span><br><span class="line">        // Update</span><br><span class="line">        const current = nextEffect.alternate;</span><br><span class="line">        commitWork(current, nextEffect);</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      // æ›´æ–° DOM</span><br><span class="line">      case Update: &#123;</span><br><span class="line">        const current = nextEffect.alternate;</span><br><span class="line">        commitWork(current, nextEffect);</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      // åˆ é™¤ DOM</span><br><span class="line">      case Deletion: &#123;</span><br><span class="line">        commitDeletion(root, nextEffect, renderPriorityLevel);</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    nextEffect = nextEffect.nextEffect;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-2-5-2-commitPlacement"><a href="#5-2-5-2-commitPlacement" class="headerlink" title="5.2.5.2 commitPlacement"></a>5.2.5.2 commitPlacement</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">// æŒ‚è½½ DOM å…ƒç´ </span><br><span class="line">function commitPlacement(finishedWork: Fiber): void &#123;</span><br><span class="line">  // finishedWork åˆå§‹åŒ–æ¸²æŸ“æ—¶ä¸ºæ ¹ç»„ä»¶ Fiber å¯¹è±¡</span><br><span class="line">  // è·å–éç»„ä»¶çˆ¶çº§ Fiber å¯¹è±¡</span><br><span class="line">  // åˆå§‹æ¸²æŸ“æ—¶ä¸º &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span><br><span class="line">  const parentFiber = getHostParentFiber(finishedWork);</span><br><span class="line"></span><br><span class="line">  // å­˜å‚¨çœŸæ­£çš„çˆ¶çº§ DOM èŠ‚ç‚¹å¯¹è±¡</span><br><span class="line">  let parent;</span><br><span class="line">  // æ˜¯å¦ä¸ºæ¸²æŸ“å®¹å™¨</span><br><span class="line">  // æ¸²æŸ“å®¹å™¨å’Œæ™®é€šreactå…ƒç´ çš„ä¸»è¦åŒºåˆ«åœ¨äºæ˜¯å¦éœ€è¦ç‰¹æ®Šå¤„ç†æ³¨é‡ŠèŠ‚ç‚¹</span><br><span class="line">  let isContainer;</span><br><span class="line">  // è·å–çˆ¶çº§ DOM èŠ‚ç‚¹å¯¹è±¡</span><br><span class="line">  // ä½†æ˜¯åˆå§‹æ¸²æŸ“æ—¶ rootFiber å¯¹è±¡ä¸­çš„ stateNode å­˜å‚¨çš„æ˜¯ FiberRoot</span><br><span class="line">  const parentStateNode = parentFiber.stateNode;</span><br><span class="line">  // åˆ¤æ–­çˆ¶èŠ‚ç‚¹çš„ç±»å‹</span><br><span class="line">  // åˆå§‹æ¸²æŸ“æ—¶æ˜¯ hostRoot 3</span><br><span class="line">  switch (parentFiber.tag) &#123;</span><br><span class="line">    case HostComponent:</span><br><span class="line">      parent = parentStateNode;</span><br><span class="line">      isContainer = false;</span><br><span class="line">      break;</span><br><span class="line">    case HostRoot:</span><br><span class="line">      // è·å–çœŸæ­£çš„ DOM èŠ‚ç‚¹å¯¹è±¡</span><br><span class="line">      // &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span><br><span class="line">      parent = parentStateNode.containerInfo;</span><br><span class="line">      // æ˜¯ container å®¹å™¨</span><br><span class="line">      isContainer = true;</span><br><span class="line">      break;</span><br><span class="line">    case HostPortal:</span><br><span class="line">      parent = parentStateNode.containerInfo;</span><br><span class="line">      isContainer = true;</span><br><span class="line">      break;</span><br><span class="line">    case FundamentalComponent:</span><br><span class="line">      if (enableFundamentalAPI) &#123;</span><br><span class="line">        parent = parentStateNode.instance;</span><br><span class="line">        isContainer = false;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  // æŸ¥çœ‹å½“å‰èŠ‚ç‚¹æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹</span><br><span class="line">  // æœ‰, æ‰§è¡Œ insertBefore</span><br><span class="line">  // æ²¡æœ‰, æ‰§è¡Œ appendChild</span><br><span class="line">  const before = getHostSibling(finishedWork);</span><br><span class="line">	// æ¸²æŸ“å®¹å™¨</span><br><span class="line">  if (isContainer) &#123;</span><br><span class="line">    // å‘çˆ¶èŠ‚ç‚¹ä¸­è¿½åŠ èŠ‚ç‚¹ æˆ–è€… å°†å­èŠ‚ç‚¹æ’å…¥åˆ° before èŠ‚ç‚¹çš„å‰é¢</span><br><span class="line">    insertOrAppendPlacementNodeIntoContainer(finishedWork, before, parent);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // éæ¸²æŸ“å®¹å™¨</span><br><span class="line">    // å‘çˆ¶èŠ‚ç‚¹ä¸­è¿½åŠ èŠ‚ç‚¹ æˆ–è€… å°†å­èŠ‚ç‚¹æ’å…¥åˆ° before èŠ‚ç‚¹çš„å‰é¢</span><br><span class="line">    insertOrAppendPlacementNode(finishedWork, before, parent);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-2-5-3-getHostParentFiber"><a href="#5-2-5-3-getHostParentFiber" class="headerlink" title="5.2.5.3 getHostParentFiber"></a>5.2.5.3 getHostParentFiber</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// è·å– HostRootFiber å¯¹è±¡</span><br><span class="line">function getHostParentFiber(fiber: Fiber): Fiber &#123;</span><br><span class="line">  // è·å–å½“å‰ Fiber çˆ¶çº§</span><br><span class="line">  let parent = fiber.return;</span><br><span class="line">  // æŸ¥çœ‹çˆ¶çº§æ˜¯å¦ä¸º null</span><br><span class="line">  while (parent !== null) &#123;</span><br><span class="line">    // æŸ¥çœ‹çˆ¶çº§æ˜¯å¦ä¸º hostRoot</span><br><span class="line">    if (isHostParent(parent)) &#123;</span><br><span class="line">      // è¿”å›</span><br><span class="line">      return parent;</span><br><span class="line">    &#125;</span><br><span class="line">    // ç»§ç»­å‘ä¸ŠæŸ¥æ‰¾</span><br><span class="line">    parent = parent.return;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-2-5-4-insertOrAppendPlacementNodeIntoContainer"><a href="#5-2-5-4-insertOrAppendPlacementNodeIntoContainer" class="headerlink" title="5.2.5.4 insertOrAppendPlacementNodeIntoContainer"></a>5.2.5.4 insertOrAppendPlacementNodeIntoContainer</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">// å‘å®¹å™¨ä¸­è¿½åŠ  | æ’å…¥åˆ°æŸä¸€ä¸ªèŠ‚ç‚¹çš„å‰é¢</span><br><span class="line">function insertOrAppendPlacementNodeIntoContainer(</span><br><span class="line">  node: Fiber,</span><br><span class="line">  before: ?Instance,</span><br><span class="line">  parent: Container,</span><br><span class="line">): void &#123;</span><br><span class="line">  const &#123;tag&#125; = node;</span><br><span class="line">  // å¦‚æœå¾…æ’å…¥çš„èŠ‚ç‚¹æ˜¯ä¸€ä¸ª DOM å…ƒç´ æˆ–è€…æ–‡æœ¬çš„è¯</span><br><span class="line">  // æ¯”å¦‚ ç»„ä»¶fiber =&gt; false div =&gt; true</span><br><span class="line">  const isHost = tag === HostComponent || tag === HostText;</span><br><span class="line"></span><br><span class="line">  if (isHost || (enableFundamentalAPI &amp;&amp; tag === FundamentalComponent)) &#123;</span><br><span class="line">    // è·å– DOM èŠ‚ç‚¹</span><br><span class="line">    const stateNode = isHost ? node.stateNode : node.stateNode.instance;</span><br><span class="line">    // å¦‚æœ before å­˜åœ¨</span><br><span class="line">    if (before) &#123;</span><br><span class="line">      // æ’å…¥åˆ° before å‰é¢</span><br><span class="line">      insertInContainerBefore(parent, stateNode, before);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      // è¿½åŠ åˆ°çˆ¶å®¹å™¨ä¸­</span><br><span class="line">      appendChildToContainer(parent, stateNode);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // å¦‚æœæ˜¯ç»„ä»¶èŠ‚ç‚¹, æ¯”å¦‚ ClassComponent, åˆ™æ‰¾å®ƒçš„ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹(DOM å…ƒç´ )</span><br><span class="line">    // è¿›è¡Œæ’å…¥æ“ä½œ</span><br><span class="line">    const child = node.child;</span><br><span class="line">    if (child !== null) &#123;</span><br><span class="line">      // å‘çˆ¶çº§ä¸­è¿½åŠ å­èŠ‚ç‚¹æˆ–è€…å°†å­èŠ‚ç‚¹æ’å…¥åˆ° before çš„å‰é¢</span><br><span class="line">      insertOrAppendPlacementNodeIntoContainer(child, before, parent);</span><br><span class="line">      // è·å–ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹</span><br><span class="line">      let sibling = child.sibling;</span><br><span class="line">      // å¦‚æœå…„å¼ŸèŠ‚ç‚¹å­˜åœ¨</span><br><span class="line">      while (sibling !== null) &#123;</span><br><span class="line">        // å‘çˆ¶çº§ä¸­è¿½åŠ å­èŠ‚ç‚¹æˆ–è€…å°†å­èŠ‚ç‚¹æ’å…¥åˆ° before çš„å‰é¢</span><br><span class="line">        insertOrAppendPlacementNodeIntoContainer(sibling, before, parent);</span><br><span class="line">        // åŒæ­¥å…„å¼ŸèŠ‚ç‚¹</span><br><span class="line">        sibling = sibling.sibling;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-2-5-5-insertInContainerBefore"><a href="#5-2-5-5-insertInContainerBefore" class="headerlink" title="5.2.5.5 insertInContainerBefore"></a>5.2.5.5 insertInContainerBefore</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-dom/src/client/ReactDOMHostConfig.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">export function insertInContainerBefore(</span><br><span class="line">  container: Container,</span><br><span class="line">  child: Instance | TextInstance,</span><br><span class="line">  beforeChild: Instance | TextInstance | SuspenseInstance,</span><br><span class="line">): void &#123;</span><br><span class="line">  // å¦‚æœçˆ¶å®¹å™¨æ˜¯æ³¨é‡ŠèŠ‚ç‚¹</span><br><span class="line">  if (container.nodeType === COMMENT_NODE) &#123;</span><br><span class="line">    // æ‰¾åˆ°æ³¨é‡ŠèŠ‚ç‚¹çš„çˆ¶çº§èŠ‚ç‚¹ å› ä¸ºæ³¨é‡ŠèŠ‚ç‚¹æ²¡æ³•è°ƒç”¨ insertBefore</span><br><span class="line">    (container.parentNode: any).insertBefore(child, beforeChild);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // å°† child æ’å…¥åˆ° beforeChild çš„å‰é¢</span><br><span class="line">    container.insertBefore(child, beforeChild);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-2-5-6-appendChildToContainer"><a href="#5-2-5-6-appendChildToContainer" class="headerlink" title="5.2.5.6 appendChildToContainer"></a>5.2.5.6 appendChildToContainer</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-dom/src/client/ReactDOMHostConfig.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">export function appendChildToContainer(</span><br><span class="line">  container: Container,</span><br><span class="line">  child: Instance | TextInstance,</span><br><span class="line">): void &#123;</span><br><span class="line">  // ç›‘æµ‹ container æ˜¯å¦æ³¨é‡ŠèŠ‚ç‚¹</span><br><span class="line">  if (container.nodeType === COMMENT_NODE) &#123;</span><br><span class="line">    // è·å–çˆ¶çº§çš„çˆ¶çº§</span><br><span class="line">    parentNode = (container.parentNode: any);</span><br><span class="line">    // å°†å­çº§èŠ‚ç‚¹æ’å…¥åˆ°æ³¨é‡ŠèŠ‚ç‚¹çš„å‰é¢</span><br><span class="line">    parentNode.insertBefore(child, container);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // ç›´æ¥å°† child æ’å…¥åˆ°çˆ¶çº§ä¸­</span><br><span class="line">    parentNode = container;</span><br><span class="line">    parentNode.appendChild(child);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-2-6-ç¬¬ä¸‰å­é˜¶æ®µ"><a href="#5-2-6-ç¬¬ä¸‰å­é˜¶æ®µ" class="headerlink" title="5.2.6 ç¬¬ä¸‰å­é˜¶æ®µ"></a>5.2.6 ç¬¬ä¸‰å­é˜¶æ®µ</h4><h5 id="5-2-6-1-commitLayoutEffects"><a href="#5-2-6-1-commitLayoutEffects" class="headerlink" title="5.2.6.1 commitLayoutEffects"></a>5.2.6.1 commitLayoutEffects</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// commit é˜¶æ®µçš„ç¬¬ä¸‰ä¸ªå­é˜¶æ®µ</span><br><span class="line">function commitLayoutEffects(</span><br><span class="line">  root: FiberRoot,</span><br><span class="line">  committedExpirationTime: ExpirationTime,</span><br><span class="line">) &#123;</span><br><span class="line">  while (nextEffect !== null) &#123;</span><br><span class="line">    // æ­¤æ—¶ effectTag å·²ç»è¢«é‡ç½®ä¸º 1, è¡¨ç¤º DOM æ“ä½œå·²ç»å®Œæˆ</span><br><span class="line">    const effectTag = nextEffect.effectTag;</span><br><span class="line">    // è°ƒç”¨ç”Ÿå‘½å‘¨æœŸå‡½æ•°å’Œé’©å­å‡½æ•°</span><br><span class="line">    // å‰ææ˜¯ç±»ç»„ä»¶ä¸­è°ƒç”¨äº†ç”Ÿå‘½å‘¨æœŸå‡½æ•° æˆ–è€…å‡½æ•°ç»„ä»¶ä¸­è°ƒç”¨äº† useEffect</span><br><span class="line">    if (effectTag &amp; (Update | Callback)) &#123;</span><br><span class="line">      // ç±»ç»„ä»¶å¤„ç†ç”Ÿå‘½å‘¨æœŸå‡½æ•°</span><br><span class="line">      // å‡½æ•°ç»„ä»¶å¤„ç†é’©å­å‡½æ•°</span><br><span class="line">      commitLayoutEffectOnFiber(root, current,nextEffect, committedExpirationTime);</span><br><span class="line">    &#125;</span><br><span class="line">    // æ›´æ–°å¾ªç¯æ¡ä»¶</span><br><span class="line">    nextEffect = nextEffect.nextEffect;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-2-6-2-commitLifeCycles"><a href="#5-2-6-2-commitLifeCycles" class="headerlink" title="5.2.6.2 commitLifeCycles"></a>5.2.6.2 commitLifeCycles</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">function commitLifeCycles(</span><br><span class="line">  finishedRoot: FiberRoot,</span><br><span class="line">  current: Fiber | null,</span><br><span class="line">  finishedWork: Fiber,</span><br><span class="line">  committedExpirationTime: ExpirationTime,</span><br><span class="line">): void &#123;</span><br><span class="line">  switch (finishedWork.tag) &#123;</span><br><span class="line">    case FunctionComponent: &#123;</span><br><span class="line">      // å¤„ç†é’©å­å‡½æ•°</span><br><span class="line">      commitHookEffectListMount(HookLayout | HookHasEffect, finishedWork);</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line">    case ClassComponent: &#123;</span><br><span class="line">      // è·å–ç±»ç»„ä»¶å®ä¾‹å¯¹è±¡</span><br><span class="line">      const instance = finishedWork.stateNode;</span><br><span class="line">      // å¦‚æœåœ¨ç±»ç»„ä»¶ä¸­å­˜åœ¨ç”Ÿå‘½å‘¨æœŸå‡½æ•°åˆ¤æ–­æ¡ä»¶å°±ä¼šæˆç«‹</span><br><span class="line">      if (finishedWork.effectTag &amp; Update) &#123;</span><br><span class="line">        // åˆå§‹æ¸²æŸ“é˜¶æ®µ</span><br><span class="line">        if (current === null) &#123;</span><br><span class="line">          // è°ƒç”¨ componentDidMount ç”Ÿå‘½å‘¨æœŸå‡½æ•°</span><br><span class="line">          instance.componentDidMount();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          // æ›´æ–°é˜¶æ®µ</span><br><span class="line">          // è·å–æ—§çš„ props</span><br><span class="line">          const prevProps = finishedWork.elementType === finishedWork.type</span><br><span class="line">              ? current.memoizedProps</span><br><span class="line">              : resolveDefaultProps(finishedWork.type, current.memoizedProps);</span><br><span class="line">          // è·å–æ—§çš„ state</span><br><span class="line">          const prevState = current.memoizedState;</span><br><span class="line">          // è°ƒç”¨ componentDidUpdate ç”Ÿå‘½å‘¨æœŸå‡½æ•°</span><br><span class="line">          // instance.__reactInternalSnapshotBeforeUpdate å¿«ç…§ getSnapShotBeforeUpdate æ–¹æ³•çš„è¿”å›å€¼</span><br><span class="line">          instance.componentDidUpdate(prevProps, prevState, instance.__reactInternalSnapshotBeforeUpdate);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      // è·å–ä»»åŠ¡é˜Ÿåˆ—</span><br><span class="line">      const updateQueue = finishedWork.updateQueue;</span><br><span class="line">      // å¦‚æœä»»åŠ¡é˜Ÿåˆ—å­˜åœ¨</span><br><span class="line">      if (updateQueue !== null) &#123;</span><br><span class="line">        /**</span><br><span class="line">         * è°ƒç”¨ ReactElement æ¸²æŸ“å®Œæˆä¹‹åçš„å›è°ƒå‡½æ•°</span><br><span class="line">         * å³ render æ–¹æ³•çš„ç¬¬ä¸‰ä¸ªå‚æ•°</span><br><span class="line">         */</span><br><span class="line">        commitUpdateQueue(finishedWork, updateQueue, instance);</span><br><span class="line">      &#125;</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-2-6-3-commitUpdateQueue"><a href="#5-2-6-3-commitUpdateQueue" class="headerlink" title="5.2.6.3 commitUpdateQueue"></a>5.2.6.3 commitUpdateQueue</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactUpdateQueue.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * æ‰§è¡Œæ¸²æŸ“å®Œæˆä¹‹åçš„å›è°ƒå‡½æ•°</span><br><span class="line"> */</span><br><span class="line">export function commitUpdateQueue&lt;State&gt;(</span><br><span class="line">  finishedWork: Fiber,</span><br><span class="line">  finishedQueue: UpdateQueue&lt;State&gt;,</span><br><span class="line">  instance: any,</span><br><span class="line">): void &#123;</span><br><span class="line">  // effects ä¸ºæ•°ç»„, å­˜å‚¨ä»»åŠ¡å¯¹è±¡ (Update å¯¹è±¡)</span><br><span class="line">  // ä½†å‰ææ˜¯åœ¨è°ƒç”¨ render æ–¹æ³•æ—¶ä¼ é€’äº†å›è°ƒå‡½æ•°, å°±æ˜¯ render æ–¹æ³•çš„ç¬¬ä¸‰ä¸ªå‚æ•°</span><br><span class="line">  const effects = finishedQueue.effects;</span><br><span class="line">  // é‡ç½® finishedQueue.effects æ•°ç»„</span><br><span class="line">  finishedQueue.effects = null;</span><br><span class="line">  // å¦‚æœä¼ é€’äº† render æ–¹æ³•çš„ç¬¬ä¸‰ä¸ªå‚æ•°, effect æ•°ç»„å°±ä¸ä¼šä¸º null</span><br><span class="line">  if (effects !== null) &#123;</span><br><span class="line">    // éå† effect æ•°ç»„</span><br><span class="line">    for (let i = 0; i &lt; effects.length; i++) &#123;</span><br><span class="line">      // è·å–æ•°ç»„ä¸­çš„ç¬¬ i ä¸ªéœ€è¦æ‰§è¡Œçš„ effect</span><br><span class="line">      const effect = effects[i];</span><br><span class="line">      // è·å– callback å›è°ƒå‡½æ•°</span><br><span class="line">      const callback = effect.callback;</span><br><span class="line">      // å¦‚æœå›è°ƒå‡½æ•°ä¸ä¸º null</span><br><span class="line">      if (callback !== null) &#123;</span><br><span class="line">        // æ¸…ç©º effect ä¸­çš„ callback</span><br><span class="line">        effect.callback = null;</span><br><span class="line">        // æ‰§è¡Œå›è°ƒå‡½æ•°</span><br><span class="line">        callCallback(callback, instance);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-2-6-4-commitHookEffectListMount"><a href="#5-2-6-4-commitHookEffectListMount" class="headerlink" title="5.2.6.4 commitHookEffectListMount"></a>5.2.6.4 commitHookEffectListMount</h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * useEffect å›è°ƒå‡½æ•°è°ƒç”¨</span><br><span class="line"> */</span><br><span class="line">function commitHookEffectListMount(tag: number, finishedWork: Fiber) &#123;</span><br><span class="line">  // è·å–ä»»åŠ¡é˜Ÿåˆ—</span><br><span class="line">  const updateQueue: FunctionComponentUpdateQueue | null = (finishedWork.updateQueue: any);</span><br><span class="line">  // è·å– lastEffect</span><br><span class="line">  let lastEffect = updateQueue !== null ? updateQueue.lastEffect : null;</span><br><span class="line">  // å¦‚æœ lastEffect ä¸ä¸º null</span><br><span class="line">  if (lastEffect !== null) &#123;</span><br><span class="line">    // è·å–è¦æ‰§è¡Œçš„å‰¯ä½œç”¨</span><br><span class="line">    const firstEffect = lastEffect.next;</span><br><span class="line">    let effect = firstEffect;</span><br><span class="line">    // é€šè¿‡éå†çš„æ–¹å¼è°ƒç”¨ useEffect ä¸­çš„å›è°ƒå‡½æ•°</span><br><span class="line">    // åœ¨ç»„ä»¶ä¸­å®šä¹‰äº†è°ƒç”¨äº†å‡ æ¬¡ useEffect éå†å°±ä¼šæ‰§è¡Œå‡ æ¬¡</span><br><span class="line">    do &#123;</span><br><span class="line">      if ((effect.tag &amp; tag) === tag) &#123;</span><br><span class="line">        // Mount</span><br><span class="line">        const create = effect.create;</span><br><span class="line">        // create å°±æ˜¯ useEffect æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°</span><br><span class="line">        // è¿”å›å€¼å°±æ˜¯æ¸…ç†å‡½æ•°</span><br><span class="line">        effect.destroy = create();</span><br><span class="line">      &#125;</span><br><span class="line">      // æ›´æ–°å¾ªç¯æ¡ä»¶</span><br><span class="line">      effect = effect.next;</span><br><span class="line">    &#125; while (effect !== firstEffect);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      </section>

      
      
        <nav class="article-nav">
          
            <div class="article-nav-item layout-padding">
  <article class="card-container article-nav-card content-padding--primary soft-size--large soft-style--box">
    
      <div class="card-cover" background-image-lazy data-img="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fwww.allyfurn.com%2Fwp-content%2Fuploads%2F2020%2F05%2F0916064614-0-2.jpg&amp;refer=http%3A%2F%2Fwww.allyfurn.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=auto?sec=1668429655&amp;t=9f8135fe7250f58ea4ba43dc529db300"></div>
    
    <div class="card-text">
      
        <a href="/GYB_blog/2022/10/15/IReact/fiber/" itemprop="url">
          <h2 class="card-text--title text-ellipsis">fiber</h2>
        </a>
      
      <div class="card-text--row">Newer</div>
    </div>
  </article>
</div>
          
          
            <div class="article-nav-item layout-padding">
  <article class="card-container article-nav-card content-padding--primary soft-size--large soft-style--box">
    
      <div class="card-cover" background-image-lazy data-img="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fpic.616pic.com%2Fbg_w1180%2F00%2F01%2F05%2F1ZCUzspkDb.jpg&amp;refer=http%3A%2F%2Fpic.616pic.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=auto?sec=1668431140&amp;t=688ee57e1fa976e119748de59ac04c90"></div>
    
    <div class="card-text">
      
        <a href="/GYB_blog/2020/05/19/%E7%9F%AD%E8%A7%86%E9%A2%91%E7%B4%A0%E6%9D%90/" itemprop="url">
          <h2 class="card-text--title text-ellipsis">çŸ­è§†é¢‘ç´ æ</h2>
        </a>
      
      <div class="card-text--row">Older</div>
    </div>
  </article>
</div>
          
        </nav>
      

      <section class="page-message-container layout-padding">
        


  
  
    <div class="valine-container comments-container content-padding--primary soft-size--large soft-style--box">
      <div id="valine_thread" class="valine-thread"></div>
    </div>
    <script type="text/javascript" src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script type="text/javascript" src='//unpkg.com/valine/dist/Valine.min.js'></script>
    <script type="text/javascript">
      new Valine({
        el: "#valine_thread",
        appId: "pUxEGAT8SFEeyFUC8S5kPk8n-gzGzoHsz",
        appKey: "rytAHCJEjCUx7Yd4oTUhyPQL",
        avatar: "mm",
        placeholder: "éšä¾¿è¯´ç‚¹ä»€ä¹ˆå­ï½",
        notify: true,
        visitor: true,
        pageSize: 10,
      });
    </script>
  

  
  


      </section>
    </div>
    <div class="widget-info">
      <section class="widget-author widget-item layout-margin content-padding--primary soft-size--large soft-style--box">
  <div class="widget-body">
    
      <img src="https://img1.baidu.com/it/u=1088540074,3334562162&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=237&amp;h=221" class="soft-size--round soft-style--box" alt="GYB">
    
    
      <h2>GYB</h2>
    
    
      <p>æ—¥æ‹±ä¸€å’ï¼ŒåŠŸä¸å”æ</p>
    

    <div class="count-box">
      <div class="count-box--item">
        <svg class="icon icon-article" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M240.51564747 647.74217627h196.07203239c16.59071043 0 30.16492806-13.57421762 30.16492805-30.16492806V165.10332731c0-33.18142087-30.16492806-60.32985613-60.32985612-60.32985611H245.04038668C225.43318342 104.7734712 210.35071939 119.85593522 210.35071939 139.46313845V617.57724821c0 16.59071043 13.57421762 30.16492806 30.16492808 30.16492806z m663.62841731-452.47392089v482.63884894c0 33.18142087-27.14843525 60.32985613-60.32985612 60.32985613H180.18579134c-33.18142087 0-60.32985613-27.14843525-60.32985612-60.32985613V195.26825538c-49.77213131 0-90.49478418 40.72265287-90.49478417 90.49478417v452.4739209c0 49.77213131 40.72265287 90.49478418 90.49478417 90.49478417h286.56681657c16.59071043 0 30.16492806 13.57421762 30.16492807 30.16492807s13.57421762 30.16492806 30.16492805 30.16492806h90.49478418c16.59071043 0 30.16492806-13.57421762 30.16492805-30.16492806s13.57421762-30.16492806 30.16492807-30.16492807h286.56681657c49.77213131 0 90.49478418-40.72265287 90.49478417-90.49478417V285.76303955c0-49.77213131-40.72265287-90.49478418-90.49478417-90.49478417zM587.41232014 647.74217627h191.54729318c19.60720323 0 34.68966726-15.08246403 34.68966729-34.68966727V134.93839925c0-16.59071043-13.57421762-30.16492806-30.16492808-30.16492805H617.57724821c-30.16492806 0-60.32985613 27.14843525-60.32985612 60.32985611v452.4739209c0 16.59071043 13.57421762 30.16492806 30.16492805 30.16492806z" fill="currentColor"></path>
</svg>
        <span>5</span>
      </div>
      <div class="count-box--item">
        <svg class="icon icon-categories" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M900.3614811 257.09082106h-339.81629553l-67.96326003-101.9448889c-19.41807444-29.12711113-48.54518557-43.69066667-82.52681443-43.69066667H123.6385189c-53.39970333 0-97.09036999 43.69066667-97.09037113 97.09036999v582.54222222c0 53.39970333 43.69066667 97.09036999 97.09037113 97.09037002h776.7229622c53.39970333 0 97.09036999-43.69066667 97.09037113-97.09037002V354.18119104c0-53.39970333-43.69066667-97.09036999-97.09037113-97.09036998z m-97.09036999 242.72592554H220.72888889c-24.27259221 0-48.54518557-24.27259221-48.54518556-48.54518556s24.27259221-48.54518557 48.54518556-48.54518444h582.54222222c24.27259221 0 48.54518557 24.27259221 48.54518556 48.54518444s-24.27259221 48.54518557-48.54518556 48.54518556z" fill="currentColor"></path>
</svg>
        2
      </div>
      <div class="count-box--item">
        <svg class="icon icon-tags" viewBox="0 0 1098 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M283.42180005 272q0-28.38857157-20.09142843-48.48000001t-48.47999998-20.09142842-48.48000002 20.09142842-20.09142846 48.48000001 20.09142846 48.48 48.48000002 20.09142843 48.47999998-20.09142843 20.09142843-48.48zM855.0332285 580.57142843q0 28.38857157-19.81714313 48.2057147l-263.03999997 263.58857157q-20.9142853 19.81714313-48.75428534 19.81714312-28.38857157 0-48.20571468-19.81714312l-383.04-383.58857157q-20.36571468-19.81714313-34.55999999-54.10285688t-14.19428534-62.6742853l0-222.85714313q0-27.84000002 20.36571469-48.20571469t48.2057147-20.36571466l222.85714313 0q28.38857157 0 62.6742853 14.19428529t54.65142842 34.55999999l383.04000001 382.49142843q19.81714313 20.9142853 19.81714314 48.75428532zM1060.74751475 580.57142843q0 28.38857157-19.81714313 48.2057147l-263.04 263.58857157q-20.9142853 19.81714313-48.75428531 19.81714312-19.26857155 0-31.61142843-7.47428531t-28.38857159-24.13714314l251.79428534-251.7942853q19.81714313-19.81714313 19.81714308-48.20571469 0-27.84000002-19.81714308-48.75428531l-383.04000001-382.49142845q-20.36571468-20.36571468-54.65142842-34.55999999t-62.67428532-14.19428534l120 0q28.38857157 0 62.67428532 14.19428534t54.65142842 34.55999999l383.03999998 382.49142845q19.81714313 20.9142853 19.81714314 48.75428531z" fill="currentColor"></path>
</svg>
        2
      </div>
    </div>
  </div>
</section>

      
<section class="widget-toc widget-item layout-margin content-padding--primary soft-size--large soft-style--box">
  <div class="widget-title">
    <svg class="icon icon-toc" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M134.50666666 767.46666668H460.8c27.73333333 0 50.24000001 22.50666668 50.24000001 50.23999999v50.13333333c0 27.73333333-22.50666668 50.24000001-50.24000001 50.24000001H134.50666666c-27.73333333 0-50.24000001-22.50666668-50.23999999-50.24000001v-50.13333333c0.10666668-27.73333333 22.50666668-50.24000001 50.24000001-50.24000001zM84.37333332 541.65333333h326.18666669c27.73333333 0 50.24000001 22.39999999 50.23999999 50.13333334v50.24000001c0 27.73333333-22.50666668 50.24000001-50.24000002 50.23999999H84.37333332c-27.73333333 0-50.24000001-22.50666668-50.23999999-50.23999999v-50.24000001c0-27.73333333 22.50666668-50.13333334 50.24000001-50.13333334zM134.50666666 315.83999999H460.8c27.73333333 0 50.24000001 22.50666668 50.24000001 50.24000001v50.24000001c0 27.73333333-22.50666668 50.13333334-50.24000001 50.13333333H134.50666666c-27.73333333 0-50.24000001-22.39999999-50.23999999-50.13333333v-50.24000001c0.10666668-27.84000001 22.50666668-50.24000001 50.24000001-50.23999999zM209.81333332 89.91999999h326.18666671c27.73333333 0 50.24000001 22.39999999 50.23999997 50.13333335v50.23999999c0 27.73333333-22.50666668 50.24000001-50.24000001 50.24000001H209.81333332c-27.73333333 0-50.24000001-22.50666668-50.23999999-50.24000001v-50.24000001c0-27.73333333 22.50666668-50.13333334 50.24000001-50.13333333zM692.05333333 623.36l274.66666669 176.00000002c23.36000001 14.93333333 30.08 45.97333334 15.14666666 69.33333332L954.77333334 910.93333333c-14.93333333 23.25333334-45.97333334 30.08-69.33333335 15.14666667l-274.66666666-176c-23.36000001-14.93333333-30.08-45.97333334-15.14666667-69.33333333l27.09333334-42.24000001c14.93333333-23.36000001 46.08000001-30.08 69.33333333-15.14666666z" fill="currentColor"></path>
</svg>
    <span>TOC</span>
  </div>
  <div class="widget-body">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-React%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB"><span class="toc-number">1.</span> <span class="toc-text">å››.Reactæºç è§£è¯»</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E9%85%8D%E7%BD%AE-React-%E6%BA%90%E7%A0%81%E6%9C%AC%E5%9C%B0%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83"><span class="toc-number">2.</span> <span class="toc-text">1. é…ç½® React æºç æœ¬åœ°è°ƒè¯•ç¯å¢ƒ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%88%9B%E5%BB%BA-React-%E5%85%83%E7%B4%A0"><span class="toc-number">3.</span> <span class="toc-text">2. åˆ›å»º React å…ƒç´ </span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-createElement"><span class="toc-number">3.1.</span> <span class="toc-text">2.1 createElement</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-ReactElement"><span class="toc-number">3.2.</span> <span class="toc-text">2.2 ReactElement</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-hasValidRef"><span class="toc-number">3.3.</span> <span class="toc-text">2.3 hasValidRef</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-hasValidKey"><span class="toc-number">3.4.</span> <span class="toc-text">2.4 hasValidKey</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-isValidElement"><span class="toc-number">3.5.</span> <span class="toc-text">2.5 isValidElement</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-defineKeyPropWarningGetter"><span class="toc-number">3.6.</span> <span class="toc-text">2.6 defineKeyPropWarningGetter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-defineRefPropWarningGetter"><span class="toc-number">3.7.</span> <span class="toc-text">2.7 defineRefPropWarningGetter</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-React-%E6%9E%B6%E6%9E%84"><span class="toc-number">4.</span> <span class="toc-text">3. React æ¶æ„</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Scheduler-%E8%B0%83%E5%BA%A6%E5%B1%82"><span class="toc-number">4.1.</span> <span class="toc-text">3.1 Scheduler è°ƒåº¦å±‚</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-Reconciler-%E5%8D%8F%E8%B0%83%E5%B1%82"><span class="toc-number">4.2.</span> <span class="toc-text">3.2 Reconciler åè°ƒå±‚</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-Renderer-%E6%B8%B2%E6%9F%93%E5%B1%82"><span class="toc-number">4.3.</span> <span class="toc-text">3.3 Renderer æ¸²æŸ“å±‚</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">5.</span> <span class="toc-text">4. æ•°æ®ç»“æ„</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-Fiber"><span class="toc-number">5.1.</span> <span class="toc-text">4.1 Fiber</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-WorkTag"><span class="toc-number">5.2.</span> <span class="toc-text">4.2 WorkTag</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-TypeOfMode"><span class="toc-number">5.3.</span> <span class="toc-text">4.3 TypeOfMode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-SideEffectTag"><span class="toc-number">5.4.</span> <span class="toc-text">4.3 SideEffectTag</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-Update"><span class="toc-number">5.5.</span> <span class="toc-text">4.4 Update</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-UpdateQueue"><span class="toc-number">5.6.</span> <span class="toc-text">4.5 UpdateQueue</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-RootTag"><span class="toc-number">5.7.</span> <span class="toc-text">4.6 RootTag</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-7-%E5%8F%8C%E7%BC%93%E5%AD%98%E6%8A%80%E6%9C%AF"><span class="toc-number">5.8.</span> <span class="toc-text">4.7 åŒç¼“å­˜æŠ€æœ¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-8-%E5%8C%BA%E5%88%86-fiberRoot-%E4%B8%8E-rootFiber"><span class="toc-number">5.9.</span> <span class="toc-text">4.8 åŒºåˆ† fiberRoot ä¸ rootFiber</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B8%B2%E6%9F%93"><span class="toc-number">6.</span> <span class="toc-text">5. åˆå§‹åŒ–æ¸²æŸ“</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-render-%E9%98%B6%E6%AE%B5"><span class="toc-number">6.1.</span> <span class="toc-text">5.1 render é˜¶æ®µ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-commit-%E9%98%B6%E6%AE%B5"><span class="toc-number">6.2.</span> <span class="toc-text">5.2 commit é˜¶æ®µ</span></a></li></ol></li></ol>
  </div>
</section>


      
<section class="widet-notice widget-item layout-margin content-padding--primary soft-size--large soft-style--box">
  <div class="widget-title">
    <svg class="icon icon-notice" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M512 945.02305225v28.15620663a24.27259221 24.27259221 0 0 1-24.27259221 24.27259335H394.0352a48.54518557 48.54518557 0 0 1-41.74885888-23.78714112l-110.68302222-184.47170332a132.04290333 132.04290333 0 0 1-17.47626667-48.54518557h118.4502511a200.97706667 200.97706667 0 0 1 76.21594113 14.56355556l20.38897777 133.49925888a48.54518557 48.54518557 0 0 0 36.40888888 27.67075555l16.01991111 2.91271112a24.27259221 24.27259221 0 0 1 20.38897778 25.72894889zM997.45185223 463.45481443a194.18074112 194.18074112 0 0 1-38.8361489 116.50844445 24.75804445 24.75804445 0 0 1-36.4088889 0l-34.95253333-34.95253333a24.27259221 24.27259221 0 0 1-2.91271111-30.58346667 97.09036999 97.09036999 0 0 0 0-106.79940665 24.27259221 24.27259221 0 0 1 2.91271111-30.58346666l34.95253333-34.95253334a24.75804445 24.75804445 0 0 1 18.93262223-7.28177777 26.2144 26.2144 0 0 1 17.47626667 9.70903665A194.18074112 194.18074112 0 0 1 997.45185223 463.45481443z m-194.18074112-388.36148111v776.72296335a48.54518557 48.54518557 0 0 1-48.54518556 48.54518443h-28.64165888a48.54518557 48.54518557 0 0 1-33.98163001-14.07810332l-145.63555556-143.20829668A291.27111111 291.27111111 0 0 0 342.57730333 657.63555556H172.18370333a145.63555556 145.63555556 0 0 1-145.63555556-145.63555556v-97.09036999a145.63555556 145.63555556 0 0 1 145.63555556-145.63555556h170.3936a291.27111111 291.27111111 0 0 0 206.31703779-85.43952668l145.63555555-143.20829554a48.54518557 48.54518557 0 0 1 33.98162888-14.07810446H754.72592555a48.54518557 48.54518557 0 0 1 48.54518556 48.54518555z" fill="currentColor"></path>
</svg>
    <span>NOTICE</span>
  </div>
  <div class="widget-body">
    <p>æŒç»­æ›´æ–°ä¸­ã€‚ã€‚ã€‚</p>
  </div>
</section>


      <section class="widget-categorys widget-item layout-margin content-padding--primary soft-size--large soft-style--box">
  <div class="widget-title">
    <svg class="icon icon-categories" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M900.3614811 257.09082106h-339.81629553l-67.96326003-101.9448889c-19.41807444-29.12711113-48.54518557-43.69066667-82.52681443-43.69066667H123.6385189c-53.39970333 0-97.09036999 43.69066667-97.09037113 97.09036999v582.54222222c0 53.39970333 43.69066667 97.09036999 97.09037113 97.09037002h776.7229622c53.39970333 0 97.09036999-43.69066667 97.09037113-97.09037002V354.18119104c0-53.39970333-43.69066667-97.09036999-97.09037113-97.09036998z m-97.09036999 242.72592554H220.72888889c-24.27259221 0-48.54518557-24.27259221-48.54518556-48.54518556s24.27259221-48.54518557 48.54518556-48.54518444h582.54222222c24.27259221 0 48.54518557 24.27259221 48.54518556 48.54518444s-24.27259221 48.54518557-48.54518556 48.54518556z" fill="currentColor"></path>
</svg>
    <span>CATEGORYS</span>
  </div>
  <div class="widget-body">
    <ul class="categorys-list">
      
        <li class="categorys-list-item">
          <a href="/GYB_blog/categories/web%E5%89%8D%E7%AB%AF/">
            webå‰ç«¯ (5)
          </a>
        </li>
      
        <li class="categorys-list-item">
          <a href="/GYB_blog/categories/web%E5%89%8D%E7%AB%AF/react/">
            react (5)
          </a>
        </li>
      
    </ul>
  </div>
</section>

      <section class="widget-tags widget-item  layout-margin content-padding--primary soft-size--large soft-style--box">
  <div class="widget-title">
    <svg class="icon icon-tags" viewBox="0 0 1098 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M283.42180005 272q0-28.38857157-20.09142843-48.48000001t-48.47999998-20.09142842-48.48000002 20.09142842-20.09142846 48.48000001 20.09142846 48.48 48.48000002 20.09142843 48.47999998-20.09142843 20.09142843-48.48zM855.0332285 580.57142843q0 28.38857157-19.81714313 48.2057147l-263.03999997 263.58857157q-20.9142853 19.81714313-48.75428534 19.81714312-28.38857157 0-48.20571468-19.81714312l-383.04-383.58857157q-20.36571468-19.81714313-34.55999999-54.10285688t-14.19428534-62.6742853l0-222.85714313q0-27.84000002 20.36571469-48.20571469t48.2057147-20.36571466l222.85714313 0q28.38857157 0 62.6742853 14.19428529t54.65142842 34.55999999l383.04000001 382.49142843q19.81714313 20.9142853 19.81714314 48.75428532zM1060.74751475 580.57142843q0 28.38857157-19.81714313 48.2057147l-263.04 263.58857157q-20.9142853 19.81714313-48.75428531 19.81714312-19.26857155 0-31.61142843-7.47428531t-28.38857159-24.13714314l251.79428534-251.7942853q19.81714313-19.81714313 19.81714308-48.20571469 0-27.84000002-19.81714308-48.75428531l-383.04000001-382.49142845q-20.36571468-20.36571468-54.65142842-34.55999999t-62.67428532-14.19428534l120 0q28.38857157 0 62.67428532 14.19428534t54.65142842 34.55999999l383.03999998 382.49142845q19.81714313 20.9142853 19.81714314 48.75428531z" fill="currentColor"></path>
</svg>
    <span>TAGS</span>
  </div>
  <div class="widget-body">
    <div class="tags-cloud">
      <a href="/GYB_blog/tags/react/" style="font-size: 10px;" class="tags-cloud-0">react</a> <a href="/GYB_blog/tags/web%E5%89%8D%E7%AB%AF/" style="font-size: 10px;" class="tags-cloud-0">webå‰ç«¯</a>
    </div>
  </div>
</section>
    </div>
  </article>
</div>

    <!-- footer container -->
<footer id="footer" class="footer">
  <div class="footer-container">
    
    <div class="social-icons">
      
        
      
        
      
        
      
        
          <a href="https://github.com/gaoyubo01" class="soft-size--primary soft-style--box" target="_blank" rel="noopener noreferrer">
            <svg class="icon icon-github" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M64.6 512c0 195.6 125.4 361.9 300.1 422.9 23.5 5.9 19.9-10.8 19.9-22.2v-77.6c-135.8 15.9-141.3-74-150.5-89-18.5-31.5-61.9-39.5-49-54.5 31-15.9 62.5 4 98.9 58 26.4 39.1 77.9 32.5 104.1 26 5.7-23.5 17.9-44.5 34.7-60.9-140.7-25.2-199.4-111.1-199.4-213.3 0-49.5 16.4-95.1 48.4-131.8-20.4-60.6 1.9-112.4 4.9-120.1 58.2-5.2 118.5 41.6 123.3 45.3 33.1-8.9 70.8-13.7 112.9-13.7 42.4 0 80.3 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.4-43.9 2.9 7.7 24.7 58.3 5.5 118.1 32.5 36.8 49 82.8 49 132.4 0 102.3-59 188.3-200.2 213.2 23.5 23.3 38.1 55.5 38.1 91.1v112.7c0.8 9 0 17.9 15.1 17.9C832.7 877 960.4 709.4 960.4 512.1c0-247.5-200.6-447.9-447.9-447.9C265 64.1 64.6 264.5 64.6 512z"></path>
</svg>
          </a>
        
      
        
      
    </div>
     
    <p>&copy; 2022 <a href="/" target="_blank">John Doe</a></p>

    

    <!-- <p>Powered by <a href="https://hexo.io" target="_blank" rel="noopener noreferrer">Hexo</a> Theme - <a href="https://github.com/miiiku/flex-block" target="_blank" rel="noopener noreferrer author">flex-block</a></p> -->

    <p>
      <a href="javascript:;" id="theme-light">ğŸŒ æµ…è‰²</a>
      <a href="javascript:;" id="theme-dark">ğŸŒ› æ·±è‰²</a>
      <a href="javascript:;" id="theme-auto">ğŸ¤–ï¸ è‡ªåŠ¨</a>
    </p>
    <span id="busuanzi_container_site_uv"><br>
      æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡
    </span>
  </div>
</footer>
  </div>

  <div class="back-to-top-fixed soft-size--round soft-style--box">
    <svg class="icon icon-back-to-top" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
      <path d="M725.333333 426.666667c-12.8 0-21.333333-4.266667-29.866667-12.8l-213.333333-213.333333c-17.066667-17.066667-17.066667-42.666667 0-59.733333s42.666667-17.066667 59.733333 0l213.333333 213.333333c17.066667 17.066667 17.066667 42.666667 0 59.733333C746.666667 422.4 738.133333 426.666667 725.333333 426.666667z"></path>
      <path d="M298.666667 426.666667c-12.8 0-21.333333-4.266667-29.866667-12.8-17.066667-17.066667-17.066667-42.666667 0-59.733333l213.333333-213.333333c17.066667-17.066667 42.666667-17.066667 59.733333 0s17.066667 42.666667 0 59.733333l-213.333333 213.333333C320 422.4 311.466667 426.666667 298.666667 426.666667z"></path>
      <path d="M512 896c-25.6 0-42.666667-17.066667-42.666667-42.666667L469.333333 170.666667c0-25.6 17.066667-42.666667 42.666667-42.666667s42.666667 17.066667 42.666667 42.666667l0 682.666667C554.666667 878.933333 537.6 896 512 896z"></path>
    </svg>
  </div>

  
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!-- aplayer -->


  <!-- aplayer éŸ³é¢‘ start -->
  <link rel="stylesheet" href="https://unpkg.com/aplayer@1.10.1/dist/APlayer.min.css">
  <script type="text/javascript" src="https://unpkg.com/aplayer@1.10.1/dist/APlayer.min.js"></script>
  <script type="text/javascript">
    const aplayer = document.querySelectorAll(".aplayer-box");
    aplayer && initaplayer(aplayer);
    function initaplayer(els) {
      let elsArr = Array.from(els);
      elsArr.forEach(el => {
        let params = {
          container: el,
          audio: { ...el.dataset },
          theme: "#b7daff",
          autoplay: false,
          loop: false,
          mutex: true,
        }
        if (el.dataset.lrc) {
          params['lrcType'] = 3
        }
        new APlayer(params);
      });
    }
  </script>
  <!-- aplayer éŸ³é¢‘ end -->
  


<!-- dplayer -->




  


  


  




<script src="/GYB_blog/js/script.js"></script>


  
  <!-- å°¾éƒ¨ç”¨æˆ·è‡ªå®šä¹‰ç›¸å…³å†…å®¹ -->
</body>
</html>
